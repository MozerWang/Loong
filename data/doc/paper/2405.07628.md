# Substitutability, equilibrium transport, and matching models 

Alfred Galichon, Antoine Jacquet

April 2024

## 1 Introduction

This chapter is about substitutability. Substitutability is a fundamental property of optimal transport models, although it is less recognized than convexity.

Consider the problem of computing an economic equilibrium

$$
\begin{equation*}
Q(p)=0 \tag{1}
\end{equation*}
$$

where $p$ is a vector of prices for $n$ goods, and $Q: \mathbb{R}^{n} \rightarrow \mathbb{R}^{n}$ is an excess supply function (supply minus demand for each of the $n$ goods).

Broadly speaking, there are only two categories of economic models that can be conveniently computed. The first category includes the models that rely on convexity, i.e. models where $Q=\nabla U(p)$ with $U$ a convex function. These models can be reformulated as an optimization problem (minimization of $U$ ) and descent methods, such as the standard gradient descent, will work:

$$
\begin{equation*}
p_{z}^{t+1}=p_{z}^{t}-\varepsilon Q_{z}\left(p^{t}\right), \quad \varepsilon>0 \text { small. } \tag{2}
\end{equation*}
$$

The second category comprises the models that rely on substitutability essentially the idea that $Q_{z}$ is increasing in $p_{z}$ and decreasing in $p_{x}$ for $x \neq z$. In this case, coordinate update methods, such as nonlinear Jacobi, where we set the price of good $z$ to clear the market for good $z$, will work:

$$
\begin{equation*}
Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t}\right)=0 \tag{3}
\end{equation*}
$$

By an extraordinary coincidence, optimal transport inherits both structures. For this reason, one can compute the OT problem and its regularizations both by descent methods and by coordinate update methods (which is called Sinkhorn's algorithm).

Some matching models can be computed using optimal transport. These are called transferable utility models, and they assume that everyone's valuations are expressed in the same monetary unit. In that case, equilibrium in
matching problems is the solution to an optimization problem. However, in many other cases this assumption cannot be made. In labor economics, for instance, one dollar for the firm does not have the same value as one dollar for the employee (pre-tax or post-tax; decreasing marginal utility, etc). Similarly, in family economics partners may transfer utility by allocating public and private expenditures that can be inefficient. Lastly, in school choice problems utility is cardinal and cannot be transferred.

We will see mathematically that these models cannot be recast as optimization problems, and so the convex optimization structure is lost. They can, however, be reformulated as models with substitutability, from which we will be able to deduce a lot of structure and computational methods.

The chapter is organized as follows. We will start in section 2 by introducing Jacobi's algorithm and some of its basic properties. We will proceed with a rather detailed study of substitutability and its mathematical counterparts, $Z$ - and M-functions. There was a vibrant literature on this topic in the 1970s (Birkhoff, Rheinboldt, Ortega, More, Porsching, and some others; see in particular Ortega and Rheinboldt's 1970 book), but this literature has somehow fallen out of attention. We will unearth some of the main results from that literature regarding the convergence of Jacobi's algorithm, and provide some new ones. The section ends with a toy hedonic model as an illustration.

In section 3, we will appeal to the machinery developed in section 2 to study models of matching with transfers, departing from the assumption of perfectly transferable utility. The section will deal with the regularized and unregularized cases, and it will show the convergence of IPFP, and discuss the existence and uniqueness of an equilibrium.

In section 4 we will revisit Gale and Shapley's famous theory of "stable marriages," which is the theory of matchings without transfers, and we will reinterpret the well-known deferred acceptance algorithm as a damped version of Jacobi's algorithm. We also present Adachi's formulation of the stable matching problem, which leads to the notion of more recent notion of equilibrium matchings.

We hope this chapter will provide a solid mathematical introduction to matching models in economics and econometrics.

## 2 M-functions and Jacobi's algorithm

In this section we introduce the mathematical notions related to models with substitutability, notably Z- and M-functions, as well as Jacobi's algorithm for solving such models.

### 2.1 Jacobi's algorithm

Put simply, our goal is to solve a system of nonlinear equations

$$
\begin{equation*}
Q(p)=0 \tag{4}
\end{equation*}
$$

where $Q: \mathbb{R}^{Z} \rightarrow \mathbb{R}^{Z}$ and $|Z|=n$. We shall assume throughout:

Assumption 2.1 (Continuity). $Q$ is continuous.

In economic terms, $Q$ can be interpreted as an excess supply function. Suppose the demand for good $z$ is a function $D_{z}(p)$ which depends on all prices, and similarly the supply for good $z$ is a function $S_{z}(p)$. Then

$$
\begin{equation*}
Q_{z}(p)=S_{z}(p)-D_{z}(p) \tag{5}
\end{equation*}
$$

is the excess supply for good $z$. Solving $Q_{z}(p)=0$ for all $z$ is thus akin to finding a vector of prices $p$ which clears the markets for all $n$ goods simultaneously.

Jacobi's algorithm is a method to solve such a system. It consists of taking an initial guess $p^{0}$ and defining a sequence $\left(p^{t}\right)$ iteratively according to

$$
\begin{equation*}
p_{z}^{t+1}: \quad Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t}\right)=0 \tag{6}
\end{equation*}
$$

Here $p_{-z}$ denotes the vector $p$ without its $z^{\text {th }}$ entry, and $\left(\pi, p_{-z}\right)$ the vector $p$ with its $z^{\text {th }}$ entry replaced by $\pi$. The mapping $T: p^{t} \mapsto p^{t+1}$ is called the coordinate update or Jacobi update operator. To ensure that this operator is well-defined, we shall assume throughout:

Assumption 2.2 (Responsiveness). For all $z$,

$$
\begin{equation*}
\inf _{\pi} Q_{z}\left(\pi, p_{-z}\right)<0<\sup _{\pi} Q_{z}\left(\pi, p_{-z}\right), \quad \forall p_{-z} \tag{7}
\end{equation*}
$$

We also remove any ambiguity in choosing $p_{z}^{t+1}$ by setting precisely

$$
\begin{equation*}
p_{z}^{t+1}=\min \left\{\pi: Q_{z}\left(\pi, p_{-z}^{t}\right)=0\right\} \tag{8}
\end{equation*}
$$

Jacobi's algorithm has an intuitive economic interpretation. Let's assume that each good $z$ has an auctioneer in charge of determining its "right" price $p_{z}$. At each period, the auctioneer for good $z$ sets $p_{z}$ in order to clear the corresponding market, but using the prices from the previous period (it is as if each auctioneer did not anticipate that other prices were being updated simultaneously). Because of this, once the simultaneous price updates are taken
into account, the price chosen by the auctioneer is in fact typically not market clearing. This process is then re-iterated until the prices converge.

As an illustration, consider the regularized optimal transport problem

$$
\begin{aligned}
\max _{\mu \geq 0} & \sum_{x y \in X \times Y} \mu_{x y} \Phi_{x y}-\sum_{x y \in X \times Y} \mu_{x y} \log \mu_{x y} \\
\text { s.t. } & \sum_{y \in Y} \mu_{x y}=n_{x}, \quad \sum_{x \in X} \mu_{x y}=m_{y}
\end{aligned}
$$

which has solutions of the form: $\mu_{x y}=\exp \left(\Phi_{x y}-u_{x}-v_{y}\right)$. A common interpretation is that of a two-sided matching market between workers $x$ and firms $y$ who respectively ask for utility $u_{x}$ and $v_{y}$. We will come back to this problem and its interpretation in section 3.

A standard procedure to solve this type of problem is Sinkhorn's algorithm, which is nothing else than Jacobi's algorithm adapted to this special case.

## Sinkhorn's algorithm

Take an initial guess for $u^{0}$ and $v^{0}$, and set for $t \geq 0$ :

$$
\left\{\begin{aligned}
u_{x}^{t+1}: & n_{x}=\sum_{y} \exp \left(\Phi_{x y}-u_{x}^{t+1}-v_{y}^{t}\right) \\
v_{y}^{t+1}: & m_{y}=\sum_{x} \exp \left(\Phi_{x y}-u_{x}^{t}-v_{y}^{t+1}\right)
\end{aligned}\right.
$$

until approximate convergence is reached. (Notice that here, $u^{2 t}$ and $v^{2 t+1}$ depend exclusively on the starting point $u^{0}$, while $u^{2 t+1}$ and $v^{2 t}$ depend exclusively on the starting point $v^{0}$.)

It is easy to see that by defining $p_{x}=-u_{x}, p_{y}=v_{y}$, as well as

$$
\begin{aligned}
& Q_{x}(p)=\sum_{y} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)-n_{x} \\
& Q_{y}(p)=-\sum_{x} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)+m_{y}
\end{aligned}
$$

we can rewrite Sinkhorn's algorithm exactly as (6).

Note that $Q_{x}$ is an antitone function with respect to $p_{-x}$ (i.e. nonincreasing with respect to the componentwise order), and similarly $Q_{y}$ is an antitone function with respect to $p_{-y}$. We will see below how this property plays an important role in Jacobi's algorithm.

One important question remains: does the Jacobi sequence $\left(p^{t}\right)$ converge? Although this is not the case in general, this sequence does converge when the model exhibits several features related to substitutability. The rest of this section will be dedicated to defining exactly what we mean by substitutability, and to studying this category of models - and notably the behavior of the Jacobi sequence.

### 2.2 Nondecreasing Jacobi sequence

The convergence of the Jacobi sequence will rely on the notion of subsolution, that we define as follows:

Definition 2.1. We say that $p$ is a subsolution if $Q(p) \leq 0$, and that $p$ is a supersolution if $Q(p) \geq 0$.

Broadly speaking, we expect to interpret a subsolution as "prices are too low," and a supersolution as "prices are too high." We shall develop this intuition below.

Let $p^{t}$ be a subsolution and assume $p^{t+1}$ exists, so that

$$
\begin{equation*}
Q_{z}\left(p_{z}^{t}, p_{-z}^{t}\right) \leq 0, \quad Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t}\right)=0 \tag{9}
\end{equation*}
$$

Then we can guarantee that $p^{t} \leq p^{t+1}$ using:

Assumption 2.3 (Diagonal isotonicity). $Q_{z}(p)$ is nondecreasing in $p_{z}$.

We state this result formally:

Proposition 2.1. Assume $Q$ is diagonal isotone. If $p^{t}$ is a subsolution, then $p^{t} \leq p^{t+1}$.

Proof. $Q_{z}\left(p_{z}^{t}, p_{-z}^{t}\right) \leq 0=Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t}\right)$ and $Q_{z}$ is increasing in $p_{z}$.

Next, we can guarantee that $p^{t+1}$ is still a subsolution with:

Assumption 2.4 (Z-function). $Q_{z}\left(p_{z}, p_{-z}\right)$ is antitone with respect to $p_{-z}$, i.e. $p_{-z} \leq p_{-z}^{\prime}$ implies $Q_{z}\left(p_{z}, p_{-z}\right) \geq Q_{z}\left(p_{z}, p_{-z}^{\prime}\right)$.

In economic terms, $Q$ being a Z-function means that when the price of any other good increases, the excess supply for good $z$ should decrease. This can be explained by a standard substitution pattern: if all prices but $p_{z}$ increase, then producers should supply less good $z$, while consumers should demand more good $z$. For this reason, we also say that $Q$ has the substitutes property.

With the Z-function assumption we have:

Proposition 2.2. Assume $Q$ is a diagonal isotone $Z$-function. If $p^{t}$ is a subsolution, then $p^{t+1}$ is also a subsolution.

Proof. We have $p^{t} \leq p^{t+1}$ by diagonal isotonicity, so in particular $p_{-z}^{t} \leq p_{-z}^{t+1}$ for any $z$. Hence, since $Q_{z}$ is antitone with respect to $p_{-z}, Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t+1}\right) \leq$ $Q_{z}\left(p_{z}^{t+1}, p_{-z}^{t}\right)=0$.

The immediate consequence of propositions 2.1 and 2.2 is that, with $Q$ satisfying the assumptions above, any Jacobi sequence starting from a subsolution will be nondecreasing. Yet, as the following example shows, this is still not sufficient to ensure convergence.

Example 2.1. Consider a linear $Q(p)$ given by

$$
Q(p)=\left(\begin{array}{cc}
1 & -2 \\
-2 & 1
\end{array}\right) p
$$

The Jacobi sequence starting from $p^{0}$ can be written explicitly as

$$
\left\{\begin{array}{l}
p_{1}^{t}=2^{t} p_{2}^{0} \\
p_{2}^{t}=2^{t} p_{1}^{0}
\end{array}\right.
$$

Even though $p^{0}=(1,1)$ is a subsolution, and $Q$ is a continuous diagonal isotone Z-function, the associated Jacobi sequence does not converge to the unique solution $(0,0)$. In fact, it is clear from the expressions of $p_{1}^{t}$ and $p_{2}^{t}$ that any Jacobi sequence starting from a vector other than $(0,0)$ will diverge.

### 2.3 M- and $\mathrm{M}_{0}$-functions

Example 2.1 shows what went wrong: the function $Q$ allowed for an inversion by allowing the subsolution $(1,1)$ to be above the solution $(0,0)$. Recall that we expect subsolution to mean "prices are too low" and supersolution "prices are too high," and therefore we wish to rule out such inversions. We do so using the following notions, defined in Galichon, Samuelson and Vernet (2022):

Definition 2.2. Consider $Q: \mathbb{R}^{n} \rightarrow \mathbb{R}^{n}$. We say that:

(i) $Q$ is strongly nonreversing if

$$
\left\{\begin{array}{l}
p \geq p^{\prime}  \tag{10}\\
Q(p) \leq Q\left(p^{\prime}\right)
\end{array} \quad \text { implies } p=p^{\prime}\right.
$$

(ii) $Q$ is weakly nonreversing if

$$
\left\{\begin{array}{l}
p \geq p^{\prime}  \tag{11}\\
Q(p) \leq Q\left(p^{\prime}\right) \quad \text { implies } Q(p)=Q\left(p^{\prime}\right)
\end{array}\right.
$$

Economically speaking, $Q$ being nonreversing means that when prices increase, the excess supply cannot decrease for all goods. In other words, it ensures that the price effect remains stronger than the substitution effect.

Example 2.2. Consider $Q(p)=Q p$ with $Q$ an $n \times n$ matrix. If $Q$ is weakly (column) diagonally dominant (i.e. $1^{\top} Q \geq 0$ ), then $Q$ is weakly nonreversing. If it is strictly (column) diagonally dominant (i.e. if $1^{\top} Q>0$ ), then $Q$ is strongly nonreversing.

Example 2.3. Consider $Q$ such that $1^{\top} Q(p)$ is weakly isotone in $p$. Then it is weakly nonreversing. In particular, this is the case of $Q: \mathbb{R}^{X \cup Y} \rightarrow \mathbb{R}^{X \cup Y}$ given by

$$
\left\{\begin{array}{l}
Q_{x}(p)=\sum_{y} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)-n_{x}, \quad x \in X  \tag{12}\\
Q_{y}(p)=-\sum_{x} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)+m_{y}, \quad y \in Y
\end{array}\right.
$$

Example 2.4. Consider $Q$ such that $1^{\top} Q(p) \leq 1^{\top} Q\left(p^{\prime}\right)$ and $p \geq p^{\prime}$ together imply $p=p^{\prime}$. Then it is strongly nonreversing. In particular, this is the case of $Q: \mathbb{R}^{X \cup Y} \rightarrow \mathbb{R}^{X \cup Y}$ given by

$$
\left\{\begin{array}{l}
Q_{x}(p)=\sum_{y} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)+\exp \left(p_{x}\right)-n_{x}, \quad x \in X \\
Q_{y}(p)=-\sum_{x} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)-\exp \left(-p_{y}\right)+m_{y}, \quad y \in Y
\end{array}\right.
$$

Next we define M- and $\mathrm{M}_{0}$-functions as Z-functions which are also nonreversing:

Definition 2.3. An M-function is a Z-function which is strongly nonreversing. An $M_{0}$-function is a $Z$-function which is weakly nonreversing.

Clearly, M-functions constitute a subset of $\mathrm{M}_{0}$-functions since strong nonreversingness implies weak nonreversingness. In economic terms, M- and $\mathrm{M}_{0}$ functions exhibit both the substitutes property (which they inherit from Zfunctions), and the property of having a price effect stronger than the substitution effect.

The combination of these two properties implies that $\mathrm{M}_{0}$-functions (and therefore M-functions also) are diagonal isotone, so that M- and $\mathrm{M}_{0}$-functions satisfy assumptions 2.3 and 2.4 .

Proposition 2.3. Assume $Q$ is an $M_{0}$-function, then it is diagonal isotone.

Proof. Let $p$ and $p^{\prime}$ such that $p_{z} \leq p_{z}^{\prime}$ and $p_{-z}=p_{-z}^{\prime}$. Looking for a contradiction, suppose that $Q_{z}(p)>Q_{z}\left(p^{\prime}\right)$.

For any $\tilde{z} \neq z$ we have $p_{\tilde{z}}=p_{\tilde{z}}^{\prime}$ and $p_{-\tilde{z}} \leq p_{-\tilde{z}}^{\prime}$, so since $Q$ is a Z-function,

$$
Q_{\tilde{z}}(p)=Q_{\tilde{z}}\left(p_{\tilde{z}}, p_{-\tilde{z}}\right) \geq Q_{\tilde{z}}\left(p_{\tilde{z}}, p_{-\tilde{z}}^{\prime}\right)=Q_{\tilde{z}}\left(p^{\prime}\right)
$$

Hence $p \leq p^{\prime}$ and $Q(p) \geq Q\left(p^{\prime}\right)$, therefore $Q(p)=Q\left(p^{\prime}\right)$ by weak nonreversingness. We have a contradiction: in fact $Q_{z}(p) \leq Q_{z}\left(p^{\prime}\right)$.

## Galichon, Samuelson and Vernet (2022) characterize M-functions using:

Theorem 2.1 (Inverse isotonicity theorems). Consider $Q$ a Z-function. Then:

(i) $Q$ is an $M$-function if and only if it is inverse isotone, i.e.

$$
Q(p) \leq Q\left(p^{\prime}\right) \text { implies } p \leq p^{\prime}
$$

(ii) $Q$ is an $M_{0}$-function if and only if the set-valued map $Q^{-1}$ is isotone in the strong set order, i.e.

$$
Q(p) \leq Q\left(p^{\prime}\right) \text { implies }\left\{\begin{array}{l}
Q(p)=Q\left(p \wedge p^{\prime}\right) \\
Q\left(p^{\prime}\right)=Q\left(p \vee p^{\prime}\right)
\end{array}\right.
$$

We recall that $p \wedge p^{\prime}$ denotes the join (componentwise minimum) of two vectors $p$ and $p^{\prime}$, while $p \vee p^{\prime}$ denotes their meet (componentwise maximum).

Proof. (i) Assume $Q$ is an M-function and $Q(p) \leq Q\left(p^{\prime}\right)$. Then $p \vee p^{\prime} \geq p^{\prime}$ and

$$
Q_{z}\left(p \vee p^{\prime}\right) \leq 1\left\{p_{z} \leq p_{z}^{\prime}\right\} Q_{z}\left(p^{\prime}\right)+1\left\{p_{z}>p_{z}^{\prime}\right\} Q_{z}(p) \leq Q_{z}\left(p^{\prime}\right)
$$

therefore we conclude that $p^{\prime}=p \vee p^{\prime}$, and thus $p \leq p^{\prime}$. Conversely, assume $Q$ is inverse isotone. To show it is strongly nonreversing, assume $p \geq p^{\prime}$ and $Q(p) \leq Q\left(p^{\prime}\right)$. By inverse isotonicity $p \leq p^{\prime}$, hence $p=p^{\prime}$.

(ii) Assume $Q$ is an $\mathrm{M}_{0}$-function and $Q(p) \leq Q\left(p^{\prime}\right)$. Then $p \vee p^{\prime} \geq p^{\prime}$ and

$$
Q_{z}\left(p \vee p^{\prime}\right) \leq 1\left\{p_{z} \leq p_{z}^{\prime}\right\} Q_{z}\left(p^{\prime}\right)+1\left\{p_{z}>p_{z}^{\prime}\right\} Q_{z}(p) \leq Q_{z}\left(p^{\prime}\right)
$$

therefore we conclude that $Q\left(p \vee p^{\prime}\right)=Q\left(p^{\prime}\right)$. Similarly, $p \geq p \wedge p^{\prime}$ and

$$
Q_{z}\left(p \wedge p^{\prime}\right) \geq 1\left\{p_{z} \leq p_{z}^{\prime}\right\} Q_{z}(p)+1\left\{p_{z}>p_{z}^{\prime}\right\} Q_{z}\left(p^{\prime}\right) \geq Q_{z}(p)
$$

thus $Q\left(p \wedge p^{\prime}\right)=Q(p)$. Conversely, assume $Q^{-1}$ is isotone in the strong set order. To show that $Q$ is weakly nonreversing, assume $p \geq p^{\prime}$ and $Q(p) \leq Q\left(p^{\prime}\right)$. The former implies $p \wedge p^{\prime}=p^{\prime}$, and the latter $Q(p)=Q\left(p \wedge p^{\prime}\right)$.

Corollary. Assume $Q$ is an $M_{0}$-function, then the set of solutions is stable by the join and meet operations $\wedge$ and $\vee$.

### 2.4 Convergence of the Jacobi sequence

When $Q$ is an $\mathrm{M}$ - or $\mathrm{M}_{0}$-function, inversions such as the one we saw in example 2.1 are ruled out. In this case, as long as a sub- and a supersolution exist, we can find a Jacobi sequence which converges towards a solution.

Ortega and Rheinboldt (1970) prove the two following results for M-functions.

Theorem 2.2. Assume $Q$ is a continuous responsive $M$-function, and that both a sub- and a supersolution exist. Then a solution exists and it is unique, and any Jacobi sequence starting from a sub- or supersolution converges to this unique solution.

Proof. The proof consists in considering two Jacobi sequences $\left(\hat{p}^{t}\right)$ and $\left(\check{p}^{t}\right)$ starting from respectively a sub- and a supersolution. ( $\left.\hat{p}^{t}\right)$ is an increasing sequence of subsolutions, $\left(\check{p}^{t}\right)$ is a decreasing sequence of supersolutions, and by inverse isotonicity, one has $\hat{p}^{t} \leq \check{p}^{t}$, and therefore they both converge to respectively $p$ and $p^{\prime} . Q(p)=Q\left(p^{\prime}\right)=0$ and inverse isotonicity applied twice yields $p=p^{\prime}$.

If $Q$ is surjective, then we need not even start from a sub- or supersolution.

Theorem 2.3. Assume $Q$ is also surjective. Then any Jacobi sequence converges to the unique solution.

Proof. Let $\left(p^{t}\right)$ be the Jacobi sequence starting from a vector $p^{0}$. Since $Q$ is surjective, there exist $\hat{p}^{0}$ such that $Q\left(\hat{p}^{0}\right)=Q\left(p^{0}\right) \wedge 0$, and $\check{p}^{0}$ such that $Q\left(\check{p}^{0}\right)=Q\left(p^{0}\right) \vee 0$. Then $\hat{p}^{0}$ is a subsolution, $\check{p}^{0}$ is a supersolution, and the Jacobi sequences $\left(\hat{p}^{t}\right)$ and $\left(\check{p}^{t}\right)$ starting from these respective vectors are such that

$$
\hat{p}^{t} \leq p^{t} \leq \check{p}^{t}
$$

with $\left(\hat{p}^{t}\right)$ increasing and $\left(\check{p}^{t}\right)$ decreasing. As a result, all three sequences converge, and their limits are solutions.

Finally, Galichon and Léger (2023) obtain the following result for $\mathrm{M}_{0}$-functions.

Theorem 2.4. Assume $Q$ is an $M_{0}$-function, and that both a sub- and a supersolution exist. Then a solution exists and can be obtained as the limit of the Jacobi sequence starting from the meet (or the join) of a subsolution and a supersolution.

Proof. Let $\check{p}$ be a subsolution and $\hat{p}$ a supersolution. Then $Q(\check{p}) \leq Q(\hat{p})$, therefore the inverse isotonicity characterization of $\mathrm{M}_{0}$-functions implies $Q(\check{p} \wedge \hat{p})=$ $Q(\check{p})$ and $Q(\check{p} \vee \hat{p})=Q(\hat{p})$. Hence $\check{p} \wedge \hat{p}$ is a subsolution and $\check{p} \vee \hat{p}$ is a supersolution. Consider $\left(\underline{p}^{t}\right)$ and $\left(\bar{p}^{t}\right)$ the Jacobi sequences starting respectively from $\underline{p}^{0}=\check{p} \wedge \hat{p}$ and $\bar{p}^{0}=\check{p} \vee \hat{p}$, so that $\underline{p}^{0} \leq \bar{p}^{0}$. We show by induction that $\underline{p}^{t} \leq \bar{p}^{t}$. Looking for a contradiction, assume that $\underline{p}_{z}^{t+1}>\bar{p}_{z}^{t+1}$ for some $z$. Then

$$
0=Q_{z}\left(\underline{p}_{z}^{t+1}, \underline{p}_{-z}^{t}\right) \geq Q_{z}\left(\bar{p}_{z}^{t+1}, \underline{p}_{-z}^{t}\right) \geq Q_{z}\left(\bar{p}_{z}^{t+1}, \bar{p}_{-z}^{t}\right)=0
$$

by diagonal isotonicity and the Z-function property. Hence $Q_{z}\left(\underline{p}_{z}^{t+1}, \underline{p}_{-z}^{t}\right)=$ $Q_{z}\left(\bar{p}_{z}^{t+1}, \underline{p}_{-z}^{t}\right)=0$ but $\underline{p}_{z}^{t+1}>\bar{p}_{z}^{t+1}$, which contradicts the definition (8) of $\underline{p}_{z}^{t+1}$ as the smallest solution to $Q_{z}\left(\pi, \underline{p}_{-z}^{t}\right)=0$. Thus $\left(\underline{p}^{t}\right)$ is increasing, $\left(\bar{p}^{\bar{t}}\right)$ is decreasing, and $\underline{p}^{t} \leq \bar{p}^{t}$, therefore both sequences are bounded and have a limit. Hence a solution exists.

We now consider some examples around constant aggregates, i.e. the property that $1^{\top} Q(p)=\sum_{z} Q_{z}(p)$ is constant for all $p$.

Proposition 2.4. Assume $Q$ is a continuous $Z$-function with $1^{\top} Q(p)=0$, and that there is a $0 \in Z$ such that the restriction and corestriction of $Q$ to $\mathbb{R}^{Z \backslash\{0\}}$ with the normalization $p_{0}=\pi$, denoted $Q_{-0}: \mathbb{R}^{Z \backslash\{0\}} \rightarrow \mathbb{R}^{Z \backslash\{0\}}$, is a surjective $M$-function. Then, denoting $p(\pi)$ the unique solution to $Q_{-0}(p)=0$, one has that $\pi \leq \pi^{\prime}$ implies $p(\pi) \leq p\left(\pi^{\prime}\right)$.

Example 2.5. Consider the case of regularized optimal transport:

$$
\left\{\begin{array}{l}
Q_{x}(p)=\sum_{y} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)-n_{x} \\
Q_{y}(p)=-\sum_{x} \exp \left(\Phi_{x y}+p_{x}-p_{y}\right)+m_{y}
\end{array}\right.
$$

so that $1^{\top} Q(p)=\sum_{y} m_{y}-\sum_{x} n_{x}$ is constant. It is easy to see that $Q$ is a Z-function. In addition, because of constant aggregates, $Q(p) \leq Q\left(p^{\prime}\right)$ implies $Q(p)=Q\left(p^{\prime}\right)$ so $Q$ is weakly nonreversing, thus it is an $M_{0}$-function. However, $Q$ is not an $M$-function: take for instance $p=p^{\prime}+1_{Z}$, then we have $p \geq p^{\prime}$ and $Q(p)=Q\left(p^{\prime}\right)$, but $p \neq p^{\prime}$ so $Q$ is not strongly nonreversing.

Example 2.6. Consider a linear $Q(p)=(\Delta-A) p$ where $\Delta$ is a diagonal matrix with positive entries, A has a zero diagonal and positive off-diagonal entries, and

$$
1^{\top}(\Delta-A)=0
$$

so that the function $Q$ has constant aggregates. Then the matrix $\Delta^{-1} A$ is nonnegative and irreducible (it is strongly connected), and the Perron-Frobenius theorem applies. Letting $\delta=\Delta 1$, we have $\delta \geq 0$ and $\delta^{\top}=1^{\top} A=\delta^{\top} \Delta^{-1} A$, so $\delta$ must be the left Perron eigenvector of $\Delta^{-1} A$, and it is associated to the Perron eigenvalue 1. Thus there is also a right Perron eigenvector $v \geq 0$ such that $\Delta^{-1} A v=v$, i.e. $Q(v)=(\Delta-A) v=0$.

### 2.5 Application: a toy hedonic model

Consider a surge pricing problem in an Uber-like environment. We have partitioned the city in a finite number of locations (say, blocks). Let $x \in X$ denote the location of the driver, $y \in Y$ the location of the passenger, and $z \in Z$ the pickup location. Assume that for a driver at $x$, the cost of picking up a passenger at $z$ is $c_{x z}$. If the price of the ride at $z$ is $p_{z}$, the utility of the driver is $p_{z}-c_{x z}+\varepsilon_{z}$, where the vector $\left(\varepsilon_{z}\right)$ is random. If the driver does not pick up anyone, the utility is normalized to $\varepsilon_{0}$. Assume that $\left(\varepsilon_{z}\right)$ is i.i.d. Gumbel. Then the probability that a driver at $x$ will demand a ride $z$ is

$$
\begin{equation*}
\frac{\exp \left(p_{z}-c_{x z}\right)}{1+\sum_{z^{\prime}} \exp \left(p_{z^{\prime}}-c_{x z^{\prime}}\right)} \tag{13}
\end{equation*}
$$

Now assume there are $n_{x}$ drivers in area $x$, therefore the supply for rides at $z$ is

$$
\begin{equation*}
S_{z}(p)=\sum_{x \in X} n_{x} \frac{\exp \left(p_{z}-c_{x z}\right)}{1+\sum_{z^{\prime}} \exp \left(p_{z^{\prime}}-c_{x z^{\prime}}\right)} \tag{14}
\end{equation*}
$$

It is easy to see that $S_{z}(p)$ is decreasing with respect to $p_{z^{\prime}}$ for $z^{\prime} \neq z$.

Now let's focus on demand. This is the same as before, except for the fact that the utility of a passenger at $y$ seeking a ride at location $z$ is now $a_{y z}-p_{z}+\eta_{z}$, and the utility of the outside option is $\eta_{0}$, where $\left(\eta_{z}\right)$ is i.i.d. Gumbel. Assuming there are $m_{y}$ passengers in area $y$, the induced demand is

$$
\begin{equation*}
D_{z}(p)=\sum_{y \in Y} m_{y} \frac{\exp \left(a_{y z}-p_{z}\right)}{1+\sum_{z^{\prime}} \exp \left(a_{y z^{\prime}}-p_{z^{\prime}}\right)} \tag{15}
\end{equation*}
$$

and we see that $-D_{z}(p)$ is also decreasing with respect to $p_{z^{\prime}}$ for $z^{\prime} \neq z$.

The excess supply function $Q$ is defined with

$$
Q_{z}(p)=S_{z}(p)-D_{z}(p)
$$

It is clearly continuous, and it is a Z-function as the sum of two Z-functions. Let's show that it is also strongly nonreversing, and therefore an M-function. The aggregates of $Q(p)$ are

$$
\sum_{z} Q_{z}(p)=\sum_{x \in X} n_{x} \frac{\sum_{z} \exp \left(p_{z}-c_{x z}\right)}{1+\sum_{z} \exp \left(p_{z}-c_{x y}\right)}-\sum_{y \in Y} m_{y} \frac{\sum_{z} \exp \left(a_{y z}-p_{z}\right)}{1+\sum_{z} \exp \left(a_{y z}-p_{z}\right)}
$$

which we see are strictly isotone in $p: p \geq p^{\prime}$ implies $\sum_{z} Q_{z}(p) \geq \sum_{z} Q_{z}\left(p^{\prime}\right)$, and if $p \neq p^{\prime}$ then the inequality is strict. Suppose then that we have $p \geq p^{\prime}$ and $Q(p) \leq Q\left(p^{\prime}\right)$. Because aggregates are isotone, we must have $Q(p)=Q\left(p^{\prime}\right)$. Furthermore, if we had $p \neq p^{\prime}$, then we would have $\sum_{z} Q_{z}(p)>\sum_{z} Q_{z}\left(p^{\prime}\right)$. But this contradicts $Q(p)=Q\left(p^{\prime}\right)$, hence actually $p=p^{\prime}$.

Finally, note that when all $p_{z}=k$ and $k \rightarrow+\infty, Q_{z}(p) \geq 0$; while when all $p_{z}=k$ and $k \rightarrow-\infty$ we have $Q_{z}(p) \leq 0$. As a result both a super- and a subsolution exist, and therefore theorem 2.2 guarantees that the problem has a unique solution which can be reached as the limit of a Jacobi sequence starting from any sub- or supersolution.

### 2.6 References and notes

This section draws upon the book by Ortega and Rheinboldt $(1970)$, the papers by Berry, Gandhi and Haile (2013) and Galichon. Kominers and Weber (2019). It also builds on the working papers by Galichon, Samuelson and Vernet (2022), Galichon and Léger (2023), and Chen. Choo. Galichon and Weber (2021).

## 3 Models of matching with transfers

In this section we shall look specifically at models which formulate as

$$
\left\{\begin{array}{l}
\sum_{y \in Y} M_{x y}\left(a_{x}, b_{y}\right)+M_{x 0}\left(a_{x}\right)=n_{x} \\
\sum_{x \in X} M_{x y}\left(a_{x}, b_{y}\right)+M_{0 y}\left(b_{y}\right)=m_{y}
\end{array}\right.
$$

where $M_{x y}\left(a_{x}, b_{y}\right)$ is continuous and increasing in $a_{x}$ and $b_{y}$, and will stand for the number of matches between types $x$ and $y$; and $M_{x 0}\left(a_{x}\right)$ and $M_{0 y}\left(b_{y}\right)$ are also continuous and will stand for the number of unmatched agents of type $x$ and $y$, respectively.

At the end of this section we will show how this framework extends to the full assignment case, i.e. when $M_{x 0}\left(a_{x}\right)=M_{0 y}\left(b_{y}\right)=0$. Optimal transport falls into this category, as seen with Sinkhorn's algorithm in section 2.

### 3.1 Microfoundation of the matching model

We will consider as illustration a matching model between workers (CEOs) and firms with taxes. There are $n_{x}$ workers of type $x \in X$ and $m_{y}$ firms of type $y \in Y$. Assume that firms pay their worker a gross wage $w$, from which the worker receives the net wage $N(w)$. In typical progressive taxation fashion, $N$ is increasing, concave, and piecewise affine. We can thus represent it as

$$
\begin{equation*}
N(w)=\min _{k=0, \ldots, K}\left(1-\tau_{k}\right)\left(w-w_{k}\right) \tag{16}
\end{equation*}
$$

where $\tau_{k}$ is the marginal tax rate in the $k^{\text {th }}$ tax bracket: $\tau_{0}=0<\tau_{1}<\cdots<\tau_{K}$. If there are no taxes, then we simply have $N(w)=w$.

If matched with a firm $y$, a worker $x$ gets utility

$$
\alpha_{x y}+N\left(w_{x y}\right)+\sigma \varepsilon_{y}
$$

where $\alpha_{x y}$ is worker $x$ 's monetary valuation of job $y$ 's amenities; $N\left(w_{x y}\right)$ is the net wage of worker $x$ working for firm $y$; and $\varepsilon_{y}$ is a random utility. If unmatched, a worker $x$ gets utility $\sigma \varepsilon_{0}$. Hence worker $x$ 's problem is to choose a firm $y$ with

$$
\max _{y \in Y}\left\{\alpha_{x y}+N\left(w_{x y}\right)+\sigma \varepsilon_{y}, \sigma \varepsilon_{0}\right\}
$$

We assume that $\left(\varepsilon_{y}\right)$ is i.i.d. Gumbel. As a result, the expected indirect utility of a worker of type $x$ is

$$
u_{x}=\sigma \log \left(1+\sum_{y} \exp \left(\frac{\alpha_{x y}+N\left(w_{x y}\right)}{\sigma}\right)\right)
$$

and the probability that worker $x$ picks firm $y$ is

$$
\begin{equation*}
\frac{\mu_{x y}}{n_{x}}=\frac{\exp \left(\frac{\alpha_{x y}+N\left(w_{x y}\right)}{\sigma}\right)}{1+\sum_{y^{\prime}} \exp \left(\frac{\alpha_{x y^{\prime}}+N\left(w_{x y}^{\prime}\right)}{\sigma}\right)}=\exp \left(\frac{\alpha_{x y}+N\left(w_{x y}\right)-u_{x}}{\sigma}\right) \tag{17}
\end{equation*}
$$

On firm $y$ 's side, the problem is to choose a worker $x$ with

$$
\max _{x \in X}\left\{\gamma_{x y}-w_{x y}+\sigma \eta_{x}, \sigma \eta_{0}\right\}
$$

where $\gamma_{x y}$ is the value of worker $x$ for firm $y$, and $\eta_{x}$ is the random utility. We assume that $\left(\eta_{x}\right)$ is also i.i.d. Gumbel, so that the expected indirect utility of a firm of type $y$ is

$$
v_{y}=\sigma \log \left(1+\sum_{x} \exp \left(\frac{\gamma_{x y}-w_{x y}}{\sigma}\right)\right)
$$

and the probability that firm $y$ picks worker $x$ is

$$
\begin{equation*}
\frac{\mu_{x y}}{m_{y}}=\exp \left(\frac{\gamma_{x y}-w_{x y}-v_{y}}{\sigma}\right) \tag{18}
\end{equation*}
$$

Lastly, the probabilities that worker $x$ or firm $y$ remains unmatched are respectively:

$$
\begin{equation*}
\frac{\mu_{x 0}}{n_{x}}=\exp \left(-\frac{u_{x}}{\sigma}\right), \quad \frac{\mu_{0 y}}{m_{y}}=\exp \left(-\frac{v_{y}}{\sigma}\right) \tag{19}
\end{equation*}
$$

Equations (17), (18) and (19), together with the feasibility conditions

$$
\begin{equation*}
\sum_{y \in Y} \mu_{x y}+\mu_{x 0}=n_{x}, \quad \sum_{x \in X} \mu_{x y}+\mu_{0 y}=m_{y} \tag{20}
\end{equation*}
$$

form a system of equations with unknowns $\mu_{x y}, \mu_{x 0}, \mu_{0 y}, u_{x}, v_{y}$ and $w_{x y}$. Our strategy to solve this system will consist of three steps. First, we will eliminate $w_{x y}$ in order to express $\mu_{x y}$ as a function of $u_{x}$ and $v_{y}$ only, using the distanceto-frontier function. Second, we will solve for $u_{x}$ and $v_{y}$ with Jacobi's algorithm. Finally, we will recover $\mu_{x y}, \mu_{x 0}, \mu_{0 y}$ and $w_{x y}$ from $u_{x}$ and $v_{y}$.

### 3.2 Distance-to-frontier function

The wage $w_{x y}$ is a way to transfer systematic utility from one partner to the other. After transfer, the systematic utilities of both partners in a match $x y$ are

$$
\begin{cases}\text { for } x, & U_{x y}=\alpha_{x y}+N\left(w_{x y}\right) \\ \text { for } y, & V_{x y}=\gamma_{x y}-w_{x y}\end{cases}
$$

More generally, we will consider models in which $(U, V)$ belongs to a feasible set $\mathcal{F}_{x y}$, and we shall make two assumptions on $\mathcal{F}_{x y}$. The first one, free disposal, means that agents can dispose of utility at will.

Assumption 3.1 (Free disposal). If $(U, V) \in \mathcal{F}_{x y}$, then for any $U^{\prime} \leq U$ and $V^{\prime} \leq V$ we have $\left(U^{\prime}, V^{\prime}\right) \in \mathcal{F}_{x y}$.

The second one, scarcity, means that one partner cannot have an arbitrarily large level of utility without a negative effect on the utility of the other partner.

Assumption 3.2 (Scarcity). If $\left(U^{n}\right)$ and $\left(V^{n}\right)$ are two sequences such that $U^{n} \rightarrow+\infty$ and $V^{n}$ is bounded below, then for $N$ large enough $\left(U^{n}, V^{n}\right) \notin \mathcal{F}_{x y}$ for $n \geq N$; and similarly for $U^{n}$ bounded below and $V^{n} \rightarrow+\infty$.

We will describe the feasible set $\mathcal{F}_{x y}$ using the distance-to-frontier function:

$$
\begin{equation*}
D_{x y}(U, V)=\min \left\{t \in \mathbb{R}:(U-t, V-t) \in \mathcal{F}_{x y}\right\} \tag{21}
\end{equation*}
$$

This function encodes the feasible set in the following sense. If the utility profile $(U, V)$ is outside the feasible set, then the distance is positive: $D_{x y}(U, V)>0$. Conversely, if $(U, V)$ is in the interior of the feasible set, then the distance is negative: $D_{x y}(U, V)<0$. Only when $(U, V)$ is exactly on the frontier is the distance zero.

We mention two other useful properties of the distance-to-frontier function, before looking at this function on two examples.

## Proposition 3.1.

(i) For $F_{1}$ and $F_{2}$ two elementary sets,

$$
D_{F_{1} \cap F_{2}}=\max \left\{D_{F_{1}}, D_{F_{2}}\right\} \quad \text { and } \quad D_{F_{1} \cup F_{2}}=\min \left\{D_{F_{1}}, D_{F_{2}}\right\}
$$

(ii) Translation invariance: $D(U+t, V+t)=t+D(U, V)$.

Example 3.1 (Transferable utility). In this case

$$
\mathcal{F}_{x y}=\left\{(U, V) \in \mathbb{R}^{2}: U+V \leq \Phi_{x y}\right\}
$$

so the minimum $t$ such that $(U-t, V-t) \in \mathcal{F}_{x y}$ verifies $(U-t)+(V-t)=\Phi_{x y}$, hence

$$
D_{x y}(U, V)=\frac{U+V-\Phi_{x y}}{2}
$$

Example 3.2 (Piecewise linear taxes). In this case $U \leq \alpha_{x y}+N\left(w_{x y}\right)$ and $V \leq \gamma_{x y}-w_{x y}$, so that

$$
\begin{aligned}
\mathcal{F}_{x y} & =\left\{(U, V) \in \mathbb{R}^{2}: N\left(\gamma_{x y}-V\right) \geq U-\alpha_{x y}\right\} \\
& =\left\{(U, V): \min _{k=0, \ldots, K}\left(1-\tau_{k}\right)\left(\gamma_{x y}-V-w_{k}\right) \geq U-\alpha_{x y}\right\} \\
& =\bigcap_{k}\left\{(U, V):\left(1-\tau_{k}\right)\left(\gamma_{x y}-V-w_{k}\right) \geq U-\alpha_{x y}\right\}
\end{aligned}
$$

Hence $D_{x y}(U, V)=\max _{k} D_{x y}^{k}(U, V)$, where

$$
D_{x y}^{k}(U, V)=\frac{U-\alpha_{x y}+\left(1-\tau_{k}\right)\left(V-\gamma_{x y}+w_{k}\right)}{2-\tau_{k}}
$$

### 3.3 Matching equilibrium

Now back to the matching model, recall that we had

$$
\frac{\mu_{x y}}{n_{x}}=\exp \left(\frac{U_{x y}-u_{x}}{\sigma}\right), \quad \frac{\mu_{x y}}{m_{y}}=\exp \left(\frac{V_{x y}-v_{y}}{\sigma}\right)
$$

where $U_{x y}$ and $V_{x y}$ denote the systematic parts of utility in a match $x y$. Solving for $U_{x y}$ and $V_{x y}$ yields

$$
U_{x y}=u_{x}+\sigma \log \frac{\mu_{x y}}{n_{x}}, \quad V_{x y}=v_{y}+\sigma \log \frac{\mu_{x y}}{m_{y}}
$$

We assume that the market is large, so that every type of match $x y$ must be occurring. Then $D_{x y}\left(U_{x y}, V_{x y}\right)=0$ for all $x y$. Replacing $U_{x y}$ and $V_{x y}$ by their expressions above, we get

$$
D_{x y}\left(u_{x}+\sigma \log \frac{\mu_{x y}}{n_{x}}, v_{y}+\sigma \log \frac{\mu_{x y}}{m_{y}}\right)=0
$$

The translation invariance property yields

$$
\sigma \log \mu_{x y}+D_{x y}\left(u_{x}-\sigma \log n_{x}, v_{y}-\sigma \log m_{y}\right)=0
$$

Thus we have eliminated $w_{x y}$ by combining equations (17) and (18), and we are able to express $\mu_{x y}, \mu_{x 0}$ and $\mu_{0 y}$ as functions of $u_{x}$ and $v_{y}$ only:

$$
\begin{gathered}
\mu_{x y}=\exp \left(-\frac{D_{x y}\left(u_{x}-\sigma \log n_{x}, v_{y}-\sigma \log m_{y}\right)}{\sigma}\right) \\
\mu_{x 0}=\exp \left(-\frac{u_{x}-\sigma \log n_{x}}{\sigma}\right), \quad \mu_{0 y}=\exp \left(-\frac{v_{y}-\sigma \log m_{y}}{\sigma}\right)
\end{gathered}
$$

Next we want to solve for $u_{x}$ and $v_{y}$ using Jacobi's algorithm. Introduce $p_{x}=-\left(u_{x}-\sigma \log n_{x}\right)$ and $p_{y}=v_{y}-\sigma \log m_{y}$, and substitute the expressions of $\mu_{x y}, \mu_{x 0}$ and $\mu_{0 y}$ above in the feasibility conditions (20) to obtain the system:

$$
\left\{\begin{array}{l}
\sum_{y} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right) / \sigma\right)+\exp \left(p_{x} / \sigma\right)=n_{x}  \tag{22}\\
\sum_{x} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right) / \sigma\right)+\exp \left(-p_{y} / \sigma\right)=m_{y}
\end{array}\right.
$$

We define the function $Q$ using

$$
\left\{\begin{array}{l}
Q_{x}(p)=\sum_{y} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right) / \sigma\right)+\exp \left(p_{x} / \sigma\right)-n_{x} \\
Q_{y}(p)=-\sum_{x} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right) / \sigma\right)-\exp \left(-p_{y} / \sigma\right)+m_{y}
\end{array}\right.
$$

so that the system (22) rewrites as $Q(p)=0$. One can then check that $Q$ is a continuous M-function (it is a Z-function with strictly isotone aggregates).

We also have:

Proposition 3.2. The problem $Q(p)=0$ has a sub- and a supersolution.

Proof. To get a supersolution, first set $p_{x}$ such that $\exp \left(p_{x} / \sigma\right) \geq n_{x}$, so that $Q_{x}\left(p_{x}, p_{-x}\right) \geq 0$ for all $p_{-x}$. Second, we show that for all $x y$ we must have $D_{x y}\left(-p_{x}, p_{y}\right) \rightarrow+\infty$ when $p_{y} \rightarrow+\infty$. Suppose this is not the case: then there exists an increasing sequence $\left(p_{y}^{n}\right)$ such that $p_{y}^{n} \rightarrow+\infty$ but $D_{x y}\left(-p_{x}, p_{y}^{n}\right) \leq K$ for some constant $K$. By translation invariance, $D_{x y}\left(-p_{x}-K, p_{y}^{n}-K\right) \leq 0$, i.e. $\left(-p_{x}-K, p_{y}^{n}-K\right) \in \mathcal{F}_{x y}$ for all $n$. But since $-p_{x}-K$ is constant (so bounded below) and $p_{y}^{n}-K \rightarrow+\infty$, this contradicts the scarcity assumption. Hence for $p_{y}$ large enough, $\sum_{x} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right) / \sigma\right)+\exp \left(-p_{y} / \sigma\right) \leq m_{y}$, i.e. $Q_{y}(p) \geq 0$. A subsolution can be found in a similar manner.

Hence by theorem 2.2. the problem has a unique solution. Finally, since the problem has a solution for any $n_{x}$ and $m_{y}$ the function $Q$ must be surjective, and therefore any Jacobi sequence converges towards the solution according to theorem 2.3 .

We conclude this discussion with a comment on the the optimization structure. If $Q$ were a gradient, one could write $Q_{z}=\partial F / \partial p_{z}$ for some function $F$ and thus

$$
\frac{\partial Q_{y}}{\partial p_{x}}=\frac{\partial^{2} F}{\partial p_{x} \partial p_{y}}=\frac{\partial Q_{x}}{\partial p_{y}}
$$

But we have

$$
\begin{aligned}
& \frac{\partial Q_{x}(p)}{\partial p_{y}}=-\exp \left(-\frac{D_{x y}\left(-p_{x}, p_{y}\right)}{\sigma}\right) \frac{\partial_{V} D_{x y}\left(-p_{x}, p_{y}\right)}{\sigma} \\
& \frac{\partial Q_{y}(p)}{\partial p_{x}}=-\exp \left(-\frac{D_{x y}\left(-p_{x}, p_{y}\right)}{\sigma}\right) \frac{\partial_{U} D_{x y}\left(-p_{x}, p_{y}\right)}{\sigma}
\end{aligned}
$$

which is not symmetric unless

$$
\partial_{U} D_{x y}(U, V)=\partial_{V} D_{x y}(U, V)
$$

This only happens in the optimal transport case, when $D_{x y}(U, V)=(U+V-$ $\left.\Phi_{x y}\right) / 2$.

### 3.4 Full assignment case

Here we assume that $\sum_{x} n_{x}=\sum_{y} m_{y}$. In the previous setting, define the map $Q: \mathbb{R}^{X \cup Y \backslash\left\{y_{0}\right\}} \rightarrow \mathbb{R}^{X \cup Y \backslash\left\{y_{0}\right\}}$ by

$$
\begin{cases}Q_{x}(p)=\sum_{y} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right)\right)-n_{x}, & x \in X \\ Q_{y}(p)=-\sum_{x} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right)\right)+m_{y}, & y \in Y \backslash\left\{y_{0}\right\}\end{cases}
$$

where we have normalized $p_{y_{0}}=\pi$. To ensure that $Q$ is responsive in this setting (and therefore that Jacobi updates are well-defined) we will make an additional assumption on the feasible sets $\mathcal{F}_{x y}$ :

Assumption 3.3 (Strong transferability). For all $U$ there exists $V$ such that $(U, V) \in \mathcal{F}_{x y} ;$ and conversely, for all $V$ there exists $U$ such that $(U, V) \in \mathcal{F}_{x y}$.

Under this assumption, any arbitrarily high level of utility is attainable for a partner within a match, as long as the other partner is willing to give up enough utility.

Chen. Choo. Galichon and Weber (2021) show:

Theorem 3.1. The equation $Q(p)=0$ has a solution.

Proof. The proof is constructive and is done in three steps. First, we look for a supersolution to initialize Jacobi's algorithm. Second, we show that Jacobi updates are well-defined. Finally, we show that the Jacobi sequence cannot diverge.

Step 1. Look for a supersolution $p^{0}$. We have

$$
Q_{x}(p)=\sum_{y} \exp \left(-D_{x y}\left(-p_{x}, p_{y}\right)\right)-n_{x} \geq \exp \left(-D_{x y_{0}}\left(-p_{x}, \pi\right)\right)-n_{x}
$$

By strong transferability, there exists $U_{x}$ such that $\left(U_{x}, \pi+\log n_{x}\right) \in \mathcal{F}_{x y}$, i.e. $D_{x y}\left(U_{x}, \pi+\log n_{x}\right) \leq 0$. Taking $p_{x}^{0}=\log n_{x}-U_{x}$, we have $0 \geq D_{x y}\left(-p_{x}^{0}+\right.$ $\left.\log n_{x}, \pi+\log n_{x}\right)=D_{x y}\left(-p_{x}^{0}, \pi\right)+\log n_{x}$, i.e. $\exp \left(-D_{x y}\left(-p_{x}^{0}, \pi\right)\right) \geq n_{x}$, and therefore $Q_{x}\left(p_{x}^{0}, p_{-x}\right) \geq 0$ for all $p_{-x}$. Next, by scarcity we have $D_{x y}\left(-p_{x}^{0}, p_{y}\right) \rightarrow$ $+\infty$ as $p_{y} \rightarrow+\infty$ (see the argument in the proof of proposition 3.2) so we can set $p_{y}^{0}$ large enough such that

$$
\sum_{x} \exp \left(-D_{x y}\left(-p_{x}^{0}, p_{y}^{0}\right)\right) \leq m_{y}
$$

hence $Q_{y}\left(p^{0}\right) \geq 0$ as well, so we have a supersolution.

Step 2. We now show that the Jacobi update from a supersolution is welldefined. The function $p_{x} \mapsto \sum_{y} \exp \left(-D_{x y}\left(-p_{x}, p_{y}^{0}\right)\right)-n_{x}$ is continuous, nonnegative for $p_{x}=p_{x}^{0}$, and by scarcity it converges to $-n_{x}<0$ when $p_{x} \rightarrow-\infty$, hence $p_{x}^{1}$ is well-defined.

Now consider the function $p_{y} \mapsto-\sum_{x} \exp \left(-D_{x y}\left(-p_{x}^{0}, p_{y}\right)\right)+m_{y}$. It is continuous, and nonnegative for $p_{y}=p_{y}^{0}$. Choose an $x$ arbitrarily, then by strong transferability, there exists $V_{y}$ such that $\left(-p_{x}^{0}+\log m_{y}, V_{y}\right) \in \mathcal{F}_{x y}$. We have $0 \geq D_{x y}\left(-p_{x}^{0}+\log m_{y}, V_{y}\right)=D_{x y}\left(-p_{x}^{0}, V_{y}-\log m_{y}\right)+\log m_{y}$, thus $\exp \left(-D_{x y}\left(-p_{x}^{0}, V_{y}-\log m_{y}\right)\right) \geq m_{y}$, and therefore the function above is negative for $p_{y}=V_{y}-\log m_{y}$, hence $p_{y}^{1}$ is also well-defined.

By induction, $p^{t+1}$ is well-defined for all $t$ since $p^{t}$ is also a supersolution.

$\underline{\text { Step 3. Let us show that the Jacobi sequence initialized at the supersolution }}$ $p^{0}$ cannot diverge. $Q$ is a Z-function with isotone aggregates, therefore it is an $\mathrm{M}_{0}$-function, and thus the Jacobi sequence $\left(p^{t}\right)$ starting from $p^{0}$ is a decreasing sequence of supersolutions. Hence, either it converges to a solution, or it is unbounded.

However, because $p^{t}$ is a supersolution, we have

$$
\sum_{x} \exp \left(-D_{x y_{0}}\left(-p_{x}^{t}, \pi\right)\right)-m_{y_{0}}=\sum_{z \in X \cup Y \backslash\left\{y_{0}\right\}} Q_{z}\left(p^{t}\right) \geq 0
$$

thus all the $p_{x}^{t}$ cannot go to $-\infty$. Letting $x^{*}$ be such that $p_{x^{*}}^{t} \rightarrow p_{x^{*}}^{\infty}>-\infty$, we have

$$
\exp \left(-D_{x^{*} y}\left(-p_{x^{*}}^{t}, p_{y}^{t}\right)\right) \leq \sum_{x} \exp \left(-D_{x y}\left(-p_{x}^{t}, p_{y}^{t}\right)\right) \leq m_{y}
$$

thus all $p_{y}^{t}$ remain bounded below as well. Finally, we have

$$
\sum_{y} \exp \left(-D_{x y}\left(-p_{x}^{t}, p_{y}^{t}\right)\right) \geq n_{x}
$$

and thus all the $p_{x}^{t}$ remain bounded below too. Hence the sequence converges.

Uniqueness of the solution is not guaranteed under the strong transferability assumption, because then $Q$ is a $\mathrm{M}_{0}$-function. To obtain uniqueness, one may ask an additional requirement on the feasible sets, which ensures that $Q$ is a M-function and therefore that theorem 2.2 applies. For instance:

Assumption 3.4 (Strong local transferability). For any $(U, V) \in \mathcal{F}_{x y}$ and any $\varepsilon>0$, the open ball of center $(U, V)$ and of radius $\varepsilon$ contains both a point $\left(U^{\prime}, V^{\prime}\right)$ such that $U^{\prime}>U$, and a point $\left(U^{\prime \prime}, V^{\prime \prime}\right) \in \mathcal{F}_{x y}$ such that $V^{\prime \prime}>V$.

This assumption rules out horizontal or vertical slopes on the frontier of $\mathcal{F}_{x y}$, which ensures that $Q$ is an M-function.

## References and notes

This section draws upon Galichon. Kominers and Weber (2019). The case with full assignment is covered in Chen, Choo, Galichon and Weber (2021).
