# (")RULER: What's the Real Context Size of Your Long-Context Language Models? 

Cheng-Ping Hsieh*, Simeng Sun*, Samuel Kriman, Shantanu Acharya<br>Dima Rekesh, Fei Jia, Yang Zhang, Boris Ginsburg<br>NVIDIA<br>\{chsieh, simengs\}@nvidia.com


#### Abstract

The needle-in-a-haystack (NIAH) test, which examines the ability to retrieve a piece of information (the "needle") from long distractor texts (the "haystack"), has been widely adopted to evaluate long-context language models (LMs). However, this simple retrieval-based test is indicative of only a superficial form of long-context understanding. To provide a more comprehensive evaluation of long-context LMs, we create a new synthetic benchmark RULER with flexible configurations for customized sequence length and task complexity. RULER expands upon the vanilla NIAH test to encompass variations with diverse types and quantities of needles. Moreover, RULER introduces new task categories multi-hop tracing and aggregation to test behaviors beyond searching from context. We evaluate ten longcontext LMs with 13 representative tasks in RULER. Despite achieving nearly perfect accuracy in the vanilla NIAH test, all models exhibit large performance drops as the context length increases. While these models all claim context sizes of $32 \mathrm{~K}$ tokens or greater, only four models (GPT-4, Command-R, Yi-34B, and Mixtral) can maintain satisfactory performance at the length of $32 \mathrm{~K}$. Our analysis of Yi-34B, which supports context length of $200 \mathrm{~K}$, reveals large room for improvement as we increase input length and task complexity. We open source RULER to spur comprehensive evaluation of long-context LMs.


## 1 Introduction

Recent advancements in AI system engineering (Dao et al., 2022; Jacobs et al., 2023; Fu et al., 2024) and language model designs (Chen et al., 2023: Xiong et al., 2023) have enabled efficient scaling up of context length for language models (Liu et al. 2024a; Young et al. 2024). Previous works (AI21, 2024, X.AI, 2024 Reid et al., 2024 Anthropic, 2024) commonly adopt synthetic tasks, such as passkey retrieval (Mohtashami \& Jaggi 2023) and needle-in-ahaystack (Kamradt, 2023) to evaluate long-context LMs. However, these evaluations are used inconsistently across works and reveal merely the retrieval capability, failing to gauge other forms of long-context understanding.

In this work, we propose RULER, a new benchmark to evaluate long-context modeling capabilities for language models. RULER contains four task categories to test behaviors (Ribeiro et al. 2020) beyond simple retrieval from context:

1. Retrieval: we extend the needle-in-a-haystack (Kamradt 2023, NIAH) test to evaluate retrieval capability with diverse types and quantities of needles.
2. Multi-hop Tracing: we propose variable tracking, a minimal proxy task for coreference chain resolution to check the behavior of tracing entities with multi-hop connections.
3. Aggregation: we propose common/frequent words extraction, proxy tasks for summarization to test the ability to aggregate relevant information that spans long-range context.

* Authors contributed equally.

| Benchmark \& Task | Avg Len | Type | Diverse <br> Tasks | Min. Parametric <br> Knowledge | Controllable <br> Context |
| :--- | :---: | :---: | :---: | :---: | :---: |
| ZeroSCROLLS | $\sim 10 \mathrm{k}$ | realistic | $\checkmark$ | $x$ | $x$ |
| L-Eval | $\sim 8 \mathrm{k}$ | realistic | $\checkmark$ | $x$ | $x$ |
| BAMBOO | $\sim 16 \mathrm{k}$ | realistic | $\checkmark$ | $\checkmark$ | $x$ |
| LongBench | $\sim 8 \mathrm{k}$ | hybrid | $\checkmark$ | $x$ | $x$ |
| LooGLE | $\sim 20 \mathrm{k}$ | hybrid | $\checkmark$ | $\checkmark$ | $\times$ |
| InfiniteBench | $\sim 200 \mathrm{k}$ | hybrid | $\checkmark$ | $\checkmark$ | $x$ |
| Needle-in-a-haystack (NIAH) | any | synthetic | $x$ | $\checkmark$ | $\checkmark$ |
| Passkey / Line / KV Retrieval | any | synthetic | $x$ | $\checkmark$ | $\checkmark$ |
| RULER (Ours) | any | synthetic | $\checkmark$ | $\checkmark$ | $\checkmark$ |

Table 1: Comparison between existing long-context benchmarks and RULER. "Realistic" type refers to human-annotated while "synthetic" type refers to auto-generated. RULER includes diverse task domains beyond retrieval, reduces reliance on parametric knowledge with synthetic input, and offers flexibility to control the contexts for different sequence lengths and task complexities. In RULER, contexts can be adjusted by changing the volume or placement of relevant and distracted information.

4. Question Answering: we add distracting information to the input of existing shortcontext QA datasets to evaluate question answering capability at various context sizes.

Compared to existing realistic benchmarks (Table 1), RULER consists solely of synthetic tasks, which offer the flexibility to control sequence length and task complexity. The synthetic input in RULER reduces reliance on parametric knowledge, which interferes with the utilization of long-context input in realistic tasks (Shaham et al. 2023; Bai et al., 2023).

Using RULER, we benchmark GPT-4 (OpenAI: Josh Achiam et al., 2023) and nine opensource models with context length ranging from $4 \mathrm{k}$ to $128 \mathrm{k}$. Despite achieving nearly perfect performance on the vanilla NIAH test, all models exhibit large degradation on more complex tasks in RULER as sequence length increases. While all models claim context size of $32 \mathrm{k}$ tokens or greater, our results indicate that only four of them can effectively handle sequence length of $32 \mathrm{~K}$ by exceeding a qualitative threshold. Moreover, almost all models fall below the threshold before reaching the claimed context lengths. To obtain fine-grained model comparisons, we aggregate performance from $4 \mathrm{k}$ to $128 \mathrm{k}$ with two weighted average scores where the weights simulate the length distribution of real-world use cases. The top models - GPT-4, Command-R (Cohere, 2024), Yi-34B (Young et al. 2024), and Mixtral (Jiang et al. 2024), consistently outperform other models regardless of the chosen weighting scheme.

We further analyze Yi-34B, which claims context length of 200K and achieves the 2nd place on RULER among open-source models. Our results demonstrate large degradation in Yi's performance as we increase input length and task complexity. At large context sizes, Yi-34B often returns incomplete answers and fails to precisely locate the relevant information. Furthermore, we observe two behaviors emerging with the scaling of context size across multiple models: the increased reliance on parametric knowledge and the increased tendency to copy from context for non-retrieval tasks. Our additional ablations demonstrate that training on longer sequences does not always lead to better performance on RULER, and that larger model sizes positively correlate with better long-context capabilities. Finally, we show that non-Transformer architectures, such as RWKV and Mamba, still lag behind Transformer by large margins on RULER.

Our contributions are as follows:

- We propose a new benchmark RULER for evaluating long-context language models via synthetic tasks with flexible configurations.
- We introduce new task categories, specifically multi-hop tracing and aggregation, to test behaviors other than retrieval from long context.
- We evaluate ten long-context LMs using RULER and perform analysis across models and task complexities.

We open source RULER to spur future research in long-context language models $\cup^{1}$[^0]

## 2 Related Work

Long-context Language Models. Numerous long-context language models have been introduced lately owing to the progress in engineering, architectural, and algorithmic designs. Flash attention (Dao et al., 2022; Dao, 2023) and Ring attention (Liu et al., 2023) significantly reduce the memory footprint required for processing long context. Various sparse attention mechanisms (Child et al., 2019 Jaszczur et al. [2021) such as shifted sparse attention (Chen et al. 2024), dilated attention (Ding et al. 2023), and attention sinks (Han et al. 2023: Xiao et al. 2024b) were employed to enable efficient context scaling. Novel position embedding methods were proposed to improve length extrapolation in Transformers (Vaswani et al. 2017), including ALiBi (Press et al. 2022), xPOS (Sun et al., 2023b), and RoPE (Su et al. 2023) variants (Chen et al. 2023: Xiong et al. 2023: Peng et al. 2024: Liu et al. 2024b: Ding et al. 2024; Zhu et al.| 2024). Another line of research focuses on reducing context size. This can be achieved by caching previous context using recurrence mechanism (Zhang et al. 2024a: Bulatov et al. 2023: Martins et al. 2022: Wu et al. 2022), or preserving only the salient information within long context via retrieval (Xu et al.. 2024: Mohtashami \& Jaggil, 2023; Wang et al., 2024: Tworkowski et al., 2024: Xiao et al.. 2024a) or compression (Jiang et al. 2023). Finally, novel architectures (Gu et al.|[2022; Fu et al., 2023a; Poli et al. 2023; Fu et al. 2023b; Sun et al., 2023a) such as Mamba (Gu \& Dao, 2023) and RWKV (Peng et al.. 2023) have also been proposed to efficiently handle long-context input.

Long-context Benchmarks and Tasks. Our work is closely related to other works on benchmarking long-context language models. ZeroSCROLLS (Shaham et al. 2023) covers ten realistic natural language tasks, such as long-document QA and (query-based) summarization. L-Eval (An et al., 2024) also uses realistic data, which was filtered manually to ensure quality. LongBench (Bai et al. 2023) contains tasks in a bilingual setting. InfiniteBench (Zhang et al. . 2024b) includes tasks with length greater than 100K tokens. LTM (Castillo et al., 2024) targets the evaluation of long-term conversations. To isolate the effect of parametric knowledge, previous works (Dong et al., 2023; Li et al., 2023b) also propose to use documents posted online later than a certain cutoft date, or leverage extremely low-resource materials (Tanzer et al. 2024). Compared to realistic benchmarks, synthetic tasks are more flexible to control the setup (e.g., sequence length and task complexity) and less affected by parametric knowledge. Recent works have mostly focused on retrieval-based synthetic tasks(Kamradt. 2023: Mohtashami \& Jaggi, 2023: Li et al., 2023a Liu et al. 2024 c), with a few on other types of long-context usage, including various types of reasoning (Tay et al., 2021) and long-range discourse modeling (Sun et al., 2022).

## 3 The RULER Benchmark

RULER comprises tasks across four categories: retrieval, multi-hop tracing, aggregation, and question answering with all tasks configurable for varying length and complexity (see Table 2 ).

### 3.1 Retrieval: Needle-in-a-haystack (NIAH)

Recent works (Reid et al., 2024; Anthropic, 2023) commonly employ the needle-in-ahaystack (Kamradt [2023, NIAH) test to evaluate long-context modeling capability. The NIAH test is reminiscent of the extensively studied (Hopfield, 1982; Graves et al., 2014; Olsson et al. 2022: Arora et al., 2024) associative recall tasks, in which relevant intormation needs to be retrieved from context given a sufficient query. In RULER, we include multiple retrieval-based tasks, extending the vanilla NIAH test to evaluate models based on three criteria. Concretely, the retrieval capability should be (1) agnostic to the type of the "needle" and the "haystack", (2) strong enough to disregard hard distractors, and (3) of high recall when multiple items need to be retrieved. Based on these criteria, we develop four NIAH tasks. The "needle" in each of these tasks is a key-value pair inserted into the "haystack" (long distractor texts). The query is located at the end of the sequence and serves as a cue for matching the keys in the context and subsequently retrieving the associated values.

| Task | Configuration | Example |
| :---: | :---: | :---: |
| Single <br> NIAH <br> (S-NIAH) | type_key $=$ word <br> type_value $=$ number <br> type_haystack $=$ essay <br> size_haystack $\propto$ context length | (essays) <br> One of the special magic numbers for long-context is: $12345 . . . . .$. in the <br> What is the special magic number for long-context mentioned in the <br> provided text? <br> Answer: 12345 |
| Multi-keys <br> NIAH <br> (MK-NIAH) | num_keys $=2$ <br> type_key $=$ word <br> type_value $=$ number <br> type_haystack $=$ essay <br> size_haystack $\propto$ context length | (essays) th.. special magic numbers for long-context is: 12345. <br> One of the special magic numbers for large-model is: 54321 . <br> One of the spect <br> What is the special magic number for long-context mentioned in the <br> provided text? <br> Answer: 12345 |
| Multi-values <br> NIAH <br> (MV-NIAH) | num_values $=2$ <br> type_key $=$ word <br> type_value $=$ number <br> type_haystack $=$ essay <br> size_haystack $\propto$ context length | (essays) th. special magic numbers for long-context is: 12345. <br> One of the special magic numbers for long-context is: 54321. <br> One of the speciont <br> What are all the special magic numbers for long-context mentioned in the <br> provided text? <br> Answer: 1234554321 |
| Multi-queries <br> NIAH <br> (MQ-NIAH) | num_queries $=2$ <br> type_key $=$ word <br> type_value $=$ number <br> type_haystack $=$ essay <br> size_haystack $\propto$ context length | (essays) th. special magic numbers for long-context is: 12345. <br> One of the special magic numbers for large-model is: 54321 . <br> One of the special <br> What are all the special magic numbers for long-context and large-model <br> mentioned in the provided text? <br> Answer: 1234554321 |
| Variable <br> Tracking <br> (VT) | num_chains $=2$ <br> num_hops $=2$ <br> size_noises $\propto$ context length | ![](https://cdn.mathpix.com/cropped/2024_05_26_086a73dc0d9359f2aa47g-04.jpg?height=175&width=786&top_left_y=1063&top_left_x=956) |
| Common Words <br> Extraction <br> (CWE) | freq_cw $=2$, freq_ucw $=1$ <br> num_cw $=10$ <br> num_ucw $\propto$ context length | aaa bbb ccc aaa ddd eee ccc fff ggg hhh iii iii ..... <br> What are the 10 most common words in the above list? <br> Answer: aaa ccc iii...... |
| Frequent Words <br> Extraction <br> (FWE) | $\alpha=2$ <br> num_word $\propto$ context length | aaa bbb ccc aaa ddd eee ccc fff ggg aaa hhh aaa ccc iii iii. ..... <br> What are the 3 most frequently appeared words in the above coded text? <br> Answer: aaa ccc iii |
| Question <br> Answering <br> (QA) | dataset = SQuAD <br> num_document $\propto$ context length | Document 1: $\ldots . . . \mathrm{aaa} \ldots . . .$. <br> Document 2: $. . . . \mathrm{bbb} \ldots . . .$. <br> Document 3: ......ccc..... <br> Question: question <br> Answer: bbb |

Table 2: Task examples with flexible configurations in RULER. We use different colors to highlight queries, keys, values, and distractors in our examples.

- Single NIAH (S-NIAH): This is the vanilla NIAH test where a single "needle' ${ }^{2}$ needs to be retrieved from the "haystack". The query/key/value can take the form of words, numbers ( 7 digits), or UUIDs ( 32 digits). The "haystack" can be repeated noise sentences ${ }^{3}$ or Paul Graham essays (Kamradt, 2023).
- Multi-keys NIAH (MK-NIAH): Multiple "needles" are inserted into the "haystack", and only one of them needs to be retrieved. The additional "needles" are hard distractors. The most challenging setting is a version where the "haystack" is filled with distractor needles.
- Multi-values NIAH (MV-NIAH): Multiple "needles" sharing the same key are inserted into the "haystack". All values associated with the same key need to be retrieved.
- Multi-queries NIAH (MQ-NIAH): Multiple "needles" are inserted into the "haystack". All "needles" with distinct keys need to be retrieved. This is the same multi-query associative recall task setup used by Arora et al. (2024). Together with MV-NIAH, these two tasks evaluate the retrieval capability without missing any critical information.[^1]![](https://cdn.mathpix.com/cropped/2024_05_26_086a73dc0d9359f2aa47g-05.jpg?height=264&width=1094&top_left_y=290&top_left_x=512)

Figure 1: In aggregation tasks, we sample words from a vocabulary following the two distributions above. The common words extraction (CWE) samples from uniform distributions. In the frequent words extraction (FWE), the frequency of each word is determined by its rank in the vocabulary and the parameter $\alpha$ of Zeta distribution.

### 3.2 Multi-hop Tracing: Variable Tracking (VT)

Effective discourse comprehension (van Dijk \& Kintsch, 1983) is contingent upon successful recognition of newly mentioned entities and establishing the chain of references co-referring to the same entity (Karttunen, 1969) throughout the long context. We develop a new task variable tracking to emulate a minimal coreference chain resolution $(\mathrm{Ng}, 2010)$ task. This task checks the behavior of tracking relevant co-occurrence patterns and drawing skipped connections within long input. Specifically, a variable $X 1$ is initialized with a value $V$, followed by a linear chain of variable name binding statements (e.g., $X 2=X 1, X 3=X 2, \ldots$ ), which are inserted at various positions of the input. The objective is to return all variable names pointing to the same value $V$. The task complexity can be increased by adding more hops (i.e., the times of name binding) or more chains, similar to adding hard distractors in MK-NIAH.

### 3.3 Aggregation: Common Words (CWE) and Frequent Words Extraction (FWE)

In RULER, we introduce a new category as a proxy for summarization tasks where relevant information constitutes much larger portion of the context, and the target output depends on accurate aggregation of the relevant input. Concretely, we construct an input sequence by sampling words from a pre-defined (synthetic) word list. In the common word extraction task (CWE), words are sampled from discrete uniform distributions, with the number of common words fixed while the number of uncommon words increases with the sequence length. In the frequent words extraction task (FWE), words are sampled from Zeta distribution ${ }^{4}$ Figure 1 shows an illustration of word frequency in the constructed input. A model needs to return the top- $K$ frequent words in the context. In CWE, $K$ equals to the number of common words. In FWE, we set $K$ to 3, as increasing $K$ leads to poor performance even at small context sizes for most models. The task complexity can be adjusted by varying the number of common words or the parameter of Zeta distribution.

### 3.4 Question Answering (QA)

The majority of existing QA datasets (Rajpurkar et al., 2018; Yang et al., 2018; Trivedi et al., 2022) are designed to answer questions based on short passages. These datasets can be extended to simulate long-context input by adding distracting information. In this task category, we insert the golden paragraphs (i.e., the paragraphs that contain answers) into paragraphs randomly sampled from the same dataset. This category is a real-world adaptation (Ivgi et al., 2023) of NIAH, where the question serves as the query, the golden paragraphs are the "needles", and the distracting paragraphs form the "haystack".[^2]

| Models | Claimed <br> Length | Effective <br> Length | $4 \mathbf{k}$ | $8 \mathbf{k}$ | 16k | $32 \mathbf{k}$ | $64 k$ | 128k | Avg. | wAvg. <br> (inc) | wAvg. <br> (dec) |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| Llama2-7B (chat) | $4 \mathrm{k}$ | - | 85.6 |  |  |  |  |  |  |  |  |
| GPT-4 | $128 \mathrm{k}$ | $64 \mathrm{k}$ | 96.6 | 96.3 | 95.2 | 93.2 | $\underline{87.0}$ | 81.2 | 91.6 | $89.0_{(1 \mathrm{st})}$ | $94.1_{(1 \mathrm{st})}$ |
| Command-R (35B) | $128 \mathrm{k}$ | $32 \mathrm{k}$ | $\overline{93.8}$ | $\overline{93.3}$ | $\overline{92.4}$ | $\overline{89.5}$ | $\overline{84.9}$ | 76.0 | 88.3 | $85.5_{(2 \mathrm{nd})}$ | $91.1_{(2 n d)}$ |
| Yi (34B) | $200 \mathrm{k}$ | $32 \mathrm{k}$ | 93.3 | 92.2 | $\overline{91.3}$ | $\underline{87.5}$ | 83.2 | 77.3 | 87.5 | $84.8_{(3 \mathrm{th})}$ | $90.1_{(3 \mathrm{th})}$ |
| Mixtral (8x7B) | $32 \mathrm{k}$ | $32 \mathrm{k}$ | 94.9 | 92.1 | 92.5 | $\underline{85.9}$ | 72.4 | 44.5 | 80.4 | $72.8_{(4 \mathrm{th})}$ | $87.9_{(4 \text { th })}$ |
| Mistral (7B) | $32 \mathrm{k}$ | $16 \mathrm{k}$ | $\overline{93.6}$ | $\overline{91.2}$ | $\overline{87.2}$ | $\overline{75.4}$ | 49.0 | 13.8 | 68.4 | $55.6_{(7 \mathrm{th})}$ | $81.2_{\text {(5th) }}$ |
| ChatGLM (6B) | $128 \mathrm{k}$ | $4 \mathrm{k}$ | $\underline{87.8}$ | $\overline{83.4}$ | 78.6 | 69.9 | 56.0 | 42.0 | 69.6 | $62.0_{(6 \mathrm{th})}$ | $77.2_{\text {(6th) }}$ |
| LWM (7B) | $1 \mathrm{M}$ | $<4 \mathrm{k}$ | $\overline{82.3}$ | 78.4 | 73.7 | 69.1 | 68.1 | 65.0 | 72.8 | $69.9_{(5 \mathrm{th})}$ | $75.7_{(7 \mathrm{th})}$ |
| Together (7B) | $32 \mathrm{k}$ | $4 \mathrm{k}$ | $\underline{88.2}$ | 81.1 | 69.4 | 63.0 | 0.0 | 0.0 | 50.3 | $33.8_{(8 \mathrm{th})}$ | $66.7_{(8 \mathrm{th})}$ |
| LongChat (7B) | $32 \mathrm{k}$ | $<4 \mathrm{k}$ | $\overline{84.7}$ | 79.9 | 70.8 | 59.3 | 0.0 | 0.0 | 49.1 | $33.1_{(9 \mathrm{th})}$ | $65.2_{\text {(9th) }}$ |
| LongAlpaca (13B) | $32 \mathrm{k}$ | $<4 \mathrm{k}$ | 60.6 | 57.0 | 56.6 | 43.6 | 0.0 | 0.0 | 36.3 | $24.7_{\text {(10th) }}^{\text {(1) }}$ | $47.9_{(10 \text { th })}^{(}$ |

Table 3: Long Context Performance (\%) of selected models evaluated at length from $4 \mathrm{k}$ to $128 \mathrm{k}$. Each score is computed by averaging accuracy of 13 tasks in RULER. The performance exceeding the Llama2-7B performance at $4 \mathrm{~K}(85.6 \%)$ is underlined. The effective context length is the maximum length passing this threshold. Weighted average score (wAvg.) aggregates performance across all context sizes, with the weights linearly increasing (inc) or decreasing (dec) to simulate length distribution of real-world usage. We put the rank of each model in the subscript. More details about the selected models are in Appendix A.

## 4 Experiments \& Results

Models \& Inference setup We select 10 long-context LLMs, including 9 open-source models and one closed-source model (GPT-4), covering diverse model sizes (6B to $8 \times 7 \mathrm{~B}$ with MoE architecture) and claimed context lengths ( $32 \mathrm{k}$ to 1M). Complete information about these models is included in Appendix A. We evaluate all models using vLLM (Kwon et al. 2023), an LLM serving system with efficient KV cache memory management. For all models, we run the inference in BFloat16 on 8 NVIDIA A100 GPUs with greedy decoding.

Task configurations We test all models on 13 tasks ranging diverse complexities from the four categories of RULER. The test configurations have been selected (shown in Appendix B) based on a task correlational study described in Appendix C. For each task, we evaluate each model with 500 examples generated for each length from the series $(4 k, 8 k, 16 k, 32 k$, $64 \mathrm{k}, 128 \mathrm{k})$, while complying with each model's necessary chat template ${ }^{5}$ To prevent the model from refusing to answer a query or generating explanations, we append the task input with an answer prefix and check the presence of the target output with recall-based accuracy.

Effective Context Size We notice large performance degradation in all models as we increase input length in RULER. To determine the maximum context size a model can effectively handle, we grade each model with a fixed threshold, passing which indicates satisfactory performance at the length of evaluation. We use the performance of Llama2-7b model at the $4 \mathrm{~K}$ context length as the threshold. We report in Table 3 the maximum length exceeding the threshold as the "effective length" along with the "claimed length".

Model Ranking Criteria While the threshold-based grading reveals the discrepancy between claimed and effective length, it lacks details for fine-grained model comparisons. As such, we use a weighted average score to aggregate model performance across various context sizes. We rank models under two weighting schemes: wAvg. (inc) and wAvg. (dec) where the weight linearly increases and decreases with sequence length respectively. Ideally, the weight for each length should be determined by the length distribution of model usage, here we choose the two schemes to simulate the scenarios where longer sequences (inc) or shorter sequences (dec) dominate the distribution.[^3]

Main Results We include the results of ten long-context LMs in comparison with the Llama2-7B baseline in Table $3^{36}$ The performance at a certain length is the average of all 13 tasks in RULER. While these models all claim effective context of $32 \mathrm{~K}$ tokens or greater, none of them maintains performance above the Llama2-7B baseline at their claimed length, except for Mixtral, which achieves moderate performance on length doubling the claimed $32 \mathrm{~K}$ context size. Despite achieving nearly perfect performance on the passkey retrieval and the vanilla NIAH task (shown in Appendix E), all models exhibit large degradation in RULER as sequence length increases. The best performant model on RULER is GPT-4, which has the highest performance at length of $4 \mathrm{k}$ and demonstrates the least but non-marginal degradation (15.4) when extending the context to $128 \mathrm{~K}$. The top three ranked open-source models, Command-R, Yi-34B and Mixtral, all use a large base frequency in RoPE and are larger in parameter size than other models. Despite having been trained with context size of $1 \mathrm{M}$, the LWM performs worse than Llama2-7B even at $4 \mathrm{~K}$. However, it shows smaller degradation with the increase of context size, therefore achieves higher rank than Mistral-7B when longer sequences receive larger weight (wAvg. inc). This result suggests a trade-off in evaluation between absolute performance on short sequences and the relative degradation with the scaling of context size.

## 5 Task Error Analysis

We evaluate Yi-34B-200K, the 2nd best open-source model on RuLER, with increased input lengths (up to $256 \mathrm{~K}$ ) on more complex tasks to understand the effect of task configurations and failure modes on RULER.

Non-robustness to "needle" types. Figure 2(left) shows that while Yi achieves almost perfect performance when using needle of word-number pair in the standard passkey retrieval and vanilla NIAH, performance degrades when the needle takes other forms. We observe the largest degradation in the task of retrieving UUIDs, for which Yi sometimes fail to return the complete 32 digits given long ( $>128 \mathrm{~K}$ ) input context.

Failure to ignore distractors. Figure 2 (middle-left) shows that increasing the number of distracting needles steadily lowers performance, with Yi dropping by $\sim 40$ points at $256 \mathrm{~K}$ in the extreme version, where the context is full of irrelevant needles (\#K=FULL). Error analysis reveals that Yi fails to effectively ignore the hard distractors given long input context, thus incorrectly retrieves values associated with the distractor keys. In the extreme version, Yi often returns values from the vicinity of the target, suggesting coarse match of the range but the lack of precision to locate the key when the target is in-distribution of the noises.

Return incomplete information. Consistent with previous works (Liu et al. 2024a Reid et al. 2024), we notice significant degradation in performance when the model needs to retrieve multiple items from a long input. For instance, increasing the number of queries from 1 to 8 drops the performance by $\sim 15$ points (Figure 2 right). When the model needs to retrieve multiple values associated with the same key (Figure 2 middle-right), Yi often outputs duplicated answers without returning the complete set of values, implying uneven associations between the key and each of its values.

Tendency to copy from context. We notice that Yi has a strong tendency to copy from context verbatim when scaling the input length. This tendency is most notable in variable tracking (VT) and common words extraction (CWE) where we include one in-context demonstration at the beginning of the sequence. Over $80 \%$ of Yi's output in the CWE task at $128 \mathrm{~K}$ is simply a string copied from the one-shot example, whereas the copying is nonexistent for short sequences. ㄱ This copying behavior is also present in the LWM model and LongAlpaca, however it is less prevalent in other models, such as Mixtral. This finding further reinforces the need to test behaviors other than retrieval given long input context.[^4]![](https://cdn.mathpix.com/cropped/2024_05_26_086a73dc0d9359f2aa47g-08.jpg?height=340&width=1328&top_left_y=281&top_left_x=388)

Figure 2: Performance of Yi-34B in the needle-in-a-haystack (NIAH) tasks. By default, we use word-number as the key-value pair and Paul Graham essays as the haystack. Yi is not robust to the change of needle types and degrades with the increasing amount of distractors. (W: words; N: numbers; U: UUIDs; Full: entire haystack).
![](https://cdn.mathpix.com/cropped/2024_05_26_086a73dc0d9359f2aa47g-08.jpg?height=348&width=1330&top_left_y=866&top_left_x=386)

Figure 3: Performance of Yi-34B in variable tracking (VT), frequent words extraction (FWE), and QA tasks across different task complexities. Yi shows large degradation and distinct trends with scaled context size in these non-retrieval tasks, demonstrating the need to evaluate behavior beyond retrieval from context.

Unreliable tracking within context. For the variable tracking task, both adding more chains and more hops contribute to large degradation in Yi's performance. Yi consistently degrades in the more-hops setting as we increase context size (Figure 3left), whereas the degradation in the more-chains setting is most significant for lengths greater than 128K (Figure 3 middleleft). Besides the aforementioned copying issue, Yi makes errors due to incorrectly returning empty strings or variables from other chains, implying a lack of ability to reliably trace the same entity within long context. These errors are also frequently observed in models that do not exhibit the copying behavior.

Failure to accurately aggregate. We observe two common failure modes in aggregation tasks: incorrect use of parametric knowledge and inaccurate aggregation. Models that do not exhibit the copying issue in the CWE task, sometimes ignore the contextual information and instead use parametric knowledge to answer the query, especially at large context sizes. For instance, Mistral (7b-instruct-v0.2) returns high frequency words, such as "the", "an", "a", as output without counting the words in context. For the FWE task which demonstrates less the copying issue, Yi fails to correctly output the top frequent words as we decrease the $\alpha$ in Zeta distribution (Figure 3 middle-right). Decreasing $\alpha$ leads to smaller difference in frequency among words, increasing the difficulty to distinguish the top-frequent words.

Frequent hallucination in long-context QA. For the QA tasks, Yi's performance approaches its no-context baseline as we extend the context with distracting paragraphs (Figure 3 right). The degradation stems primarily from hallucination and reduced reliance on contextual information. We notice that, at large context sizes, model predictions sometimes are irrelevant to the question and can coincide with the answers of its no-context baseline. The overall worse performance in QA tasks confirms that the fuzzy matching between a query and a relevant paragraph in long context is a more challenging setting than the simplistic NIAH tests, where keys can be exactly located in context.
![](https://cdn.mathpix.com/cropped/2024_05_26_086a73dc0d9359f2aa47g-09.jpg?height=340&width=1348&top_left_y=281&top_left_x=388)

Figure 4: (Left \& middle left): Comparison of LargeWorldModel (LWM) series trained up to various context sizes with fixed parameter size of 7B. (Middle right): Comparison of Yi suite models with different parameter sizes with controlled training context length of 200K. (Right): Performance of non-Transformer architectures lags behind the Transformer baseline Llama2-7B by large margin. Length extrapolation is presented with dashed lines.

## 6 Model Analysis

Effect of training context length. Do models trained with larger context sizes perform better on RULER? We evaluate the suite of LargeWorldModels (Liu et al., 2024a, LWM) of equal parameter size and trained up to various context lengths. Figure 4 (left \& middle-left) shows that larger context sizes overall lead to better performance, but the ranking can be inconsistent for long sequences. For instance, the model trained with $1 \mathrm{M}$ context size (LWM-1M) is worse than the one with $512 \mathrm{~K}$ at length of $256 \mathrm{~K}$, likely due to insufficient training for adjusting to the new base frequency in RoPE. Moreover, we observe abrupt performance drops when models need to extrapolate to unseen lengths (e.g., LMW-128K given input of $256 \mathrm{~K}$ ), and almost linear degradation with input length on log scale within the max training context size.

Effect of model size The top models in our main results are much larger than other models. To ablate the effect of model size, we evaluate Yi-34B-200k, Yi-9B-200k, and Yi-6B-200k, all trained up to the same context length using the same data blend. Figure 4 (middle-right) shows that the 34B model is significantly better than the 6B model on RULER for both performance at length of $4 \mathrm{~K}$ and the relative degradation, suggesting the benefit of scaling model sizes for better long-context modeling.

Effect of architecture We evaluate the effective context length for two models with nonTransformer architectures: RWKV-v5 (Peng et al., 2023) and Mamba-2.8B-slimpj (Gu \& Dao, 2023). We find that both models demonstrate significant degradation when extending context size to $8 \mathrm{~K}$, and both underperform the Transformer baseline Llama2-7B by large margins up till the length of $4 \mathrm{~K}$, beyond which Llama2 shows poor length extrapolation performance (Figure 4 right).

## 7 Conclusion

We present RULER, a synthetic benchmark for evaluating long-context language models. RULER contains diverse task categories, retrieval, multi-hop tracing, aggregation and question answering, providing a flexible and comprehensive evaluation of LLM's long-context capabilities. We benchmark ten long-context LMs using RULER with context sizes ranging from $4 \mathrm{~K}$ to $128 \mathrm{~K}$. Despite achieving perfect results in the widely used needle-in-a-haystack test, all models fail to maintain their performance in other tasks of RULER as we increase input length. We observe common failure modes at large context sizes, including the failure to ignore distractors and ineffective utilization of long context (e.g., simply copy from context or use parametric knowledge instead). We show that RULER is challenging for even the top-ranked open-source models as we increase task complexity. Our analysis further reveals the large potential for improvement on RULER and the benefit of scaling model sizes in achieving better long context capabilities.

## References

AI21. Introducing jamba: Ai21's groundbreaking ssm-transformer model, 2024. URL https://www.ai21.com/blog/announcing-jamba.

Chenxin An, Shansan Gong, Ming Zhong, Mukai Li, Jun Zhang, Lingpeng Kong, and Xipeng Qiu. L-eval: Instituting standardized evaluation for long context language models. In ICLR, 2024.

Anthropic. Long context prompting for Claude 2.1. Blog, 2023. URL https://www anthropic.com/index/claude-2-1-prompting.

Anthropic. Introducing the next generation of claude, 2024. URLhttps://www. anthropic. com/news/claude-3-family.

Simran Arora, Sabri Eyuboglu, Aman Timalsina, Isys Johnson, Michael Poli, James Zou, Atri Rudra, and Christopher Ré. Zoology: Measuring and improving recall in efficient language models. In ICLR, 2024.

Yushi Bai et al. LongBench: A bilingual, multitask benchmark for long context understanding. arXiv:2308.14508, 2023.

Aydar Bulatov, Yuri Kuratov, and Mikhail S Burtsev. Scaling Transformer to 1M tokens and beyond with RMT. arXiv:2304.11062, 2023.

David Castillo, Joseph Davidson, Finlay Gray, José Solorzano, and Marek Rosa. Introducing GoodAI LTM benchmark. Blog, 2024. URL https://www.goodai.com/ introducing-goodai-ltm-benchmark/

Shouyuan Chen, Sherman Wong, Liangjian Chen, and Yuandong Tian. Extending context window of large language models via positional interpolation. In ICLR, 2023.

Yukang Chen, Shengju Qian, Haotian Tang, Xin Lai, Zhijian Liu, Song Han, and Jiaya Jia. LongLoRA: Efficient fine-tuning of long-context large language models. In ICLR, 2024.

Rewon Child, Scott Gray, Alec Radford, and Ilya Sutskever. Generating long sequences with sparse Transformers. arXiv:1904.10509, 2019.

Cohere. Command r, 2024. URL https://docs.cohere.com/docs/command-r\# model-details

Tri Dao. FlashAttention-2: Faster attention with better parallelism and work partitioning. arxiv:2307.08691, 2023.

Tri Dao, Daniel Y. Fu, Stefano Ermon, Atri Rudra, and Christopher Ré. FlashAttention: Fast and memory-efficient exact attention with IO-awareness. In NeurIPS, 2022.

Jiayu Ding et al. LongNet: Scaling Transformers to 1,000,000,000 tokens. arXiv:2307.02486, 2023.

Yiran Ding et al. LongRoPE: Extending LLM context window beyond 2 million tokens. arXiv:2402.13753, 2024.

Zican Dong, Tianyi Tang, Junyi Li, Wayne Xin Zhao, and Ji-Rong Wen. Bamboo: A comprehensive benchmark for evaluating long text modeling capacities of large language models. arXiv:2309.13345, 2023.

Zhengxiao Du, Yujie Qian, Xiao Liu, Ming Ding, Jiezhong Qiu, Zhilin Yang, and Jie Tang. GLM: General language model pretraining with autoregressive blank infilling. In Proc of the 60th Annual Meeting of the ACL (Volume 1: Long Papers), pp. 320-335, 2022.

Daniel Y. Fu, Tri Dao, Khaled K. Saab, Armin W. Thomas, Atri Rudra, and Christopher Ré. Hungry Hungry Hippos: Towards language modeling with state space models. In ICLR, 2023a.

Daniel Y. Fu et al. Simple hardware-efficient long convolutions for sequence modeling. ICML, 2023b.

Yao Fu et al. Data engineering for scaling language models to 128k context. arXiv:2402.10171, 2024.

Alex Graves, Greg Wayne, and Ivo Danihelka. Neural Turing machines. arXiv:1410.5401, 2014.

Albert Gu and Tri Dao. Mamba: Linear-time sequence modeling with selective state spaces. arXiv:2312.00752, 2023.

Albert Gu, Karan Goel, and Christopher Re. Efficiently modeling long sequences with structured state spaces. In ICLR, 2022.

Chi Han, Qifan Wang, Wenhan Xiong, Yu Chen, Heng Ji, and Sinong Wang. Lm-infinite: Simple on-the-fly length generalization for large language models. arXiv:2308.16137, 2023.

John J. Hopfield. Neural networks and physical systems with emergent collective computational abilities. Proc of the National Academy of Sciences of the United States of America, 79 8: $2554-8,1982$.

Maor Ivgi, Uri Shaham, and Jonathan Berant. Efficient long-text understanding with shorttext models. Transactions of the $A C L, 11: 284-299,2023$.

Sam Ade Jacobs et al. DeepSpeed Ulysses: System optimizations for enabling training of extreme long sequence Transformer models. arXiv:2309.14509, 2023.

Sebastian Jaszczur et al. Sparse is enough in scaling transformers. In NeurIPS, 2021.

Albert Q Jiang et al. Mixtral of experts. arXiv:2401.04088, 2024.

Huiqiang Jiang et al. LongLlmLingua: Accelerating and enhancing LLMs in long context scenarios via prompt compression. arXiv:2310.06839, 2023.

Gregory Kamradt. Needle In A Haystack - pressure testing LLMs. Github, 2023. URL https://github.com/gkamradt/LLMTest_NeedleInAHaystack/tree/main

Lauri Karttunen. Discourse referents. In COLING, 1969.

George Kingsley Zipf. Selected studies of the principle of relative frequency in language. Harvard university press, 1932.

Woosuk Kwon et al. Efficient memory management for large language model serving with paged attention. In Proc. of the ACM SIGOPS 29th Symposium on Operating Systems Principles, 2023.

Dacheng Li, Rulin Shao, et al. How long can open-source LLMs truly promise on context length?, 2023a. URL https://1msys.org/blog/2023-06-29-1ongchat

Jiaqi Li, Mengmeng Wang, Zilong Zheng, and Muhan Zhang. Loogle: Can long-context language models understand long contexts? arXiv:2311.04939, 2023b.

Hao Liu, Matei Zaharia, and Pieter Abbeel. Ring attention with blockwise Transformers for near-infinite context. In $I C L R, 2023$.

Hao Liu, Wilson Yan, Matei Zaharia, and Pieter Abbeel. World model on million-length video and language with Ring Attention. arxiv:2402.08268, 2024a.

Jiaheng Liu et al. E2-LLM: Efficient and extreme length extension of large language models. arXiv:2401.06951, 2024b.

Nelson F Liu, Kevin Lin, John Hewitt, Ashwin Paranjape, Michele Bevilacqua, Fabio Petroni, and Percy Liang. Lost in the middle: How language models use long contexts. Transactions of the ACL, 12:157-173, 2024c.

Pedro Henrique Martins, Zita Marinho, and Andre Martins. $\infty$-former: Infinite memory Transformer. In Proc. of the 60th Annual Meeting of the ACL (Volume 1: Long Papers), 2022.

Mistral.AI. La plateforme, 2023. URL https://mistral.ai/news/la-plateforme/

Amirkeivan Mohtashami and Martin Jaggi. Landmark attention: Random-access infinite context length for Transformers. In Workshop on Efficient Systems for Foundation Models @ ICML, 2023.

Vincent Ng. Supervised noun phrase coreference research: The first fifteen years. In Proc. of the 48th Annual Meeting of the ACL, 2010.

Catherine Olsson et al. In-context learning and induction heads. Transformer Circuits Thread, 2022. https://transformer-circuits.pub/2022/in-context-learning-and-inductionheads/index.html.

OpenAI: Josh Achiam et al. GPT-4 technical report. arXiv:2303.08774, 2023.

Bo Peng et al. RWKV: Reinventing RNNs for the transformer era. In EMNLP, 2023.

Bowen Peng, Jeffrey Quesnelle, Honglu Fan, and Enrico Shippole. YaRN: Efficient context window extension of large language models. In ICLR, 2024.

Michael Poli, Stefano Massaroli, Eric Nguyen, Daniel Y Fu, Tri Dao, Stephen Baccus, Yoshua Bengio, Stefano Ermon, and Christopher Ré. Hyena hierarchy: Towards larger convolutional language models. In ICML, 2023.

Ofir Press, Noah Smith, and Mike Lewis. Train short, test long: Attention with linear biases enables input length extrapolation. In ICLR, 2022.

Pranav Rajpurkar, Robin Jia, and Percy Liang. Know what you don't know: Unanswerable questions for SQuAD. In Proc. of the 56th Annual Meeting of the ACL (Volume 2: Short Papers), 2018.

Machel Reid et al. Gemini 1.5: Unlocking multimodal understanding across millions of tokens of context. arXiv:2403.05530, 2024.

Marco Tulio Ribeiro, Tongshuang Wu, Carlos Guestrin, and Sameer Singh. Beyond accuracy: Behavioral testing of NLP models with CheckList. In Proc. of the 58th Annual Meeting of the ACL, 2020.

Uri Shaham, Maor Ivgi, Avia Efrat, Jonathan Berant, and Omer Levy. ZeroSCROLLS: A zero-shot benchmark for long text understanding. In EMNLP, 2023.

Jianlin Su, Yu Lu, Shengfeng Pan, Ahmed Murtadha, Bo Wen, and Yunfeng Liu. RoFormer: Enhanced Transformer with rotary position embedding. arXiv:2104.09864, 2023.

Simeng Sun, Katherine Thai, and Mohit Iyyer. ChapterBreak: A challenge dataset for long-range language models. In Proc. of the 2022 Conference of the North American Chapter of the ACL: Human Language Technologies, 2022.

Yutao Sun, Li Dong, Shaohan Huang, Shuming Ma, Yuqing Xia, Jilong Xue, Jianyong Wang, and Furu Wei. Retentive network: A successor to Transformer for large language models. arXiv:2307.08621, 2023a.

Yutao Sun, Li Dong, Barun Patra, Shuming Ma, Shaohan Huang, Alon Benhaim, Vishrav Chaudhary, Xia Song, and Furu Wei. A length-extrapolatable Transformer. In Proc. of the 61st Annual Meeting of the ACL (Volume 1: Long Papers), 2023b.

Garrett Tanzer, Mirac Suzgun, Eline Visser, Dan Jurafsky, and Luke Melas-Kyriazi. A benchmark for learning to translate a new language from one grammar book. In ICLR, 2024.

Yi Tay et al. Long Range Arena: A benchmark for efficient Transformers. In ICLR, 2021.

Together.AI. Preparing for the era of 32k context: Early learnings and explorations, 2023a. URLhttps://www.together.ai/blog/llama-2-7b-32k

Together.AI. Llama-2-7b-32k-instruct - and fine-tuning for llama-2 models with together api, 2023b. URL https://www.together. ai/blog/1lama-2-7b-32k-instruct.

Hugo Touvron et al. Llama 2: Open foundation and fine-tuned chat models. arXiv:2307.09288, 2023.

Harsh Trivedi, Niranjan Balasubramanian, Tushar Khot, and Ashish Sabharwal. Musique: Multihop questions via single-hop question composition. Transactions of the $A C L, 10$ : $539-554,2022$.

Szymon Tworkowski et al. Focused Transformer: Contrastive training for context scaling. NeurIPS, 36, 2024.

Teun A. van Dijk and Walter Kintsch. Strategies of discourse comprehension. In Academic Press, 1983.

Ashish Vaswani, Noam Shazeer, Niki Parmar, Jakob Uszkoreit, Llion Jones, Aidan N Gomez, Ł ukasz Kaiser, and Illia Polosukhin. Attention is all you need. In NeurIPS, 2017.

Weizhi Wang, Li Dong, Hao Cheng, Xiaodong Liu, Xifeng Yan, Jianfeng Gao, and Furu Wei. Augmenting language models with long-term memory. NeurIPS, 36, 2024.

Thomas Wolf et al. Huggingface's Transformers: State-of-the-art natural language processing. arXiv:1910.03771, 2019.

Qingyang Wu, Zhenzhong Lan, Kun Qian, Jing Gu, Alborz Geramifard, and Zhou Yu. Memformer: A memory-augmented Transformer for sequence modeling. In Findings of the ACL: AACL-IJCNLP, 2022.

X.AI. Announcing grok-1.5, 2024. URL/https://x.ai/blog/grok-1.5

Chaojun Xiao et al. InfLLM: Unveiling the intrinsic capacity of LLMs for understanding extremely long sequences with training-free memory. arXiv:2402.04617, 2024a.

Guangxuan Xiao, Yuandong Tian, Beidi Chen, Song Han, and Mike Lewis. Efficient streaming language models with attention sinks. In ICLR, $2024 \mathrm{~b}$.

Wenhan Xiong et al. Effective long-context scaling of foundation models. arXiv:2309.16039, 2023.

Peng Xu, Wei Ping, Xianchao Wu, Lawrence McAfee, Chen Zhu, Zihan Liu, Sandeep Subramanian, Evelina Bakhturina, Mohammad Shoeybi, and Bryan Catanzaro. Retrieval meets long context large language models. In ICLR, 2024.

Zhilin Yang, Peng Qi, Saizheng Zhang, Yoshua Bengio, William Cohen, Ruslan Salakhutdinov, and Christopher D. Manning. HotpotQA: A dataset for diverse, explainable multi-hop question answering. In $E M N L P, 2018$.

Alex Young et al. Yi: Open foundation models by 01.AI. arXiv:2403.04652, 2024.

Peitian Zhang, Zheng Liu, Shitao Xiao, Ninglu Shao, Qiwei Ye, and Zhicheng Dou. Soaring from $4 \mathrm{k}$ to 400k: Extending LLM's context with activation beacon. arXiv:2401.03462, $2024 a$.

Xinrong Zhang, Yingfa Chen, Shengding Hu, Zihang Xu, Junhao Chen, Moo Khai Hao, Xu Han, Zhen Leng Thai, Shuo Wang, Zhiyuan Liu, and Maosong Sun. $\infty$ bench: Extending long context evaluation beyond 100k tokens. arXiv:2402.13718, 2024b.

Dawei Zhu, Nan Yang, Liang Wang, Yifan Song, Wenhao Wu, Furu Wei, and Sujian Li. PoSE: Efficient context window extension of LLMs via positional skip-wise training. In ICLR, 2024.
