# The unreasonable effectiveness of optimal transport in economics 

submitted to the proceeding of the 2020 World<br>Congress of the Econometric Society

Alfred Galichon*

July 13,2021

This paper is dedicated to the memory of Emmanuel Farhi (1978-2020).

## 1 Introduction

The mathematical theory of optimal transport traces back to Monge in the 18th century, who asked the main questions, for which he provided deep insights but left them unresolved. Regarded as a famous open problem throughout the 19th century, it was revived, and finally solved, with the advent of linear programming and works by Kantorovich, Koopmans, von Neumann, Dantzig and others in the mid 20th century. While the theory[^0]partly arose out of economic motivations (specifically resource allocation problems), it soon drifted away from economics. A second revival has occured since the 1990s, when insights from convex analysis were introduced by Brenier, Rachev, and Rüschendorf, and from geometry by Gangbo, McCann, Villani and others.

In spite of this, up until recently, optimal transport has still been reported missing from the standard toolbox of quantitative economics. However, it turns out that many basic problems encountered in diverse economic applications in various fields are optimal transport problems in disguise. Beyond intellectual curiosity, understanding this connection is useful to make use of the mature set of results of optimal transport to solve the problems, and in particular, to deal with questions of existence, uniqueness, stability, and computation without reinventing the wheel.

This paper is a rapid overview of some of these connections, and some extensions. It is admittedly skewed toward my own work, and borrows much material from my 2016 monograph, Optimal Transport Methods in Economics, to which the reader is referred for details. I cover much of the material from an empirical perspective every winter in the January edition of my 'math+econ+code' masterclasses (www.math-econ-code.org). In mathematics, a useful read is Santambrogio's Optimal Transport for Applied Mathematicians 2015, or Villani's 2003 introductory lecture notes Topics in Optimal Transportation. For computational aspects, Peyré and Cuturi's Computational Optimal Transport is a useful complement. Villani's 2009 treatise Optimal Transport: Old and New remains the most exhaustive reference on the topic.

## 2 Optimal transport in a nutshell

### 2.1 Optimal transport duality

Let us describe the optimal transport problem in the discrete case. Assume a central planner needs to match a population of workers, each of whom is characterized by their type $x \in \mathcal{X}$, with a population of firms, each of whom with type $y \in \mathcal{Y}$. A match between a worker of type $x$ and a firm of type $y$ produces output $\Phi_{x y}$, called transport surplus. The set of types $\mathcal{X}$ and $\mathcal{Y}$ are finite, and the total number of workers and firms are identical. We denote by $\left(p_{x}\right)$ and $\left(q_{y}\right)$ the vectors of probability distribution over $\mathcal{X}$ and $\mathcal{Y}$, thus normalizing the total mass of workers and firms to one: $\sum_{x \in \mathcal{X}} p_{x}=$ $\sum_{y \in \mathcal{Y}} q_{y}=1$.

The central planner's problem is to form a matching, and therefore, to decide on the mass $\pi_{x y}$ of pairs $x y$ to form. In the sequel, we shall call $\pi_{x y}$ the optimal transport plan. This quantity must match everyone, namely satisfy the double set of constraints that all workers of each type $x$ are assigned, $\sum_{y \in \mathcal{Y}} \pi_{x y}=p_{x}$, and that all firms of type $y$ are assigned, namely $\sum_{x \in \mathcal{X}} \pi_{x y}=q_{y}$. With these constraints in mind, the workers shall maximize total output, which is $\sum_{x \in \mathcal{X}, y \in \mathcal{Y}} \pi_{x y} \Phi_{x y}$ the sum of the pairwise output weighted by the mass of each pair. This yields the problem

$$
\begin{align*}
\max _{\pi \geq 0} & \sum_{x \in \mathcal{X}, y \in \mathcal{Y}} \pi_{x y} \Phi_{x y}  \tag{1}\\
\text { s.t. } & \left\{\begin{array}{l}
\sum_{y \in \mathcal{Y}} \pi_{x y}=p_{x} \forall x \in \mathcal{X} \\
\sum_{x \in \mathcal{X}} \pi_{x y}=q_{y} \forall y \in \mathcal{Y}
\end{array}\right.
\end{align*}
$$

which is clearly a linear programming problem, which we shall call the primal problem. Note that the set of $\pi$ satisfying the constraints is clearly nonempty, as the random matching obtained by $\pi_{x y}=p_{x} q_{y}$ does satisfy the constraints. However, this matching is not optimal in general.

It is a basic result in linear programming that in this case, the value of the primal problem coincides with the value of the dual problem, which is

$$
\begin{align*}
& \min _{u, v} \sum_{x \in \mathcal{X}} p_{x} u_{x}+\sum_{y \in \mathcal{Y}} q_{y} v_{y}  \tag{2}\\
& \text { s.t. } u_{x}+v_{y} \geq \Phi_{x y} \forall x \in \mathcal{X}, y \in \mathcal{Y}
\end{align*}
$$

where the dual variables $u_{x}$ and $v_{y}$ are the Lagrange multipliers respectively associated with the primal constraints $\sum_{y \in \mathcal{Y}} \pi_{x y}=p_{x}$ and $\sum_{x \in \mathcal{X}} \pi_{x y}=q_{y}$, while the primal variables $\pi_{x y} \geq 0$ serve as Lagrange multipliers associated with the dual constraints $u_{x}+v_{y} \geq \Phi_{x y}$.

Lastly, another important result in linear programming, complementary slackness, asserts that $\pi_{x y}>0 \Longrightarrow u_{x}+v_{y}=\Phi_{x y}$ : if a Lagrange multiplier is strictly positive, then the corresponding dual constraint is saturated.

Optimal transport is a far-reaching generalization of the finite-dimensional duality discussed above to the case when $\mathcal{X}$ and $\mathcal{Y}$ are much richer sets; in particular the theory applies to the case when $\mathcal{X}$ and $\mathcal{Y}$ are finite-dimensional vector spaces, and we will not need more for most of the economic applications we will discuss. In that case, letting $P$ and $Q$ be probability distributions over $\mathcal{X}$ and $\mathcal{Y}$, we shall define $\mathcal{M}(P, Q)$ as the set of joint probability distributions over $\mathcal{X} \times \mathcal{Y}$ with margins $P$ and $Q$, which is the set of joint
probability distributions $\pi$ such that if $(X, Y) \sim \pi$, where $\sim$ is understood as "distributed as," then $X \sim P$ and $Y \sim Q$. In this more general setting, the primal problem (1) extends to

$$
\begin{equation*}
\max _{\pi \in \mathcal{M}(P, Q)} \int_{\mathcal{X} \times \mathcal{Y}} \Phi(x, y) d \pi(x, y) \tag{3}
\end{equation*}
$$

while its dual, extending (2), is

$$
\begin{array}{ll}
\min _{u, v} & \int_{\mathcal{X}} u(x) d P(x)+\int_{\mathcal{Y}} v(y) d Q(y)  \tag{4}\\
\text { s.t. } & u(x)+v(y) \geq \Phi(x, y)
\end{array}
$$

The Monge-Kantorovich theorem provides assumptions under which the former duality results are preserved in more general settings, that is: (i) there exist primal solutions $\left(\pi_{x y}\right)$; (ii) there is no duality gap, that is, the value of the dual problem (4) coincides with the value of the primal (3); and (iii) there exist dual solutions $\left(u_{x}\right)$ and $\left(v_{y}\right)$.

### 2.2 Some variants

### 2.2.1 Entropy regularized Optimal Transport

To facilitate computation, consider the previous primal problem with an entropic regularization in the objective function. Take $\sigma>0$ a parameter
that can be made arbitrarily small. The primal problem

$$
\begin{align*}
& \max _{\pi \geq 0} \sum_{x, y} \pi_{x y} \Phi_{x y}-\sigma \sum_{x, y} \pi_{x y} \ln \pi_{x y}  \tag{5}\\
& \text { s.t. }\left\{\begin{array}{l}
\sum_{y} \pi_{x y}=p_{x} \\
\sum_{x} \pi_{x y}=q_{y}
\end{array}\right.
\end{align*}
$$

has dual

$$
\begin{equation*}
\min _{u, v}\left\{\sum_{x \in \mathcal{X}} p_{x} u_{x}+\sum_{y \in \mathcal{Y}} q_{y} v_{y}+\sigma \sum_{x, y} \exp \left(\frac{\Phi_{x y}-u_{x}-v_{y}}{\sigma}\right)-\sigma\right\} \tag{6}
\end{equation*}
$$

and the optimal $\pi$ in (5) and the optimal $(u, v)$ in (6) are related by

$$
\begin{equation*}
\pi_{x y}=\exp \left(\frac{\Phi_{x y}-u_{x}-v_{y}}{\sigma}\right) \tag{7}
\end{equation*}
$$

Again, this problem has extension to the case where $\mathcal{X}$ and $\mathcal{Y}$ are no longer discrete sets: this is the theory of Bernstein-Schrödinger systems, surveyed in Léonard (2014). Recently, progresses have been made on the computation of this problem in particular through coordinate descent:

Starting at $t=0$ with an initial estimate of $v_{y}^{t}$ :

- Compute $\left(u_{x}^{t+1}\right)$ in order to minimize the objective function in (6), while keeping $v=\left(v_{y}^{t}\right)$ fixed.
- Compute $\left(v_{y}^{t+1}\right)$ in order to minimize the objective function in (6), while keeping $u=\left(u_{x}^{t+1}\right)$ fixed.
- Iterate over $t$, until the update to the $u$ 's and the $v$ 's are below toler-
ance.

It is easy to see that both steps are explicit and one full iteration of the algorithm expresses as

$$
\left\{\begin{array}{l}
u_{x}^{t+1}=\sigma \log \left(\frac{1}{p_{x}} \sum_{y \in \mathcal{Y}} \exp \left(\frac{\Phi_{x y}-v_{y}^{t}}{\sigma}\right)\right)  \tag{8}\\
v_{y}^{t+1}=\sigma \log \left(\frac{1}{q_{y}} \sum_{y \in \mathcal{Y}} \exp \left(\frac{\Phi_{x y}-u_{x}^{t+1}}{\sigma}\right)\right)
\end{array}\right.
$$

This is the iterated proportional fitting algorithm (IPFP), which has been rediscovered under many names": "matrix scaling", "RAS algorithm", "Sinkhorn-Knopp algorithm", "Kruithof's method", "Furness procedure", "biproportional fitting procedure", "Bregman's procedure". In economics, this algorithm has been proposed at least twice, once by Berry, Levinsohn and Pakes 1995 under the name "contraction mapping algorithm," and once by Guimares-Portugal (2010) in the context of the gravity equation in trade. We will see some of these connections below. This algorithm has been successfully applied to machine learning, see Cuturi (2013) and Peyré and $\mathrm{Cu}-$ turi (2019). The rates of convergence of this algorithm are by now well understood thanks to the Hilbert projective metric, see Franklin and Lorenz (1989), and more recently, thanks to the theory of Bregman divergences, see Léger $(2020)$.

### 2.2.2 Variant with unassigned agents

A variant of the problem leaves the agents the possibility of remaining unassigned. When the total mass of workers differs from that of the firms, we still[^1]denote $p_{x}$ be the mass of workers of type $x$ (no longer interpreted as a probability) and $q_{y}$ the mass of firms of type $y$, and we allow for $\sum_{x} p_{x} \neq \sum_{y} q_{y}$ to hold. The constraint is now that the total mass of matched workers of type $x$ should be no greater than $p_{x}$, and that the total mass of matched firms of type $y$ should not exceed $q_{y}$; and the total surplus is still $\sum_{x y} \pi_{x y} \Phi_{x y}$; the primal problem is now

$$
\begin{align*}
\max _{\pi \geq 0} & \sum_{x \in \mathcal{X}, y \in \mathcal{Y}} \pi_{x y} \Phi_{x y}  \tag{9}\\
\text { s.t. } & \left\{\begin{array}{l}
\sum_{y \in \mathcal{Y}} \pi_{x y} \leq p_{x} \forall x \in \mathcal{X} \\
\sum_{x \in \mathcal{X}} \pi_{x y} \leq q_{y} \forall y \in \mathcal{Y}
\end{array}\right.
\end{align*}
$$

while the dual problem becomes

$$
\begin{align*}
& \min _{u \geq 0, v \geq 0} \sum_{x \in \mathcal{X}} p_{x} u_{x}+\sum_{y \in \mathcal{Y}} q_{y} v_{y}  \tag{10}\\
& \quad \text { s.t. } u_{x}+v_{y} \geq \Phi_{x y} \forall x \in \mathcal{X}, y \in \mathcal{Y}
\end{align*}
$$

As we see, these formulations only slightly differ from (1) and (2) respectively: the constraints in the primal switch from an equality to an inequality, while the variables in the dual are now subject to nonnegativity constraints. Because this leaves the possibility of agents to remained unmatched (unemployed in the labor market; singles in the marriage market), these problems are sometimes more relevant for economic modelling. This model is called the Becker-Shapley-Shubik model, after Becker (1973) and Shapley-Shubik (1971).

### 2.3 Inverse optimal transport problem

Understanding the "direct problem" of optimal transport as determining the optimal transport plan $\pi_{x y}$ in (1) or (5) based on the transport surplus $\Phi_{x y}$, as described above, we now turn to the "inverse problem" of optimal transport: how to determine the transport surplus $\Phi_{x y}$ based on the observation of an optimal transport plan $\hat{\pi}_{x y}$. More specifically, we specify

$$
\begin{equation*}
\Phi_{x y}^{\lambda}=\sum_{k} \lambda_{k} \phi_{x y}^{k} \tag{11}
\end{equation*}
$$

Setting $\theta=\left(\lambda_{k}, u_{x}, v_{y}\right)$ and

$$
\begin{equation*}
\pi_{x y}^{\theta}=\exp \left(\Phi_{x y}^{\lambda}-u_{x}-v_{y}\right) \tag{12}
\end{equation*}
$$

the inverse optimal transport problem consists of seeking the parameter $\theta$ such that $\pi_{x y}^{\theta}$ has the same margins and moments as $\hat{\pi}_{x y}$, that is

$$
\begin{equation*}
\sum_{y \in \mathcal{Y}} \pi_{x y}^{\theta}=\sum_{y \in \mathcal{Y}} \hat{\pi}_{x y}=: p_{x}, \sum_{x \in \mathcal{X}} \pi_{x y}^{\theta}=\sum_{x \in \mathcal{X}} \hat{\pi}_{x y}=: q_{y}, \sum_{x, y} \pi_{x y}^{\theta} \phi_{x y}^{k}=\sum_{x, y} \hat{\pi}_{x y} \phi_{x y}^{k} \tag{13}
\end{equation*}
$$

This question solved by the following convex optimization problem:

Theorem 1 The unique $\lambda$ satisfying conditions (13) is unique solution to

$$
\begin{equation*}
\min _{u, v, \lambda}\left\{\sum_{x \in \mathcal{X}} p_{x} u_{x}+\sum_{y \in \mathcal{Y}} q_{y} v_{y}+\sum_{x, y} \exp \left(\Phi_{x y}^{\lambda}-u_{x}-v_{y}\right)-\sum_{x y} \hat{\pi}_{x y} \Phi_{x y}^{\lambda}\right\} \tag{14}
\end{equation*}
$$

whose dual is

$$
\begin{array}{ll} 
& \max _{\pi \geq 0}\left\{-\sum_{x y} \pi_{x y} \ln \pi_{x y}\right\}  \tag{15}\\
\text { s.t. } \quad & \sum_{y \in \mathcal{Y}} \pi_{x y}=p_{x}\left[u_{x}\right], \sum_{x \in \mathcal{X}} \pi_{x y}=q_{y}\left[v_{y}\right] \\
& \sum_{x, y} \pi_{x y} \phi_{x y}^{k}=\sum_{x, y} \hat{\pi}_{x y} \phi_{x y}^{k}\left[\lambda_{k}\right]
\end{array}
$$

The problem of parametric estimation of $\lambda$ is therefore the problem of a Poisson pseudo-maximum likelihood estimation, similar to the technique employed in trade to estimate the gravity equation (Santos Silva and Tenreyro, 2006). Galichon and Salanié (2021) formulated the initial connection with the Choo-Siow (2006) matching model, in the variant with singles. Dupuy and Galichon (2014) studies a continuous version of this model. Dupuy, Galichon and Sun (2019) add a Lasso-type penalization to estimate $\lambda$ under sparsity constraint, while Carlier, Dupuy, Galichon and Sun (2021) offer an algorithm called SISTA (Sinkhorn+Iterative Soft Thresholding Algorithm) to compute efficently the regularized problem by alternating coordinate descent steps (Sinkhorn steps) on the $u_{x}$ 's and the $v_{y}$ 's, with a proximal gradient descent step.

## 3 Optimal transport in economics, finance and statistics

### 3.1 Family economics

As first understood by Becker (1973) and Shapley-Shubik (1971), the duality in optimal transport can be thought as a powerful welfare theorem, providing the equivalence between optimal matchings (in the sense of the problem of a central planner), and stable matchings (in a sense to be specified). Becker applied this insight in his pioneering analysis of the marriage market, and we now describe his analysis.

Consider the "marriage" problem of heterosexual men and women who need to decide to match. Men are distributed according to a a mass vector $\left(p_{x}\right)$, while women are distributed according to a mass vector $\left(q_{y}\right)$, where the total mass of men and women don't have to coincide. It is assumed that if $x$ and $y$ decide to match, they enjoy a joint utility $\Phi_{x y}$, which they need to split among them. Any agent remaining unmatched gets a reservation utility equal to zero.

A stable marriage is a specification of a joint distribution $\left(\pi_{x y}\right) \geq 0$ over $\mathcal{X} \times \mathcal{Y}$ as well as payoffs vectors $u_{x}$ and $v_{y}$ such that

$$
\left\{\begin{array}{l}
\sum_{y \in \mathcal{Y}} \pi_{x y}+\pi_{x 0}=p_{x}, \sum_{x \in \mathcal{X}} \pi_{x y}+\pi_{0 y}=q_{y}  \tag{16}\\
u_{x}+v_{y} \geq \Phi_{x y} \\
u_{x} \geq 0, v_{y} \geq 0 \\
\pi_{x y}>0 \Longrightarrow u_{x}+v_{y}=\Phi_{x y} \\
\pi_{x 0}>0 \Longrightarrow u_{x}=0, \pi_{0 y}>0 \Longrightarrow v_{y}=0
\end{array}\right.
$$

The first set of conditions implies that all agents either participate in the matching market, or remain unmatched. The next conditions, namely $u_{x}+v_{y} \geq \Phi_{x y}$, imply that there is no blocking pair: if $u_{x}+v_{y}$ were less than $\Phi_{x y}$, then $x$ and $y$ would have an incentive to quit their existing assignments and form a blocking pair, and each achieve strictly greater utility than $u_{x}$ and $v_{y}$ respectively. Similarly, $u_{x} \geq 0$ and $v_{y} \geq 0$ indicate that no one can achieve an outcome worse than the reservation utility.

Finally, the last set of conditions expresses that if pairs $x y$ are actually formed, then there must be a way to split the joint surplus $\Phi_{x y}$ in such a way that $u_{x}$ and $v_{y}$ sum to $\Phi_{x y}$, while if a positive mass of either $x$ or $y$ remain unmatched at equilibrium, the payoff of the corresponding type should be zero.

It is not hard to see that equations (16) are the complementary slackness conditions associated with linear programming problem (9)-(10). Hence:

Theorem 2 (Becker-Shapley-Shubik) ( $\pi, u, v)$ is a stable marriage in the sense of (16) if and only if $\pi$ is an optimal solution to (9), and $(u, v)$ is an optimal solution to (10).

This linear programming formulation is especially attractive for computational purposes, see chapter 3.4 of Galichon (2016).

### 3.2 Labor economics

In a realistic model of the labor market, not all jobs offering the same wage are as attractive for the workers. Hence, we need to capture the job amenities as the monetary valuations for working certain type of jobs conditional
on being a certain type of worker. Let $\alpha_{x y}$ be the monetary valuation of employer $y$ 's amenities for worker $x$, and let $\gamma_{x y}$ be the monetary output of worker $x$ working for employer $y$. As before, we normalize to zero the payoff of unassigned agents.

Let $w_{x y}$ be the wage that $x$ receives if working for $y$, which is determined at equilibrium. The worker and the firm problems are respectively

$$
\begin{equation*}
u_{x}=\max _{y \in \mathcal{Y}}\left\{\alpha_{x y}+w_{x y}, 0\right\} \text { and } v_{y}=\max _{x \in \mathcal{X}}\left\{\gamma_{x y}-w_{x y}, 0\right\} \tag{17}
\end{equation*}
$$

from which it follows that, defining the total output associated with an $x y$ match as the sum of monetary amenity plus production, namely $\Phi_{x y}=\alpha_{x y}+$ $\gamma_{x y}$, an equilibrium on the labor market should be such that $(\pi, u, v)$ should be a stable matching in the sense of (16). Once $(u, v)$, which is solution to (10) has been computed, one can compute the vector of equilibrium wages $w_{x y}$ by

$$
\begin{equation*}
\gamma_{x y}-v_{y} \leq w_{x y} \leq u_{x}-\alpha_{x y} \tag{18}
\end{equation*}
$$

Note that for pairs $x y$ that are actually formed at equilibirum, $\pi_{x y}>0$

implies that $u_{x}+v_{y}=\Phi_{x y}$, and thus the upper bound $u_{x}-\alpha_{x y}$ coincides with the lower bound $\gamma_{x y}-v_{y}$. For other pairs, the upper bound may differ from the lower bound, which is a typical situation in equilibrium, where the price vectors need not be unique outside of the equilibrium path.

### 3.3 Trade

The structural gravity equations in international trade, introduced by Anderson (2003), with antecedents in Alan Wilson (1969), has been described
as a "workhorse" model in that field (Head and Mayer, 2013). Letting $\mathcal{X}$ be the set of countries, we define $\hat{\pi}_{x y}$ as the observed trade flow from country $x \in \mathcal{X}$ to country $y \in \mathcal{X}$. Letting $p_{x}=\sum_{y \neq x} \hat{\pi}_{x y}$ be the total volume of country $x$ 's exports, and $q_{y}=\sum_{x \neq y} \hat{\pi}_{x y}$ be the total volume of country $y$ 's imports, the gravity model assumes that

$$
\begin{equation*}
\pi_{x y}^{\lambda, u, v}=\exp \left(\Phi_{x y}^{\lambda}-u_{x}-v_{y}\right) \tag{19}
\end{equation*}
$$

where $\Phi_{x y}^{\lambda}=\sum_{k} \phi_{x y}^{k} \lambda_{k}$ and the $\phi_{x y}^{k}$ 's are various measures of proximity between country $x$ and country $y$. The exporter and importer fixed effects $u_{x}$ and $v_{y}$ are called "multilateral resistances" and are adjusted by fitting the total imports and exports

$$
\left\{\begin{array}{l}
p_{x}=\sum_{y \neq x} \exp \left(\Phi_{x y}^{\lambda}-u_{x}-v_{y}\right)  \tag{20}\\
q_{y}=\sum_{x \neq y} \exp \left(\Phi_{x y}^{\lambda}-u_{x}-v_{y}\right)
\end{array}\right.
$$

As understood by Wilson (1969), $\pi^{\lambda, u, v}$ is the solution to the regularized optimal transport problem (5), while $u_{x}$ and $v_{y}$ are solution to its dual (6). Moreover, $\theta=(\lambda, u, v)$ can estimated as an inverse optimal transport problem (14), as suggested by the influencial paper of Santos Silva and Tenreyro (2006), who connect the procedure with a Poisson regression. The link with inverse optimal transport and matching problems is made in Dupuy, Galichon and Sun (2019).

### 3.4 Hedonic models

Consider a quasilinear hedonic model where each producer $x \in \mathcal{X}$ produces one unit of good and chooses in which quality $z \in \mathcal{Z}$. Each consumer $y \in \mathcal{Y}$ consumes one unit of good, and chooses in which quality $z \in \mathcal{Z}$. The mass of the producers and consumers are respectively distributed according to vectors $\left(p_{x}\right)$ and $\left(q_{y}\right)$. There is a price $P_{z}$, determined at equilibrium, for one unit of the good in quality $z$, and a producer of type $x$ incurs a profit $P_{z}-C_{x z}$ of producing quality $z$ at that price where $C$ is a cost, while a consumer of type $y$ derives a utility $U_{y z}-P_{z}$ of consuming utility $z$ at that price. Both producers and consumers can opt out of the market and get profit or utility zero in that case.

In a hedonic equilibrium (Ekeland, Heckman and Nesheim, 2004), demand and supply are formed by the producer's and consumer's problems which are respectively

$$
\begin{equation*}
u_{x}=\max _{z \in \mathcal{Z}}\left\{P_{z}-C_{x z}, 0\right\} \text { and } v_{y}=\max _{z \in \mathcal{Z}}\left\{U_{y z}-P_{z}, 0\right\} \tag{21}
\end{equation*}
$$

Chiappori, McCann and Nesheim (2010) have shown that this problem is actually an optimal transport problem of the type (9) between consumers and producers, with a matching surplus equal to

$$
\begin{equation*}
\Phi_{x y}=\max _{z}\left\{U_{y z}-C_{x z}\right\} \tag{22}
\end{equation*}
$$

and the indirect utilities $u_{x}$ and $v_{y}$ are determined by (10). The intuition for the result is limpid: if $x$ and $y$ decide to exchange a good, they should
pick the good which is cost efficient in the sense that it maximizes their total joint surplus. The price vector $P_{z}$ will be deduced from $u_{x}$ and $v_{y}$ by the set of inequalities

$$
\begin{equation*}
\min _{x \in \mathcal{X}}\left\{u_{x}+C_{x z}\right\} \geq P_{z} \geq \max _{y \in \mathcal{Y}}\left\{U_{y z}-v_{y}\right\} \tag{23}
\end{equation*}
$$

where - similarly to the wage determination in equation (18) - the lower bound and the upper bound will coincide as soon as the quality $z$ is actually traded at equilibrium.

### 3.5 Discrete choice models

Recently, an intimate connection between optimal transport theory and discrete choice models has been explored, which we now describe. Consider the (additive) discrete choice problem where a consumer $i$ drawn from a population faces a choice between a finite set of alternatives $y \in \mathcal{Y}$. Consumer $i$ 's problem is

$$
\begin{equation*}
u\left(\varepsilon_{i}\right)=\max _{y \in \mathcal{Y}}\left\{V_{y}+\varepsilon_{i y}\right\} \tag{24}
\end{equation*}
$$

where $V_{y}$ is the systematic utility that every consumers associate with alternative $y$, and $\left(\varepsilon_{i y}\right)_{y \in \mathcal{Y}}$ is drawn from a random vector over $\mathbb{R}^{\mathcal{Y}}$ with distribution $\mathbf{P}$, which is assumed to have a density. The distribution of the random part of the utility $\varepsilon$ induces a choice probability, or market share $Q_{y}(V)$ which is the probability that $y$ is chosen by a consumer $i$ drawn from
the population, formally expresses as ${ }^{2}$

$$
\begin{equation*}
Q_{y}(V)=\operatorname{Pr}\left(y \in \arg \max _{y \in \mathcal{Y}}\left\{V_{y}+\varepsilon_{i y}\right\}\right) \tag{25}
\end{equation*}
$$

The demand inversion problem, popularized by Berry (1994) and Berry, Levinsohn and Pakes (1995, hereafter BLP) consists of, given a vector of market shares $q_{y}$, how to look for a vector of systematic utility $V$ such that $Q(V)=q$. This problem is a key step in BLP's estimation procedure, which consists of computing $V$ by demand inversion, and then running an instrumental variable regression on $V$.

Galichon and Salanié (2021) showed that the problem of discrete choice inversion is, in fact, isomorphic to an optimal transport problem.

Theorem 3 (Galichon-Salanié, part 1) The following statements are equivalent:

(i) $Q(V)=q$, that is $V$ is the solution to inversion problem of the discrete choice model in (24), and

(ii) There exist $(u, v)$ with $v=-V$ such that $(u, v)$ is solution to the dual optimal transport problem with surplus $\Phi(\varepsilon, y):=\varepsilon_{y}$

$$
\begin{align*}
& \min _{u, v} \int_{\varepsilon \in \mathbb{R}^{\mathcal{Y}}} u(\varepsilon) d \mathbf{P}(\varepsilon)+\sum_{y \in \mathcal{Y}} q_{y} v_{y}  \tag{26}\\
& \text { s.t. } u(\varepsilon)+v_{y} \geq \varepsilon_{y} \forall \varepsilon \in \mathbb{R}^{\mathcal{Y}}, \forall y \in \mathcal{Y}
\end{align*}
$$

This result was extended to the nonsmooth case (where no regularity as-[^2]sumption is made on the distribution of $\varepsilon$ ) by Chiong, Galichon and Shum (2016), where a linear programming approch was provided for computational purposes. It has been extended to the continuous choice by Chernozhukov, Galichon, Henry and Pass (2021), and beyond additive random utility models by Bonnet et al. (2021).

A philosophical consequence of theorem 3 is that - at least from a mathematical standpoint - there is no relevant distinction between "one-sided" and "two-sided" models. We think of a discrete choice problem as a situation where conscient creatures called "consumers" choose inanimate objects called "yogurts". However, the equivalence described in theorem 3 shows that this situation is mathematically equivalent to a situation where consumers and yogurts would match, which is itself fully equivalent to a situation where yogurts choose consumers! This is a manifestation of Coase's principle: no matter how the utility is initially distributed, that is, no matter if consumers have preferences for yogurts or if yogurts have preferences for consumers, a Pareto efficient outcome should be reached in any case, and the bargaining process, here the yogurt price adjustment, allows to implement this outcome.

Interestingly, theorem 3 can be extended to mixed logit models, such as BLP's random coefficient logit model. Consider now a variant

$$
\begin{equation*}
u\left(\varepsilon_{i}\right)=\max _{y \in \mathcal{Y}}\left\{V_{y}+\varepsilon_{i y}+\sigma \eta_{y}\right\} \tag{27}
\end{equation*}
$$

where $\left(\varepsilon_{y}\right) \sim \mathbf{P}$ as before, while $\left(\eta_{y}\right)$ is a vector of i.i.d. random variables with a Gumbel distribution, independent from $\left(\varepsilon_{y}\right)$. Let $Q_{y}^{\sigma}(V)$ be the
corresponding market share defined for each entry $y \in \mathcal{Y}$.

Theorem 4 (Galichon-Salanié, part 2) The following statements are equivalent:

(i) $Q^{\sigma}(V)=q$, that is $V$ is the solution to inversion problem of the discrete choice model in (27), and

(ii) There exist $(u, v)$ with $v=-V$ such that $(u, v)$ is solution to the dual regularized optimal transport problem with surplus $\Phi(\varepsilon, y):=\varepsilon_{y}$

$$
\begin{equation*}
\min _{u, v} \int_{\varepsilon \in \mathbb{R} \mathcal{Y}} u(\varepsilon) d \mathbf{P}(\varepsilon)+\sum_{y \in \mathcal{Y}} q_{y} v_{y}+\sigma \sum_{y \in \mathcal{Y}} \int_{\varepsilon \in \mathbb{R}^{\mathcal{Y}}} \exp \left(\frac{\varepsilon_{y}-u(\varepsilon)-v_{y}}{\sigma}\right) d \varepsilon \tag{28}
\end{equation*}
$$

Note that (28) is the same problem as (6) where the summation on $\varepsilon$ has been replaced by a continuous integrals; however, in the sample version, we considering a sample $\varepsilon_{1}, \ldots, \varepsilon_{N}$ from distribution $\mathbf{P}$, and the integrals are replaced by sums.

As shown in Bonnet et al. (2021), the coordinate descent algorithm described in paragraph 2.2.1 coincides with BLP's celebrated "contraction mapping algorithm." This observation led the former authors to propose a demand inversion procedure that extends to the non-additive case.

### 3.6 Derivative pricing

Consider two stocks, and let $X$ and $Y$ be random variables standing for the value of these stocks at a horizon of time in the future. The fundamental theorem of asset pricing (see Duffie 1992) asserts that if there is a complete market of options with $X$ as an underlying, then there is a distribution $\mathbf{P}$
called martingale measure such that the price of an option whose payoff is $u(X)$ shall be $\mathbb{E}_{\mathbf{P}}[u(X)]$. We shall assume that this is the case, and that there is a martingale measure $\mathbf{Q}$ such that the price of any option with payoff $v(Y)$ is $\mathbb{E}_{\mathbf{Q}}[v(Y)]$.

However, we shall not assume that there is a complete market of options on the joint realization of the underlying pair $(X, Y)$, hence we cannot infer a joint martingale measure $\pi(x, y)$ based on the quoted prices. For a trader wishing to introduce a new option on the pair $(X, Y)$, some restrictions must however be considered; in particular, if the option's payoff is of the form $a(X)+b(Y)$, its price must be $\mathbb{E}_{\mathbf{P}}[a(X)]+\mathbb{E}_{\mathbf{Q}}[b(Y)]$, otherwise the trader would face an arbitrage opportunity. But in general, the price of an option with a payoff $\Phi(X, Y)$ that is not additively separable cannot exceed

$$
\begin{equation*}
\max _{\pi \in \mathcal{M}(P, Q)} \mathbb{E}_{\pi}[\Phi(X, Y)] \tag{29}
\end{equation*}
$$

The Monge-Kantorovich duality will give us sharp arbitrage bounds for the price of this option, and will provide arbitrage strategies, as explained in Galichon, Henry-Labordère and Touzi (2014):

Theorem 5 An option whose payoff $\Phi(X, Y)$ is priced at $V$ is not subject to an arbitrage opportunity based on the two single-underlying option markets if and only if

$$
\begin{align*}
& \max _{u, v} \mathbb{E}_{\mathbf{P}}[u(X)]+\mathbb{E}_{\mathbf{Q}}[v(Y)] \leq V \leq \min _{u, v} \mathbb{E}_{\mathbf{P}}[u(X)]+\mathbb{E}_{\mathbf{Q}}[v(Y)]  \tag{30}\\
& \text { s.t. } u(x)+v(y) \leq \Phi(x, y) \\
& \text { s.t. } u(x)+v(y) \geq \Phi(x, y)
\end{align*}
$$

In other words, the price of the option should be bounded above by the
price of the cheapest overreplicating portfolio, while it should be bounded below by the price of the costliest underreplicating portfolio.

The above discussion has assumed that the pair of underlyings $X$ and $Y$ were the realizations of two assets prices at the same time. However, some derivatives are written on the same underlying asset at two different dates in the future. Assume that $X$ is the value of a stock at a future date, and $Y$ is the stock value at a later date. We then have an additional restriction, which is that in any martingale measure, $\mathbb{E}_{\pi}[Y \mid X]=X$ expresses absence of arbitrage. The option bound problem (29) now becomes

$$
\begin{align*}
\max _{\pi \in \mathcal{M}(P, Q)} & \mathbb{E}_{\pi}[\Phi(X, Y)]  \tag{31}\\
\text { s.t. } & \mathbb{E}_{\pi}[Y \mid X]=X
\end{align*}
$$

for which the Monge-Kantorovich duality extends and interprets as incorporating dynamic arbitrage strategies; see an exposition from a financial engineering's point of view in Pierre Henry-Labordère (2020)'s insightful book.

### 3.7 Quantiles

There is an intimate connection between optimal transport and the notion of quantile. Consider the optimal transport problem described in (3) with $\mathcal{X}=\mathcal{Y}=\mathbb{R}, P=\mathcal{U}([0,1])$ the uniform distribution on the unit interval, $Q$ a distribution with finite second moments, and $\Phi(x, y)=x y$.

Then, as explained in chapter 4 of Galichon (2016), the solution $(X, Y) \sim$ $\pi$ to problem (3) is a random pair such that $Y=F_{Q}^{-1}(X)$. Further, the
solution $(u, v)$ to problem (4) is such that $u^{\prime}(x)=F_{Q}^{-1}(x)$ and $v^{\prime}(y)=$ $F_{Q}(y)$. Hence the primal solution involves the quantile transform, and the dual solutions are simply primitives of the quantile map and the cumulative distribution function.

### 3.7.1 Multivariate quantiles

This connection led to the definition of a notion of multivariate quantiles: when $Y$ is multivariate, say has $d$ dimensions, one can extend the above

setting to $X \sim P=\mathcal{U}\left([0,1]^{d}\right)$ and to $\Phi(x, y)=x^{\top} y$ and, if $(u, v)$ is a solution to problem (4) in that case, the map $x \rightarrow \nabla u(x)$ is defined as the multivariate quantile associated with distribution $Q$. By Brenier's theorem (Brenier 1987), $\nabla u(X)$ has distribution $Q$, generalizing the well-known fact in the univariate case that the quantile map associated with a distribution pushes the uniform distribution on the unit interval onto the distribution. This new notion of multivariate quantiles found applications to risk measures (Ekeland, Galichon and Henry, 2012), decision theory (Galichon and Henry, 2012), and multivariate depth (Hallin, Chernozhukov, Galichon and Henry, 2017).

### 3.7.2 Quantile regression

There is an intimate connection between optimal transport and quantile regression, that is explored in a series of paper by Carlier, Chernozhukov and Galichon $(2016,2017)$ and Carlier, Chernozhukov, De Bie and Galichon (2020). We follow the latter paper in the present exposition. Quantile regression (see Koenker, 2005) attempts to fit a parametric dependence of
the conditional $\tau$-th quantile of a random variable $Y$ conditional on the value of $X$, a random vector on $\mathbb{R}^{k}$, as

$$
\begin{equation*}
Q_{Y \mid X}(\tau \mid x)=\beta(\tau)^{\top} x \tag{32}
\end{equation*}
$$

where $\beta(\tau) \in \mathbb{R}^{k}$ is the parameter of interest, defined for each value of $\tau \in$ $[0,1]$. Since Koenker and Bassett (1978), this problem has been recognized as a convex optimization problem in the population

$$
\begin{equation*}
\min _{\beta(\tau) \in \mathbb{R}^{k}} \mathbb{E}_{\mathbf{P}}\left[\rho_{\tau}\left(Y-\beta(\tau)^{\top} X\right)\right] \tag{33}
\end{equation*}
$$

where the loss function $\rho_{\tau}(z)=\tau z^{+}+(1-\tau) z^{-}$, and $\mathbf{P}$ denotes the joint distribution of $(X, Y)$. The sample analog of (33) is a linear programming problem, yielding to a simple and computationally efficient estimation of $\beta$. The full curve $\tau \rightarrow \beta(\tau)$ can be estimated by summation of the objective functions in (33) over $\tau \in[0,1]$, yielding

$$
\begin{equation*}
\min _{\beta \in \mathbb{R}^{k \times[0,1]}} \mathbb{E}_{\mathbf{P}}\left[\int_{0}^{1} \rho_{\tau}\left(Y-\beta(\tau)^{\top} X\right) d \tau\right] \tag{34}
\end{equation*}
$$

When specification (32) is correct, the map $\tau \rightarrow \beta(\tau)^{\top} x$ which is picked up is an actual quantile, and therefore nondecreasing. However, if specification (32) is incorrect, there is no guarantee that $\tau \rightarrow \beta(\tau)^{\top} x$ should be monotone. This phenomenon has been widely recognized in the literature on quantile regression and is known as the quantile crossing problem. To address the quantile crossing problem, one idea may be to impose directly the monotonicity of $\tau \rightarrow \beta(\tau)^{\top} x$ as an additional constraint in problem (34).

This has been done by Koenker and Ng (2005) but remains computationally challenging and the interpretation of the result is not obvious.

A more indirect approach consists of the following. Rather than imposing the monotonicity of $\tau \rightarrow \beta(\tau)^{\top} x$, one can impose the (weaker) constraint that $\tau \rightarrow 1\left\{y \geq \beta(\tau)^{\top} x\right\}$ should be nonincreasing in $\tau$. Consider the problem

$$
\begin{align*}
\min _{\beta \in \mathbb{R}^{k \times 00,1]}} & \mathbb{E}_{\mathbf{P}}\left[\int_{0}^{1} \rho_{\tau}\left(Y-\beta(\tau)^{\top} X\right) d \tau\right]  \tag{35}\\
\text { s.t. } & 1\left\{y \geq \beta(\tau)^{\top} x\right\} \geq 1\left\{y \geq \beta\left(\tau^{\prime}\right)^{\top} x\right\} \quad \forall \tau \leq \tau^{\prime}, \forall x \in \mathbb{R}^{k}, y \in \mathbb{R}
\end{align*}
$$

The solution to the previous problem now has a very straightforward interpretation.

Theorem 6 (Carlier-Chernozhukov-De Bie-Galichon) If the map $\beta$ is solution to problem (33), then denoting $b(\tau)=\int_{0}^{\tau} \beta(t) d t$, and letting

$$
\begin{equation*}
\psi(x, y)=\max _{\tau \in[0,1]}\left\{\tau y-x^{\top} b(\tau)\right\} \tag{36}
\end{equation*}
$$

the pair $(b, \psi)$ will be solution to the following problem

$$
\begin{align*}
& \max _{b, \psi} \mathbb{E}_{\mathbf{P}}[X]^{\top} \int_{0}^{1} b(\tau) d \tau+\mathbb{E}_{\mathbf{P}}[\psi(X, Y)]  \tag{37}\\
& \text { s.t. } x^{\top} b(\tau)+\psi(x, y) \geq \tau y .
\end{align*}
$$

Conversely, if $(b, \psi)$ is solution to problem (37) and if $b$ is differentiable, then $\beta(\tau)=b^{\prime}(\tau)$ is a solution to problem (33).

Theorem 6 sheds new insights on quantile regression. Indeed, an extension of Monge-Kantorovich duality worked out in Carlier, Chernozhukov and Galichon (2016) shows that problem (37) is the dual problem to

$$
\begin{align*}
\min _{\pi \in \mathcal{M}(\mathcal{U}([0,1]), \mathbf{P})} & \mathbb{E}_{\pi}\left[(Y-U)^{2}\right]  \tag{38}\\
\text { s.t. } & \mathbb{E}[X \mid U]=\mathbb{E}[X]
\end{align*}
$$

where $\pi \in \mathcal{M}(\mathcal{U}([0,1]), \mathbf{P})$ means that if $(U, X, Y) \sim \pi$, then $U \sim \mathcal{U}([0,1])$ and $(X, Y) \sim \mathbf{P}$. If $(b, \psi)$ is a solution to (37) with $b$ differentiable and $(U, X, Y) \sim \pi$ is a solution to (38), then letting $\beta(\tau)=b^{\prime}(\tau)$, one has the representation

$$
\begin{equation*}
Y=X^{\top} \beta(U) \tag{39}
\end{equation*}
$$

where $X$ is mean-independent from $U$. Beyond the case when $Y$ is scalar, this formulation allows to get a multivariate extension of quantile regression using the notion of vector quantiles; see Carlier, Chernozhukov, Galichon (2016).

### 3.8 Partial identification and random sets

Some problems in econometrics specify incomplete restrictions between a model and an observed variable. Assume, following Galichon and Henry (2011), that we observe a random variable $Y \sim Q$ valued in $\mathcal{Y}$, and that the restrictions given by the model specify $Y \in \Gamma_{\theta}(X)$, and $X \sim P$, where $X$ is a data-generating process valued in $\mathcal{X}$ and $\theta \in \Theta$ is a parameter of the model. $\Gamma_{\theta}$ is a correspondence from $\mathcal{X}$ to $\mathcal{Y}$, such that $\Gamma_{\theta}(x)$ is a subset
of $\mathcal{Y}$. The identified set is the set $\Theta_{I}$ of $\theta \in \Theta$ such that there is a joint distribution $\pi \in \mathcal{M}(P, Q)$ with $\mathbb{E}_{\pi}\left[1\left\{Y \notin \Gamma_{\theta}(X)\right\}\right]=0$. Such a problem can be recast as an optimal transport problem

$$
\begin{equation*}
V=\min _{\pi \in \mathcal{M}(P, Q)} \mathbb{E}_{\pi}\left[1\left\{Y \notin \Gamma_{\theta}(X)\right\}\right] \tag{40}
\end{equation*}
$$

By working on the dual of this problem, one obtains Strassen's theorem (Strassen, 1965)

$$
\begin{equation*}
V=\max _{B}\left\{Q(B)-P\left(\Gamma^{-1}(B)\right)\right\} \tag{41}
\end{equation*}
$$

where the maximum extends over the Borel sets $B$ of $\mathcal{Y}$. Therefore $\theta \in$ $\Theta_{I}$ if and only if $Q(B) \leq P\left(\Gamma^{-1}(B)\right)$ for all $B$. The sample version of problem (40) allows to use optimal assignment algorithms as efficient computational tools to decide if $\theta \in \Theta_{I}$, and dual formulation (41) allows to do inference (Galichon and Henry, 2009).

### 3.9 Generalized linear models

Consider a generalized linear model (GLM) with 2-way fixed effects. The observations are $i j$; the dependent variable is $\hat{\pi}_{i j}$, while the explanatory variables are $\Phi=\left(\phi_{i j}^{k}\right)_{i j, k}$ for $k \in\{1, \ldots, K\}$ and the $i$ and $j$ fixed effects. If $l$ is the link function, which is increasing and continuous, the model is written as

$$
\begin{equation*}
\mathbb{E}\left[\hat{\pi}_{i j} \mid \phi_{i j}^{k}, i, j\right]=l^{-1}\left((\Phi \beta)_{i j}-u_{i}-v_{j}\right) \tag{42}
\end{equation*}
$$

Denote $p_{i}=\sum_{j} \hat{\pi}_{i j}$ and $q_{j}=\sum_{i} \hat{\pi}_{i j}$ the margins of $\hat{\pi}$. Letting $L$ be a primitive of $l$, and letting $L^{*}(w)=\max _{z}\{w z-L(z)\}$ be its convex conjugate,
which is a primitive of $l^{-1}$, one can show that the GLM model can be fit using

$$
\begin{equation*}
\min _{\beta}\left\{W(\beta)-\sum_{i j} \hat{\pi}_{i j}(\Phi \beta)_{i j}\right\} \tag{43}
\end{equation*}
$$

where

$$
\begin{align*}
W(\beta)=\max _{\pi_{i j} \geq 0} & \left\{\sum_{i j} \pi_{i j}(\Phi \beta)_{i j}-\sum_{i j} L\left(\pi_{i j}\right)\right\}  \tag{44}\\
\text { s.t. } & \sum_{j} \pi_{i j}=p_{i}, \sum_{i} \pi_{i j}=q_{j}
\end{align*}
$$

is a regularized optimal transport problem which can be equivalently expressed by its dual:

$$
\begin{equation*}
W(\beta)=\min _{u_{i}, v_{j}}\left\{\sum_{i} p_{i} u_{i}+\sum_{j} q_{j} v_{j}+\sum_{i j} L^{*}\left((\Phi \beta)_{i j}-u_{i}-v_{j}\right)\right\} \tag{45}
\end{equation*}
$$

In particular, the $\log \operatorname{link}$ function $l(z)=\ln z$ yields $l^{-1}(t)=\exp (t)$, and thus $L(z)=z(\ln z-1)$, and $L^{*}(t)=\exp (t)$, and $W(\beta)$ is the solution to an entropy regularized optimal transport problem, as described in paragraph 2.2.1.

### 3.10 Hide-and-seek games

In 1953, von Neumann described the following two-person, zero-sum game. Let ( $K_{i j}$ ) be a $N \times N$ matrix with positive terms. There are two players, "Hider" and "Seeker". Hider plays first and hides in a cell $(i, j)$. Playing second, Seeker highlights either a row or a column they claims contains Hider. If Seeker's claim is correct, then Hider pays Seeker $K_{i j}>0$, otherwise

0 .

Hider's mixed strategy is described by a vector of probabilities $\pi_{i j}$ of hiding in cell $i j$. Once Hider has played, Seeker picks either a column $i^{\prime}$ or a column $j^{\prime}$, whichever of these maximizes $\sum_{j^{\prime}} K_{i j^{\prime}} \pi_{i j^{\prime}}$ over $i$ and $\sum_{i^{\prime}} K_{i^{\prime} j} \pi_{i^{\prime} j}$ over $j$. Let us denote $(a, b)$ the vector of mixed strategies of Seeker, where $a_{i} \geq 0$ is the probability of highlighting a row $i$, and $b_{j} \geq 0$ is the probability of highlighting a column $j$, and $\sum_{i=1}^{n} a_{i}+\sum_{j=1}^{n} b_{j}=1$. If Hider plays strategy $\pi$ and Seeker plays strategy $(a, b)$, the expected payoff of Seeker is therefore

$$
\sum_{i j}\left(a_{i}+b_{j}\right) K_{i j} \pi_{i j}
$$

and hence the value of this zero-sum game for Seeker is obtained by minimizing the above expression over $x_{i j} \geq 0, \sum_{i j} x_{i j}=1$, and maximizing it over $(a, b) \geq 0$ such that $\sum_{i} a_{i}+\sum_{j} b_{j}=1$.

Von Neumann showed that this game is intimately connected with an optimal transport problem. Indeed,

$$
\begin{aligned}
V^{-1}= & \max _{\pi \geq 0} \sum_{i j} \pi_{i j} K_{i j}^{-1}=\min _{u \geq 0, v \geq 0} \sum_{i} \frac{u_{i}}{n}+\sum \frac{v_{j}}{n} \\
& \text { s.t. }\left\{\begin{array}{ll}
\sum_{j} \pi_{i j} \leq 1 / n \\
\sum_{i} \pi_{i j} \leq 1 / n
\end{array} \quad \text { s.t. } u_{i}+v_{j} \geq K_{i j}^{-1}\right.
\end{aligned}
$$

and the solution $\pi_{i j} \geq 0$ to the primal problem yields Hider's optimal strategy, while setting $a_{i}=V u_{i} / n$ and $b_{j}=V v_{j} / n$ yields Seeker's optimal strategy.

Although von Neumann's paper appeared in 1953, it seems that this important connection between a zero-sum game and a linear programming
problem was known to him decades earlier, in anticipation of Dantzig's general connection between linear programming and zero-sum games, cf. Dantzig (1951). See a historical perspective in Kuhn and Tucker (1958).

## 4 The mathematics of optimal transport

### 4.1 Network formulation

As explained in Galichon (2016), chapter 8, the optimal transport problem has the structure of a min-cost flow problem. Introduce a network whose set of nodes is $\mathcal{Z}=\mathcal{X} \cup \mathcal{Y}$ and whose set of arcs is $\mathcal{A}=\mathcal{X} \times \mathcal{Y}$. Such a network is called a bipartite one. Define an $\mathcal{A} \times \mathcal{Z}$ matrix $\nabla$ which is such that

$\nabla_{x y, z}=1\{z=y\}-1\{z=x\}$. Consider the "change of sign trick" where one defined $\tilde{q}=\left(-p^{\top}, q^{\top}\right)^{\top}$ and $\tilde{v}=\left(-u^{\top}, v^{\top}\right)^{\top}$. Define $c_{x y}=-\Phi_{x y}$. The vector $\tilde{q}$ should be interpreted as a vector of quantities, while the vector $\tilde{v}$ should be interpreted as a vector of prices.

Call $C(\tilde{q})$ the value of the optimal transport problem, which rewrites under its primal form as

$$
\begin{align*}
& C(\tilde{q})= \min _{\pi \geq 0}  \tag{46}\\
& \text { s.t. } \quad \nabla^{\top} \pi=\tilde{q}
\end{align*}
$$

when $q^{\top} 1 \mathcal{Z}=0$, and $C(\tilde{q})=+\infty$ otherwise. Equivalently, $C(\tilde{q})$ can be
expressed by its dual value as

$$
\begin{array}{r}
C(\tilde{q})=\max _{\tilde{v}} \quad \tilde{q}^{\top} \tilde{v} \\
\text { s.t. } \quad \nabla \tilde{v} \leq c .
\end{array}
$$

This is an instance of the min-cost flow problem, which makes sense more generally on any (not necessarily bipartite) network.

### 4.2 Equilibrium expression

By convex duality, denoting

$$
\begin{equation*}
C^{*}(\tilde{v})=\max _{\tilde{q}}\left\{\tilde{q}^{\top} \tilde{v}-C(\tilde{q})\right\} \tag{47}
\end{equation*}
$$

the convex conjugate of $C$, it can be seen that $C^{*}(\tilde{v})=0$ if $\nabla \tilde{v} \leq c$ and $+\infty$ otherwise, and one has

$$
\begin{equation*}
C(\tilde{q})=\max _{\tilde{v}}\left\{\tilde{q}^{\top} \tilde{v}-C^{*}(\tilde{v})\right\} \tag{48}
\end{equation*}
$$

Further, the set of $\tilde{v}=(-u, v)$ where $u$ and $v$ are solutions to problem (2) are the maximizers of (48).

In the case of the entropy regularized problem (5)-(6), these expressions become respectively

$$
\begin{align*}
C_{\sigma}(\tilde{q})=\min _{\pi \geq 0} & \pi^{\top} c+\sigma \pi^{\top} \log \pi  \tag{49}\\
& \text { s.t. } \nabla^{\top} \pi=\tilde{q}
\end{align*}
$$

and

$$
\begin{equation*}
C_{\sigma}^{*}(\tilde{v})=\sigma 1^{\top} \exp \left(\frac{c-\nabla \tilde{v}}{\sigma}\right) \tag{50}
\end{equation*}
$$

Keeping in mind the interpretation of $\tilde{q}$ as quantities and $\tilde{v}$ as prices, one should view $C(\tilde{q})$ as a cost function, expression $\tilde{v}^{\top} \tilde{q}-C_{\sigma}(\tilde{q})$ as a profit, and $C^{*}(\tilde{v})$ as an indirect profit function. Hence, expression (47) should be viewed as a profit maximization problem. The optimal transport problem consists of looking for the potentials $\tilde{v}$ that maximize $\tilde{q}^{\top} \tilde{v}-C^{*}(\tilde{v})$. By convex duality (see chapter 6 of Galichon, 2016), this is equivalent with

$$
\begin{equation*}
\tilde{v} \in \partial C(\tilde{q}) \tag{51}
\end{equation*}
$$

which, still by convex analysis, is equivalent with

$$
\begin{equation*}
\tilde{q} \in \partial C^{*}(\tilde{v}) \tag{52}
\end{equation*}
$$

Therefore, $\partial C^{*}$ should be interpreted as a supply correspondence, while $\partial C=$ $\left(\partial C^{*}\right)^{-1}$ should be interpreted as an inverse supply correspondence. The same intepretation extends immediately to the regularized versions of these objects.

### 4.3 Mathematical structures

The optimal transport problem is blessed with the priviledge to belong to the intersection of two rich theories: convex optimization and gross substitutes. There are, broadly speaking, two structures whithin which the equilibrium
problem

$$
\begin{equation*}
\tilde{q} \in Q(\tilde{v}) \tag{53}
\end{equation*}
$$

is well understood.

- The first one is convex optimization: $Q$ is the subdifferential of a convex function. Then the problem is a convex optimization problem, and convex optimization can be put to use to solve problem (53).
- The second case is gross substitutes: loosely speaking, $q_{x}$ cannot increase when $\tilde{v}_{y}$ increases $(x \neq y)$. This setting is needed for coordinate update algorithms such as Jacobi or Gauss-Seidel to converge, see Rheinboldt (1970).

In optimal transport, both structures are met, as we shall now see.

### 4.3.1 Convex optimization

Recall that the cost function $C$ and the indirect cost function $C^{*}$ defined above are convex functions, which are dual one to another in the sense of convex analysis. It follows that $\partial C^{*}(\tilde{v})$ and $\partial C(\tilde{q})$ are convex sets, and problems (51) and (52) can be solved as convex optimization problems dual to each other, respectively (48) and (47). In the unregularized case, these problems are linear programming problems. In the regularized case, the convexity structure is retained, but the problems are of course no longer linear.

### 4.3.2 Gross substitutes

When $\sigma>0$ it is easy to see that the indirect profit function $C_{\sigma}^{*}(\tilde{v})$ is submodular. It is not very hard to extend this result to the unregularized case to show that $C^{*}(\tilde{v})$ is submodular as well. As a result, the corresponding supply function satisfies Kelso and Crawford's (1982) gross substitutes property.

A remark is in order here. It may be a surprise that the optimal transport problem has the gross substitutes property, as common sense suggests that workers and firms should be complements, and not substitutes. However, keep in mind the "change-of-sign trick" implemented at paragraph 4.1: we defined $\tilde{v}=\left(-u^{\top}, v^{\top}\right)^{\top}$, and therefore we switched the sign of the worker's payoffs (and of their quantities accordingly). This change of sign is the reason why the optimal transport problem, in spite of being a problem with complementarities, reformulates as a problem with gross substitutes. See Sun and Yang (2006).

We can formulate gross substitutes properties of $C$ and $C^{*}$ in the language of L- and M-convexity, introduced by Murota (1998). Indeed, as the domain of $C$ is the set of $\tilde{q}$ such that $\tilde{q}^{\top} 1_{\mathcal{Z}}=0$, and as $C^{*}\left(\tilde{v}+\lambda 1_{\mathcal{Z}}\right)=C^{*}(\tilde{v})$ for all $\lambda \in \mathbb{R}$, it follows that $C$ is a $M$-convex function and $C^{*}$ is a $L$-convex function, and the supply bundle $\partial C^{*}(\tilde{v})$ is a $M$-convex set of $\mathbb{R}^{\mathcal{Z}}$, while $\partial C(\tilde{q})$ is a L-convex set, still in the terminology of the same author. In particular, $\partial C(\tilde{q})$ is a lattice, while $\partial C^{*}(\tilde{v})$ is a base polyhedron.

### 4.4 Extensions

As we have seen just above, the optimal transport problem can be formulated (at least under its regularized form) as a set of nonlinear equations $Q(p)=q$, where $Q$ happens to be the subdifferential of a convex function which is also submodular, and hence optimal transport belongs to both convexity and gross substitutes families. Some extensions of the optimal transport problem retain both convexity and gross substitutes. This is the case of the min-cost flow problem, for instance, as described in paragraph 4.1.

### 4.4.1 Problems that retain convexity, but not substitutability

Some problems retain convex optimization but not gross substitutes, such as one-to-many matching problems with transferable utility, see a related discussion in Azevedo and Hatfield (2018). Vector quantile regression, discussed above in paragraph 3.7.2, falls in that category, too.

In ongoing work with Pauline Corblet and Jeremy Fox 2020, we investigate a problem of dynamic matching that retains most of the convexity structure of optimal transport. The problem we study is a two-sided version of Rust (1987)'s model. More specifically, assume that conditional of a worker of type $X=x$ matching with a firm of type $y$, there is a probability $\mathbb{P}_{x^{\prime} \mid x y}$ that the worker will transition to type $x^{\prime}$ at the next period, and a probability $\mathbb{Q}_{y^{\prime} \mid x y}$ that the firm will transition to type $y^{\prime}$. In this case, the joint matching surplus should be the sum of the short-term surplus $\Phi_{x y}$ and the expected discounted future payoffs of the worker and of the firm, respectively denoted $\beta \mathbb{P}\left[u_{X} \mid x y\right]$ and $\beta \mathbb{Q}\left[v_{Y} \mid x y\right]$.

In this case, when $\beta=1$, Corblet et al. (2020) show that both the equilibrium computation and the estimation can be handled by the following saddle-point problem:

$$
\max _{n, m} \min _{u, v, \lambda} H(n, m, u, v, \lambda)
$$

where one has defined $H(n, m, u, v, \lambda)=$

$$
\left\{\begin{array}{l}
2 \sum_{x y \in \mathcal{X} \times \mathcal{Y}} \sqrt{n_{x} m_{y}} \exp \left(\frac{\sum_{k} \phi_{x y}^{k} \lambda_{k}+\mathbb{P}\left[u_{X} \mid x y\right]+\mathbb{Q}\left[v_{Y} \mid x y\right]-u_{x}-v_{y}}{2}\right) \\
+\sum_{x \in \mathcal{X}} n_{x} \exp \left(\sum_{k} \phi_{x 0}^{k} \lambda_{k}+\mathbb{E}\left[u_{X^{\prime}} \mid X=x\right]-u_{x}\right) \\
+\sum_{y \in \mathcal{Y}} m_{y} \exp \left(\sum_{k} \phi_{0 y}^{k} \lambda_{k}+\mathbb{E}\left[v_{Y}, \mid Y=y\right]-v_{y}\right) \\
-\sum_{x \in \mathcal{X}} n_{x}-\sum_{y \in \mathcal{Y}} m_{y}
\end{array}\right.
$$

which is convex in $(n, m)$ and concave in $(u, v, \lambda)$. Corblet et al. (2020) use this formulation to derive an algorithm to estimate the structural parameter $\lambda$ efficiently. They find that the algorithm extends to the case $\beta<1$. Dupuy et al. (2020) apply these ideas to family economics and fertility decisions.

### 4.4.2 Problems that retain substitutability, but not convexity

On the contrary, some problems retain the gross substitutes property, but not the convexity one. This is the case with one-to-one matching models with nontransferable utility, as shown by Adachi (2000), and with one-to-one matching models with imperfectly transferable utility, to handle in particular taxes, salary caps, public goods, etc. See Galichon, Kominers and Weber (2019). Non-additive random utility models and hedonic models beyond quasi-linear utility are also in this case. To handle these challenges, a more
general framework is needed, the equilibrium flow problem, which is the subject of current ongoing work by the author with Larry Samuelson and Lucas Vernet (2021). The equilibrium flow problem posits three objects. First a network $(\mathcal{Z}, \mathcal{A})$ is defined as in paragraph 4.1 , where $x y \in \mathcal{Z}$ is interpreted as the existence of a trade route from node $x$ to node $y$, and whose node-incidence matrix is denoted $\nabla$. Second, a vector of outflows $q \in \mathbb{R}^{\mathcal{Z}}$, where $q_{z}$ is interpreted as the mass that must leave the network at $z\left(q_{z}<0\right.$ means that mass actually appears at $\left.z\right)$. One assumes that $\sum_{z \in \mathcal{Z}} q_{z}=0$, so all the mass that enters the networks must leave it. Finally, a set of connection functions $G_{x y}: \mathbb{R} \rightarrow \mathbb{R}$ for each $x y \in \mathcal{A}$, which are increasing and whose interpretation is that $G_{x y}\left(p_{y}\right)-p_{x}$ is the profit of a carry trade, consisting of purchasing one unit of the commodity at price $p_{x}$ at node $x$, shipping to $y$, and selling at price $p_{y}$ at node $y$.

Given these inputs, the equilibrium flow problem consists of determining a vector of flows $\mu \in \mathbb{R}_{+}^{\mathcal{Z}}$ and prices $p \in \mathbb{R}^{\mathcal{Z}}$ such that:

(i) mass balance holds: the sum of mass that arrives at $z$ minus the sum that leaves is equal to $q_{z}$, that is, $\nabla^{\top} \mu=q$.

(ii) absence of arbitrage holds: there cannot be a positive rent associated with the carry trade over any arc, that is, $p_{x} \geq G_{x y}\left(p_{y}\right)$ for any $x y \in \mathcal{A}$.

(iii) individual rationality holds: if the carry trade over arc $x y$ is actually performed, then the associated profit cannot be negative, and thus, $\mu_{x y}>0$ implies $p_{x}=G_{x y}\left(p_{y}\right)$.

Galichon, Samuelson and Vernet (2021) show that this framework is general enough to encompass optimal transport problems, min-cost flow problems including shortest path problems, matching models with imperfectly
transferable utility, hedonic models, and supply chain problems.

## 5 Concluding discussion

To conclude, an attempt should be made to explain the claim to "unreasonable effectiveness" of optimal transport in economics, alluding to a celebrated formula of Wigner (1960). We believe that one of the reasons of the prevalence of optimal transport in economics is that the former strikes a good compromise between what models would like to capture and what they are capable of capturing.

Economics is, in a broad sense, the study of complementarities: capital and labor, worker and firms, supply and demand, buyers and sellers... all exhibit some complementarity which is at the source of economic activity. However, as it is now well understood since the insights of Kelso and Crawford (1982), problems with complementarities are hard to handle, and in particular, hard to compute. Fortunately, due to the bipartite structure, the "change-of-sign trick" described in paragraph 4.1 allowed us to reformulate the problem as a problem with gross substitutes, and therefore, let us enjoy the computational and structural benefits of a problem with gross substitutes. In some sense, the bipartite structure of optimal transport is a meeting point between the complementarity that models would like to capture, and the substitutability structure that they they are able to capture.

To make another analogy with Physics, the situation is similar to the two-body problem in cosmology, which has a tractable formulation and can be fully worked out - while the $n$-body problem with $n$ larger than two is
notoriously hard. Fortunately, just as in cosmology where many situations can be satisfactorily approximated by a two-body problem, in economics, many phenomenons can be captured using the bipartite approximation. We have surveyed some of these applications in the present paper, but certainly not in an exhaustive way. And optimal transport is a galaxy where there are many more planets, only waiting to be explored.

## References

Adachi, H. (2000). On a characterization of stable matchings. Economics Letters, 68(1), 43-49.

Anderson, J. E., \& Van Wincoop, E. (2003). Gravity with gravitas: A solution to the border puzzle. American Economic Review, 93(1), 170192 .

Azevedo, E. M., \& Hatfield, J. W. (2018). Existence of equilibrium in large matching markets with complementarities. SSRN Electronic Journal.

Becker, G. S. (1973). A theory of marriage: Part i. Journal of Political Economy, 81(4), 813-846.

Berry, S., Levinsohn, J., \& Pakes, A. (1995). Automobile prices in market equilibrium. Econometrica, 63 (4), 841-890.

Berry, S. T. (1994). Estimating discrete-choice models of product differentiation. The RAND Journal of Economics, 25(2), 242-262.

Bonnet, O., Galichon, A., Hsieh, Y.-W., O'Hara, K., \& Shum, M. (2021). Yogurts choose consumers? estimation of random utility models via
two-sided matching [Available at SSRN - Social Science Research Network].

Brenier, Y. (1987). Polar factorization and monotone rearrangement of vectorvalued functions. C. R. Acad. Sci. Paris, Ser. I, Mathematical Analysis, 305, 805-808.

Carlier, G., Chernozhukov, V., De Bie, G., \& Galichon, A. (2020). Vector quantile regression and optimal transport, from theory to numerics. Empirical Economics.

Carlier, G., Chernozhukov, V., \& Galichon, A. (2016). Vector quantile regression: An optimal transport approach. The Annals of Statistics, $44(3), 1165-1192$.

Carlier, G., Chernozhukov, V., \& Galichon, A. (2017). Vector quantile regression beyond the specified case. Journal of Multivariate Analysis, $161,96-102$.

Carlier, G., Dupuy, A., Galichon, A., \& Sun, Y. (2021, June 2). SISTA: Learning optimal transport costs under sparsity constraints (SSRN Scholarly Paper ID 3855961). Rochester, NY.

Chernozhukov, V., Galichon, A., Hallin, M., \& Henry, M. (2017). Monge kantorovich depth, quantiles, ranks and signs. The Annals of Statistics, $45(1), 223-256$.

Chernozhukov, V., Galichon, A., Henry, M., \& Pass, B. (2021). Identification of hedonic equilibrium and nonseparable simultaneous equations. Journal of Political Economy, 129(3), 842-870.

Chiappori, P.-A., McCann, R. J., \& Nesheim, L. P. (2010). Hedonic price equilibria, stable matching, and optimal transport: Equivalence, topology, and uniqueness. Economic Theory, 42(2), 317-354.

Chiong, K. X., Galichon, A., \& Shum, M. (2016). Duality in dynamic discretechoice models. Quantitative Economics, 7(1), 83-115.

Choo, E., \& Siow, A. (2006). Who marries whom and why. Journal of Political Economy, 114(1), 175-201.

Ciscato, E., Dupuy, A., Fox, J., Galichon, A., \& Weber, S. (2020). Family dynamics: Marriage, fertility and divorce [In progress].

Cuturi, M. (2013). Sinkhorn distances: Lightspeed computation of optimal transport. Advances in Neural Information Processing Systems, 26.

Dantzig, G. B. (1951). A proof of the equivalence of the programming problem and the game problem. Activity analysis of production and allocation, (13), 330-338.

Duffie, D. (1992). Dynamic asset pricing theory (Princeton, Ed.).

Dupuy, A., \& Galichon, A. (2014). Personality traits and the marriage market. Journal of Political Economy, 122(6), 1271-1319.

Dupuy, A., Galichon, A., \& Sun, Y. (2019). Estimating matching affinity matrices under low-rank constraints. Information and Inference: A Journal of the IMA, 8(4), 677-689.

Ekeland, I., Galichon, A., \& Henry, M. (2012). Comonotonic measures of multivariate risks. Mathematical Finance, 22(1), 109-132.

Ekeland, I., Heckman, J. J., \& Nesheim, L. (2004). Identification and estimation of hedonic models. Journal of Political Economy, 112, S60S109.

Fox, Galichon, \& Corblet. (2020). A dynamic model of two-sided matching [In progress.].

Franklin, J., \& Lorenz, J. (1989). On the scaling of multidimensional matrices. Linear Algebra and its Applications, 114-115, 717-735.

Galichon, A., Henry-Labordère, P., \& Touzi, N. (2014). A stochastic control approach to no-arbitrage bounds given marginals, with an application to lookback options. The Annals of Applied Probability, 24(1), $312-336$.

Galichon, A. (2016). Optimal transport methods in economics (Princeton, Ed.).

Galichon, A., \& Henry, M. (2009). A test of non-identifying restrictions and confidence regions for partially identified parameters. Journal of Econometrics, 152(2), 186-196.

Galichon, A., \& Henry, M. (2011). Set identification in models with multiple equilibria. The Review of Economic Studies, 78 (4), 1264-1298.

Galichon, A., \& Henry, M. (2012). Dual theory of choice with multivariate risks. Journal of Economic Theory, 147(4), 1501-1516.

Galichon, A., Kominers, S. D., \& Weber, S. (2019). Costly concessions: An empirical framework for matching with imperfectly transferable utility. Journal of Political Economy, 127(6), 2875-2925.

Galichon, A., \& Salanié, B. (2021). Cupid's invisible hand: Social surplus and identification in matching models. Review of Economic Studies, forthcoming.

Galichon, A., Samuelson, L., \& Vernet, L. (2021). The equilibrium flow problem [In progress].

Guimarães, P., \& Portugal, P. (2010). A simple feasible procedure to fit models with high-dimensional fixed effects. Stata Journal, 10(4), 628649 .

Head, K., \& Mayer, T. (2013). Gravity equations: Workhorse, toolkit, and cookbook.

Henry-Labordere, P. (2020). Model-free hedging: A martingale optimal transport viewpoint - 1 st edi.

Idel, M. (2016). A review of matrix scaling and sinkhorn's normal form for matrices and positive maps.

Kelso, A. S., \& Crawford, V. P. (1982). Job matching, coalition formation, and gross substitutes. Econometrica, 50(6), 1483-1504.

Koenker, R. (2005). Quantile regression.

Koenker, R., \& Bassett, G. (1978). Regression quantiles. Econometrica, $46(1), 33-50$.

Koenker, R., \& Ng, P. (2005). Inequality constrained quantile regression. Sankhyā: The Indian Journal of Statistics (2003-2007), 67(2), 418440 .

Kuhn, H. W., Tucker, A. W. et al. (1958). John von neumann's work in the theory of games and mathematical economics. Bulletin of the American Mathematical Society, 64 (3, Part 2), 100-122.

Léger, F. (2020). A gradient descent perspective on sinkhorn. Applied Mathematics 8 Optimization.

Léonard, C. (2014). A survey of the schrödinger problem and some of its connections with optimal transport. Discrete $\&^{2}$ Continuous Dynamical Systems, $34(4), 1533$.

Murota, K. (1998). Discrete convex analysis. Mathematical Programming, 83(1), 313-371.

Ortega, J. M., \& Rheinboldt, W. C. (1970). Iterative solution of nonlinear equations in several variables.

Peyré, G., \& Cuturi, M. (2019). Computational optimal transport: With applications to data science. Foundations and Trends in Machine Learning, $11(5), 355-607$.

Rust, J. (1987). Optimal replacement of gmc bus engines: An empirical model of harold zurcher. Econometrica: Journal of the Econometric Society, 999-1033.

Santambrogio, F. (2015). Optimal transport for applied mathematicians: Calculus of variations, PDEs, and modeling. Birkhäuser Basel.

Shapley, L. S., \& Shubik, M. (1971). The assignment game i: The core. International Journal of Game Theory, 1(1), 111-130.

Silva, J. M. C. S., \& Tenreyro, S. (2006). The log of gravity. The Review of Economics and Statistics, 88(4), 641-658.

Strassen, V. (1965). The existence of probability measures with given marginals. The Annals of Mathematical Statistics, 36(2), 423-439.

Sun, N., \& Yang, Z. (2006). Equilibria and indivisibilities: Gross substitutes and complements. Econometrica, 74 (5), 1385-1402.

Villani, C. (2003). Topics in optimal transportation. American Mathematical Soc.

Villani, C. (2009). Optimal transport: Old and new. Springer-Verlag.

Von Neumann, J. (1953). 1. a certain zero-sum two-person game equivalent to the optimal assignment problem. Contributions to the theory of games (am-28), volume ii (pp. 5-12).

Wigner, E. P. (1960). The unreasonable effectiveness of mathematics in the natural sciences. richard courant lecture in mathematical sciences delivered at new york university, may 11, 1959. Communications on Pure and Applied Mathematics, 13(1), 1-14.

Wilson, A. G. (1969). The use of entropy maximising models, in the theory of trip distribution, mode split and route split. Journal of transport economics and policy, 108-126.


[^0]:    ${ }^{*}$ New York University and Sciences Po, Email: alfred.galichon@nyu.edu. Support from the European Research Council under Grant Agreement No. 866274 "Equiprice" as well as research assistance by Gabriele Buontempo and Giovanni Montanari are gratefully acknowledged.

[^1]:    ${ }^{1}$ See Idel (2016) for a historical survey.

[^2]:    ${ }^{2}$ Note that as $\varepsilon$ has a density, the probability of ties is zero, and therefore the arg max has almost surely one element.

