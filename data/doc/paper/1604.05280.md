# Asymptotic Convergence in Online Learning with Unbounded Delays 

Scott Garrabrant and Nate Soares and Jessica Taylor<br>Machine Intelligence Research Institute<br>\{scott,nate,jessica\}@intelligence.org


#### Abstract

We study the problem of predicting the results of computations that are too expensive to run, via the observation of the results of smaller computations. We model this as an online learning problem with delayed feedback, where the length of the delay is unbounded, which we study mainly in a stochastic setting. We show that in this setting, consistency is not possible in general, and that optimal forecasters might not have average regret going to zero. However, it is still possible to give algorithms that converge asymptotically to Bayesoptimal predictions, by evaluating forecasters on specific sparse independent subsequences of their predictions. We give an algorithm that does this, which converges asymptotically on good behavior, and give very weak bounds on how long it takes to converge. We then relate our results back to the problem of predicting large computations in a deterministic setting.


## 1 Introduction

We study the problem of predicting the results of computations that are too large to evaluate, given observation of the results of running many smaller computations. For example, we might have a physics simulator and want to predict the final location of a ball in a large environment, after observing many simulated runs of small environments.

When predicting the outputs of computations so large that they cannot be evaluated, generating training data requires a bit of creativity. Intuitively, one potential solution is this: Given enough computing resources to evaluate "medium-sized" computations, we could train a learner by showing it many runs of small computations, and having it learn to predict the medium-sized ones, in a way that generalizes well. Then we could feed it runs of many medium-sized computations and have it predict large ones. This is an online learning problem, where the learner observes the results of more and more expensive computations, and predicts the behavior of computations that are much more difficult to evaluate than anything it has observed so far.

The standard online learning setting, in which the learner predicts an outcome in a sequence after observing all previous outcomes, does not capture this problem, because delays between prediction and observation are the key feature. Dudik et al. [1], Joulani, György, and Szepesvári [2], and others have studied online learning with delayed feedback, but they assume that delays are bounded, whereas in our setting the delays necessarily grow ever-larger. In this paper, we propose an algorithm EvOp for online learning with unbounded delays. EvOp not a practical algorithm; it is only a first step towards modeling the problem of predicting large computations as an online learning problem.

Predicting a sequence generated by arbitrary computations is intractable in general. Consider, for instance, the bitstring that tells which Turing machines halt.

Research supported by the Machine Intelligence Research Institute (intelligence.org).

However, the problem is not hopeless, either: Consider the bitstring where the $n$th digit is a 1 if and only if the $10^{n}$ th digit in the decimal expansion of $\pi$ is a 7 . This is an online learning problem with ever-growing delays where a learner should be able to perform quite well. A learner that attempts to predict the behavior of computations in full generality will encounter some subsequences that it cannot predict, but it will encounter others that are highly regular, and it should be able to identify those and predict them well.

Consider, for instance, the bitstring that interleaves information about which Turing machines halt with the $10^{n}$ th digits of $\pi$. Intuitively, a good predictor should identify the second subsequence, and assign extreme probabilities whenever it has the computing resources to compute the digit, and roughly $10 \%$ probability otherwise, in lieu of other information about the digit. However, it's not clear how to formalize this intuition: What does it mean for a forecaster to have no relevant information about a digit of $\pi$ that it knows how to compute? What are the "correct" probabilities a bounded reasoner should assign to deterministic facts that it lacks the resources to compute?

In this paper, we sidestep those questions, by analyzing the problem in a stochastic setting. This lets us study the problem of picking out patterns in subsequences in the face of unbounded delays, in a setting where the "correct" probabilities that a predictor should be assigning are well-defined. In Section 5 we relate our findings back to the deterministic setting, making use of "algorithmic randomness" as described by, e.g., Downey and Hirschfeldt [3].

We propose an algorithm EvOp with the property that, on any subsequence for which an expert that it consults predicts the true probabilities, it converges to optimal behavior on that subsequence. We show that regret and average regret are poor measures of performance in this setting, by demonstrating that in environments with unbounded delays between prediction and feedback, optimal predictors can fail to have average regret going to zero. EvOp works around these difficulties by comparing forecasters on sparse subsequences of their predictions; this means that, while we can put bounds on how long it takes EvOp to converge, the bounds are very, very weak. Furthermore, EvOp is only guaranteed to converge to good behavior on subsequences when it has access to optimal experts; we leave it to future work to give a variant that can match the behavior of the best available expert even if it is non-optimal.

In Section 2 we define the problem of online learning with unbounded delays. In Section 3 we show that consistency is impossible and discuss other difficulties. In Section 4 we define EvOp, prove that it converges to Bayes-optimal behavior on any subsequence for which some expert makes Bayes-optimal predictions, and provide very weak bounds on how long convergence takes. In Section $\underline{5}$ we relate these results back to the deterministic setting. Section $\underline{6}$ concludes.

### 1.1 Related Work

An early example of online sequence learning using expert advice is Littlestone and Warmuth [4]; much work has been done since then to understand how to perform well relative to a given set of forecasters [ $\underline{5}, \underline{6}, \underline{7}$. Rakhlin and Sridharan [] improve performance of online learning algorithms assuming some structure in the environment, while maintaining worst-case guarantees. Gofer et al. [9] study the case with a potentially unbounded number of experts.

Most work in online learning has focused on the case where feedback is immediate. Piccolboni and Schindelhauer [10] study online prediction with less rigid feedback schemes, proving only weak performance bounds. Weinberger and Ordentlich [11] show that running experts on sub-sampled sequences can give better bounds, for the case with bounded feedback delay. In the widely studied bandit setting [12], some attention has been given to learning with bounded delays $[13,1]$. There have been some attempts to work with unbounded feedback delays $[14,15,16]$, with either strong assumptions on the target function or with weak performance bounds. Quanrud and Khashabi [17] achieve reasonable regret bounds in an adversarial setting; our work achieves asymptotic convergence in a stochastic setting. A review, and a very general framework for online learning with arbitrary (but bounded) feedback
delay is given by Joulani, György, and Szepesvári [2].

Online learning with delayed feedback has applications in domains such as webpage prefetching, since the prediction algorithm has to make some prefetching decisions before learning whether a previously fetched page ended up being requested by the user [18]. The idea of learning from computations with delay has seen some use in parallel computation, e.g., distributed stochastic optimization where computations of gradients may take longer in some nodes $[19,20]$.

Outside the field of online learning, our work has interesting parallels in the field of mathematical logic. Hutter et al. [21] and Demski [22] study the problem of assigning probabilities to sentences in logic while respecting certain relationships between them, a practice that dates back to Gaifman [23]. Because sentences in mathematical logic are expressive enough to make claims about the behavior of computations (such as "this computation will use less memory than that one"), their work can be seen as a different approach to the problems we discuss in this paper.

## 2 The Unbounded Delay Model

Let $\mathcal{X}$ be a set of possible outcomes and $\mathcal{Y}$ be a set of possible predictions, where $\mathcal{Y}$ is a convex subset of $\mathbb{R}^{n}$ for some $n$. Let $\mathcal{L}: \mathcal{X} \times \mathcal{Y} \rightarrow \mathbb{R}$ be a loss function measuring the difference between them, which is strongly convex (with strong convexity constant $\rho$ ) and Lipschitz (with Lipschitz constant $\kappa$ ). Roughly speaking, the environment will stochastically produce an infinite sequence of outcomes $x_{i}$, and an infinite sequence of observations $o_{i}$, where each $o_{i}$ contains information about finitely many $x_{n}$. Formally, for each $i=1,2, \ldots$, let $o_{i}: \mathbb{N} \rightarrow \mathcal{X}$ be a finite-domain partial function from indices to outcomes; in other words, $o_{i}$ is a set of $(n, x)$ "feedback" pairs such that each $n$ appears in at most one pair. We write $o_{i}(n)$ for the value of $x$ associated with $n$, which is feedback about the outcome $x_{n}$, and which may be undefined. If $o_{i}(n)$ is defined, we say that $o_{i}$ reveals $x_{n}$.

Formally, we write $\mathbf{X}_{i}$ for the random variable representing the $i$ th output and $\mathbf{O}_{i}$ for the random variable representing the $i$ th observation. We define the true environment $P$ to be a joint distribution over the $\mathbf{X}_{i}$ and the $\mathbf{O}_{i}$, such that if $o_{i}(n)=x_{n}$ then $P\left(\mathbf{O}_{i}=o_{i} \wedge \mathbf{X}_{n} \neq x_{n}\right)=0$, which means that all $o_{i}(n)$ which are defined agree on the value of $x_{n}$. We omit the random variables if we can do so unambiguously, writing, e.g., $P\left(x_{n} \mid o_{i}\right)$.

Note that there may exist $n$ such that $o_{i}(n)$ is not defined for any $i$, in which case the forecaster will never observe $x_{n}$. We write $o_{\prec i}$ for the list of observations up to time $i$, and $o_{\prec i}(n)$ for the value of $x_{n}$ if any observation in $o_{\prec i}$ reveals it.

We consider learning algorithms that make use of some set $\mathcal{F}$ of forecasters.

Definition 1. A forecaster is a partial function $f$ which takes as input $n$ observations $o_{\prec n}$ and might produce a prediction $y_{n} \in \mathcal{Y}$, interpreted as a prediction of $x_{n}$.

Because some outcomes may never be observed, and because forecasters are partial (and so may abstain from making predictions on certain subsequences of the outcomes), we will compare forecasters only on subsequences on which both are defined.

Definition 2. A subsequence $s$ of the outcomes is a monotonic strictly increasing list of natural numbers $s_{1} s_{2} \ldots$ We write $|s|$ for the length of $s$, which may be $\infty$. A forecaster $f$ is defined on $s$ if it outputs a prediction for all elements $s_{i}$ of $s$, i.e., if, for all $i \leq|s|, y_{s_{i}}:=f\left(o_{\prec s_{i}}\right)$ is defined.

We assume that at least one $f \in \mathcal{F}$ is defined everywhere. It may seem prohibitively expensive to evaluate $f\left(o_{\prec s_{i}}\right)$ if $s_{i}$ is large. For example, consider the subsequence $s=1,10,100, \ldots ; f$ only predicts $x_{10^{10}}$ after making $10^{10}$ observations, despite the fact that $x_{10^{10}}$ is the eleventh element in the subsequence. However, there is no requirement that observations contain lots of feedback: $o_{\prec s_{i}}$ might not reveal very much, even if $s_{i}$ is large.

The goal of a forecaster is to minimize its loss $\sum_{i=1}^{n} \mathcal{L}\left(x_{s_{i}}, y_{s_{i}}\right)$, for $n \geq 1$. Two forecasters can be compared by comparing their total loss.

Definition 3. Given a forecaster $f$ defined on a subsequence $s$ of length at least $n$, let

$$
\begin{equation*}
\mathcal{F}_{s}:=\left\{f^{\prime} \in \mathcal{F} \mid f^{\prime} \text { is defined on } s\right\} \tag{1}
\end{equation*}
$$

Then the regret of $f$ (on $s$, through $n$ ) is

$$
\begin{equation*}
R_{s}^{n}(f):=\max _{f^{\prime} \in \mathcal{F}_{s}} \sum_{t=i}^{n} \mathcal{L}\left(x_{s_{i}}, f\left(o_{\prec s_{i}}\right)\right)-\sum_{i=1}^{n} \mathcal{L}\left(x_{s_{i}}, f^{\prime}\left(o_{\prec s_{i}}\right)\right) \tag{2}
\end{equation*}
$$

$f$ is consistent (with respect to $\mathcal{F}_{s}$ ) if its average expected regret goes to zero, that is, if

$$
\begin{equation*}
\lim _{n \rightarrow \infty} \mathbb{E}\left[R_{s}^{n}(f)\right] / n=0 \tag{3}
\end{equation*}
$$

In our setting, consistency is too strong a guarantee to ask for, as we will see in Section 3. Instead, we present an algorithm Ev0p with the property that, whenever there is a forecaster $f \in \mathcal{F}$ that is Bayes-optimal on some subsequence, EvOp eventually learns to predict optimally on that subsequence.

Definition 4. A forecaster $f$ is Bayes-optimal (for the true environment, in its domain) if:

1. Everything $f$ predicts is almost surely eventually revealed. That is, if $f\left(o_{\prec n}\right)$ is defined, then with probability 1 there is some $N$ such that $o_{N}(n)$ is defined.
2. $f$ minimizes expected loss against the true environment whenever it makes a prediction. That is, if $y_{n}:=f\left(o_{\prec n}\right)$ is defined, then $y_{n}=\arg \min _{y} \mathbb{E}\left[\mathcal{L}\left(x_{n}, y\right) \mid\right.$ $\left.o_{\prec n}\right]$.

We will occasionally refer to a Bayes-optimal $f$ as simply "optimal".

The main result of our paper is this: Whenever there is an optimal forecaster $f \in F$ defined on $s$, our algorithm EvOp converges to optimal behavior on $s$.

Theorem 1. For any Bayes-optimal $f^{s} \in \mathcal{F}$ defined on $s$,

$$
\begin{equation*}
\lim _{n \rightarrow \infty}\left|\mathcal{L}\left(x_{s_{n}}, \operatorname{EvOp}\left(o_{\prec s_{n}}\right)\right)-\mathcal{L}\left(x_{s_{n}}, f^{s}\left(o_{\prec s_{n}}\right)\right)\right|=0 \tag{4}
\end{equation*}
$$

We call algorithms with this property eventually optimal. We will define EvOp in Section 4, and prove Theorem 1 in Section 4.1. Weak bounds on how long it takes EvOp to converge to Bayes-optimal behavior on any individual subsequence are given in Section 4.2.

Eventual optimality is a very strong condition, and only yields guarantees if $\mathcal{F}$ contains Bayes-optimal forecasters. In this paper we focus on showing that an eventually optimal predictor exists, and providing weak bounds on how long it takes it to converge to optimal behavior on a subsequence (and how much loss can be accumulated in the meantime). As we will see in Section 3, this is non-trivial. We leave the problem of converging on the best available forecaster of a subsequence (even if it is not optimal) to future research.

## 3 Difficulties in this Setting

Total regret and average regret are poor measures of forecaster performance in this setting, and consistency (as defined by Definition 3) is impossible in general. To show this, we will describe an environment $P^{\#}$ which exploits the long delays to make learning difficult.

$P^{\#}$ generates outcomes as follows. It flips a fair coin and reveals it once, and then flips another and reveals it ten times, then flips a third and reveals it one hundred times, and so on, always revealing the $k$ th coin $10^{k-1}$ times. The forecasters spend
one timestep predicting the first coin, ten timesteps predicting the second coin, one hundred timesteps predicting the third coin, and so on. The observations are set up such that they contain no information about the coin currently being predicted: The forecasters must predict the $k$ th coin all $10^{k-1}$ times before it is revealed.

Formally, let $\mathcal{X}:=\{\mathrm{H}, \mathrm{T}\}$ corresponding to "heads" and "tails" respectively. Let $\mathcal{Y}$ be the set of probability distributions over $\mathcal{X}$, which can be represented as real number $p \in[0,1] . P^{\#}$ is a Markov chain, where each $x_{i+1}$ is conditionally independent from all other outcomes given $x_{i} . P^{\#}\left(\mathbf{X}_{1}=\mathrm{H}\right)=0.5$. For $i=2,12,112,1112, \ldots, x_{i}$ "reveals a new coin" and is independent of $x_{i-1}: P$ \# $\left(\mathbf{X}_{i}=\mathrm{H} \mid \mathbf{X}_{i-1}=\cdot\right)=0.5$. For all other $i, x_{i}$ "reveals the same coin again:" $x_{i}=x_{i-1}$. Each $\mathbf{O}_{n}$ is a deterministic function of $\mathbf{X}_{1} \ldots \mathbf{X}_{n}$ which reveals the first $\left\lceil\log _{10}(n .9 / 10)\right\rceil$ outcomes. Let $\mathcal{L}$ be squared error; that is, let $\mathcal{L}(\mathrm{H}, p)=(1-p)^{2}$ and $\mathcal{L}(\mathrm{T}, p)=p^{2}$.

Clearly, the best prediction of $x_{n}$ that a forecaster can make given $o_{\prec n}$ is 0.5 , because $o_{\prec n}$ does not contain any information about the coin revealed by $x_{n}$, which is fair. Thus, the simple forecaster $f^{*}\left(o_{\prec n}\right)=0.5$ is Bayes-optimal. However, the regret of $f^{*}$ may be very high! To see this, consider a forecaster $f^{1}$, the "gambler," defined $f^{1}\left(o_{\prec n}\right)=1$. In expectation, $f^{1}$ will receive higher total loss on any subsequence of the true outcomes. However, $f^{1}$ will spend about half the time with a lower total loss than $f^{*}$, because each time a new coin begins being predicted, it has the opportunity to recoup all its losses.

$f^{*}$ accumulates loss at a rate of $1 / 4$ units per prediction, which means that, after the $k$ th coin has been predicted all $10^{k-1}$ times, its aggregate loss is $1 / 4 \cdot \sum_{i=1}^{k} 10^{i-1}$. $f^{1}$ accumulates either 0 or 1 unit of loss in each step according to whether the coin comes up heads or tails, so in the worst case, it will have $\sum_{i=1}^{k} 10^{i-1}$ total loss after the $k$ th coin. If the $k+1$ coin comes up heads, then $f^{*}$ gains an additional $1 / 410^{k}$ loss while $f^{1}$ 's loss remains unchanged. $10^{k}$ accounts for more than nine tenths of $\sum_{i=1}^{k} 10^{i}$, so if the coin came up heads then $f^{1}$ 's total loss is at most a tenth of $\sum_{i=1}^{k} 10^{i}$, whereas $f^{*}$ s total loss is a quarter of $\sum_{i=1}^{k} 10^{i}$. In fact, any predictor that assigns average probability $\leq 0.5$ across all $10^{k-1}$ reveals of the $k$ th coin will have at least $15 \%$ more loss than $f^{1}$ after the $\sum_{i=1}^{k}$ th step, if that coin comes up heads.

By a similar logic, whenever the $k$ th coin comes up tails, $f^{1}$ 's loss shoots up above that of $f^{*}$, no matter how lucky it was previously. Thus we see that if $f^{1} \in \mathcal{F}$, the regret of $f^{*}$ will swing wildly back and forth. Any predictor which is maintaining a mixture of forecasters and weighting them according to their regret will have trouble singling out $f^{*}$.

Indeed, if the environment is $P^{\#}$, and if $\mathcal{F}$ contains both $f^{1}$ and the opposite gambler $f^{0}$ defined as $f^{0}\left(o_{\prec n}\right)=0$, then it is impossible for a forecaster to be consistent in the sense of Definition 3. If the average probability a forecaster assigns to the $k$ th coin is $\leq 0.5$ and the coin comes up heads, it gets very high regret relative to $f^{1}$, whereas if it's $\geq 0.5$ and the coin comes up tails, it gets very high regret relative to $f^{0}$. The only way for a forecaster to avoid high regret against both gamblers is for it to place higher probability on the true result of the coin every single time. With probability 1 it must slip up infinitely often (because the coins are fair), so each forecaster's regret will be high infinitely often. And the amount of regret-at least $15 \%$ of all possible loss-is proportional to $n$, so $\lim _{n \rightarrow \infty} \mathbb{E}\left[R^{n}(f)\right] / n$ cannot go to zero.

Lest this seem like a peculiarity of the stochastic setting, observe that a similar problem could easily occur in the deterministic setting, when a learner is predicting the behavior of large computations. For example, imagine that the "coins" are chaotic subsystems inside a physics simulation, such that large environments have many correlated subsystems. In this case, some experts might start "gambling" by making extreme predictions about those subsystems, and it may become difficult to distinguish the accurate forecasters from the gamblers, while looking at total or average regret.

The first fix that comes to mind is to design a predictor with a learning rate that decays over time. For example, if the learner weights the loss on $x_{n}$ by $1 / 10 n$ then it will assign each cluster of $10^{k-1}$ predictions roughly equal weight, thereby
neutralizing the gamblers. However, this fix is highly unsatisfactory: It runs into exactly the failures described above on the environment $P_{2}^{\#}$ which reveals the $k$ th coin $10^{10^{k}}$ times instead. It might be the case that for each specific environment one could tailor a learning rate to that environment that allows a predictor to successfully distinguish the optimal forecasters from the gamblers using regret, but this would be an ad-hockery tantamount to hardcoding the optimal forecaster in from the beginning. This motivates the study of how a predictor can successfully identify optimal experts at all in this setting.

## 4 The EvOp Algorithm

Section 3 showed that in this setting, it is possible for gamblers to take advantage of correlated outputs and unbounded delays to achieve drastic swings in their total loss, which makes total and average regret bad measures of a forecaster. We can address this problem by comparing forecasters only on independent subsequences of outcomes on which they are both defined.

Intuitively, the gamblers are abusing the fact that they can correlate many predictions before any feedback on those predictions is received, so we can foil the gamblers by assessing them only on a subsequence of predictions where each prediction in the subsequence was made only after receiving feedback on the previous prediction in the subsequence. EvOp is an algorithm which makes use of this intuition, and Theorem 1 shows that it is sufficient to allow EvOp to zero in on Bayes-optimal predictors regardless of what strategies other forecasters in $\mathcal{F}$ use.

Definition 5. A sequence $s$ is independent if, for all $i>1, o_{s_{i}}\left(s_{i-1}\right)$ is defined.

```
Algorithm 1: EvOp, an eventually optimal predictor. $\|\cdot\|$ is the $l^{2}$ norm, and
$1 / 0=\infty$.
    Input: $o_{\prec n}$, the first $n$ observations
    Data: $\varepsilon$, an arbitrary constant $<1$
    // Computes an independent subsequence on which $f_{i}$ and $f_{j}$
        disagree.
    def testseq ${ }_{n}(i, j, m)$ :
        $t \leftarrow 0$
        waiting $\leftarrow$ false
        for $k$ in $1,2, \ldots, n$ :
            if waiting and $t \in \operatorname{dom}\left(o_{k}\right)$ :
                output ( $k$ )
                waiting $\leftarrow$ false
            elif $y_{k}^{i}:=f_{i}\left(o_{\prec k}\right)$ and $y_{k}^{j}:=f_{j}\left(o_{\prec k}\right)$ are defined, and $\left\|y_{k}^{i}-y_{k}^{j}\right\|>1 / m$ :
                $t \leftarrow k$
                waiting $\leftarrow$ true
    // Computes the difference between the scores of $f_{i}$ and $f_{j}$ on an
        independent subsequence on which they disagree.
    def relscore ${ }_{n}(i, j, m)$ :
        $s \leftarrow$ testseq $_{n}(i, j, m)$
        return $\sum_{k=1}^{|s|}\left(\mathcal{L}\left(x_{s_{k}}, y_{s_{k}}^{i}\right)-\mathcal{L}\left(x_{s_{k}}, y_{s_{k}}^{j}\right)-\frac{\rho \varepsilon}{2 m^{2}}\right)$
    def $\operatorname{maxscore}_{n}(i)$ :

```

![](https://cdn.mathpix.com/cropped/2024_06_04_5b5259c2f9b9372c31d2g-06.jpg?height=48&width=873&top_left_y=2166&top_left_x=534)

```
    $f \leftarrow \min _{i \in \mathbb{N} \geq 1}$ such that $o_{\prec n} \in \operatorname{dom}\left(f_{i}\right) \operatorname{maxscore}_{n}(i)$
    return $f\left(o_{\prec n}\right)$
```

EvOp works as follows. Fix an enumeration $f_{1}, f_{2}, \ldots$ of $\mathcal{F}$, which must be countable but need not be finite; we can assume without loss of generality that this
enumeration is countably infinite. EvOp compares $f_{i}$ to $f_{j}$ by giving it a relative score, which is dependent on the difference between their loss measured only on an independent subsequence of predictions on which they are both defined, constructed greedily. Lower scores are better for $f_{i}$. The score is also dependent on $\rho$, the strong convexity constant for $\mathcal{L}$, and an arbitrary positive $\varepsilon<1$, which we use to ensure that if $f_{i}$ and $f_{j}$ make different predictions infinitely often then their scores actually diverge. EvOp follows the prediction of the $f_{i}$ chosen by minimaxing this score, i.e., it copies the $f_{i}$ that has the smallest worst-case score relative to any other $f_{j}$. Pseudocode for EvOp is given by Algorithm 1 .

To see that the max step terminates, note that it can be computed by checking only finitely many $j$ and $m$ : relscore ${ }_{n}(i, j, m)$ is bounded above by $\sum_{k=1}^{|s|} \mathcal{L}\left(x_{k}, y_{k}^{i}\right)$, so all $(j, m)$ pairs such that $j+m$ is greater than this value may be discarded. To see that the min step terminates, note that it can be computed by checking only finitely many $i$ (assuming that at least one $f$ is defined on $o_{\prec n}$ ), because when $m=0$, testseq $_{n}(i, j, m)$ is empty; thus when $j=1$ and $m=0$, $\operatorname{maxscore}_{n}(i, j, m)$ is at least $i-1$. Therefore, after finding the smallest $k$ such that $f_{k}$ is defined on $o \prec n$, the min step need only continue searching up through $i=\operatorname{maxscore}_{n}(k)+1$.

EvOp gets around the problems of Section $\underline{3}$ by comparing forecasters only on greedily-constructed independent subsequences of the outcomes. Note that if the delay between prediction and feedback grows quickly, these subsequences might be very sparse. For example, in the environment $P^{\#}$ of Section $\underline{3}$, the independent subsequence will have at least $10^{i}$ timesteps between the $i-1$ st element in the subsequence and the next. This technique allows Ev0p to converge on Bayes-optimal behavior, but it also means that it may do so very slowly (if the subsequence is very sparse). Under certain assumptions about the speed with which delays grow and the frequency with which forecasters disagree, it is possible to put bounds on how quickly EvOp converges on Bayes-optimal behavior, as discussed in Section 4.2. However, these bounds are quite weak.

### 4.1 Proof of Theorem 1

To prove Theorem 1 we need two lemmas, which, roughly speaking, say that (1) if $f_{z}$ is Bayes-optimal then maxscore ${ }_{n}(z)$ is bounded; and (2) if $f_{j}$ is not Bayes-optimal and some $f_{z} \in \mathcal{F}$ is, then $\operatorname{maxscore}_{n}(j)$ goes to infinity. From there, the proof is easy.

In what follows, let $f_{z}$ be a Bayes-optimal forecaster (as per Definition 4) that makes infinitely many predictions all of which are almost surely eventually revealedthat is, such that $f_{z}\left(o_{\prec n}\right)$ is almost surely defined infinitely often, and whenever it is defined, $o_{i}(n)$ is almost surely defined for some $i$. Let $z$ be the index of $f_{z}$ in the enumeration over $\mathcal{F}$. In general, we will write $y_{n}^{i}$ for $f_{i}\left(o_{\prec n}\right)$ when it is defined.

Lemma 1. If $f_{z}$ is Bayes-optimal and makes infinitely many predictions all of which are almost surely eventually revealed, then with probability 1 , maxscore ${ }_{n}(z)$ is bounded.

Proof. For all $j$, relscore ${ }_{n}(z, j, 0)=0$, because testseq ${ }_{n}(z, j, 0)$ never outputs. Thus, maxscore ${ }_{n}(z)$ is bounded below by $z-1$ (consider the case where $j=1$ and $m=0$ ) and bounded above by $z-j-m+\operatorname{relscore}(z, j, m)$. When $m=0$ this is bounded above by $z-j$, so it suffices to show that there is almost surely some bound B such that relscore ${ }_{n}(z, j, m)-j-m$ is bounded above by B for every $j$ and $m \geq 1$.

Intuitively, in expectation, relscore ${ }_{n}(z, j, m)$ should either be finite or diverge to $-\infty$, because $f_{z}$ is Bayes-optimal and is only being compared to other forecasters on independent subsequences. We will prove not only that it's bounded above in expectation, but that it is bounded above with probability 1. To do this we use Lemma $\underline{3}$ in Appendix A, which (roughly speaking) says that something which is zero in expectation, and which has "not too much" variance in expectation, can't get too far from zero in fact.

Fix $j, m \geq 1$, and $\lambda$; we will bound the probability that relscore $\operatorname{se}_{n}(z, j, m) \geq \lambda$. Let $s=s_{1} s_{2} \ldots$ be the outputs of testseq ${ }_{\infty}(x, j, m)$, that is, the entire greedily-
generated sparse independent subsequence of outputs on which both $f_{z}$ and $f_{j}$ make predictions that differ by at least $1 / m$ (which could be generated by running testseq $_{n}(x, j, m)$ on larger and larger $\left.n\right)$. $s$ may or may not be finite.

Because $\mathcal{L}$ is strongly convex,

$$
\begin{equation*}
\mathcal{L}\left(x_{k}, y_{k}^{j}\right) \geq \mathcal{L}\left(x_{k}, y_{k}^{z}\right)+\underset{y}{\nabla} \mathcal{L}\left(x_{k}, y_{k}^{z}\right) \cdot\left(y_{k}^{j}-y_{k}^{z}\right)+\frac{\rho}{2}\left\|y_{k}^{j}-y_{k}^{z}\right\|^{2} \tag{5}
\end{equation*}
$$

where $\nabla_{y}$ takes the gradient of $\mathcal{L}$ with respect to the prediction, $\rho$ is the strong convexity constant of $\mathcal{L}$, and $\|\cdot\|$ is the $l^{2}$ norm. In other words, the loss of $f_{j}$ in any given round is at least that of $f_{z}$ plus a linear term (which, note, is related to the Lipschitz constant of $\mathcal{L}$ ) plus a quadratic term. Rearranging this inequality,

$$
\begin{equation*}
\mathcal{L}\left(x_{k}, y_{k}^{z}\right)-\mathcal{L}\left(x_{k}, y_{k}^{j}\right) \leq-\underset{y}{\nabla} \mathcal{L}\left(x_{k}, y_{k}^{z}\right) \cdot\left(y_{k}^{j}-y_{k}^{z}\right)-\frac{\rho}{2}\left\|y_{k}^{j}-y_{k}^{z}\right\|^{2} \tag{6}
\end{equation*}
$$

We will show that the sum of the right-hand side for $k=1,2, \ldots, n$ is bounded, using Lemma 3 .

Lemma 3 requires a sequence of random variables $G_{1} H_{1} G_{2} H_{2} \ldots$ that form a Markov chain, and two real-valued functions $v$ and $r$ defined on the $G_{i}$ and the $H_{i}$ respectively, such that $\mathbb{E}\left[r\left(H_{i}\right) \mid v\left(G_{i}\right)\right]=0$, and $\left|r\left(H_{i}\right)\right| \leq a \sqrt{v\left(G_{i}\right)}$ for some constant $a$. Intuitively, these constraints say that $r$ is zero in expectation, and that its absolute value is bounded by $v$. Lemma $\underline{3}$ then gives us a bound on the probability that $\sum_{i=1}^{n} r\left(H_{i}\right)-v\left(G_{i}\right) \geq \lambda$. We use it with $r$ as the first term on the right-hand side of equation (6), and $v$ as the negative of the second. Roughly, $r$ can be thought of as a first-order approximation to the amount by which $f_{j}$ did better than expected (a "residual"), and $v$ as a bound on how wildly $r$ can swing (a "variance").

Let $G_{i}$ be $o_{\prec s_{i}}{ }^{1}$ and $H_{i}$ be $o_{\prec k}$ where $k$ is the least time after $s_{i}$ such that $s_{i} \in \operatorname{dom}\left(o_{k}\right) . k$ exists, because $f_{z}$ only makes predictions that, with probability 1 , are eventually revealed. Intuitively, our Markov chain alternates between elements of $s$ and the times when those elements were revealed. For $i>|s|$, let $G_{i}=H_{i}=o_{\prec \infty}$, the (infinite) combination of all observations.

Define $r$ to be the function $r\left(H_{i}\right)=-\nabla_{y} \mathcal{L}\left(x_{s_{i}}, y_{s_{i}}^{z}\right) \cdot\left(y_{s_{i}}^{j}-y_{s_{i}}^{z}\right)$ when $i \leq|s|$, and 0 otherwise. Observe that this value can be calculated from $H_{i}, f_{z}$, and $f_{j}$, because $H_{i}=o_{\prec k}$, with $k>s_{i}$ and $x_{s_{i}}:=o_{\prec k}\left(s_{i}\right)$ defined.

Define $v$ to be the function $v\left(G_{i}\right)=\frac{\rho}{2}\left\|y_{s_{i}}^{j}-y_{s_{i}}^{z}\right\|^{2}$ when $i \leq|s|$, and $\rho / 2 m^{2}$ otherwise, which can be calculated from $G_{i}, \stackrel{s_{i}}{f_{z}}$, and $f_{j}$, because $G_{i}$ is just $o_{\prec s_{i}}$. Note that $\mathbb{E}\left[r\left(H_{k}\right) \mid G_{k}\right]=0$, because $f_{z}$ is a Bayes-optimal predictor, which means it minimizes expected loss, making the gradient in $r\left(H_{i}\right)$ zero in expectation for all $i$. Note also that because $\mathcal{L}$ is Lipschitz, $\left|r\left(H_{k}\right)\right| \leq \kappa\left\|y_{n}^{j}-y_{n}^{z}\right\|$ where $\kappa$ is the Lipschitz constant of $\mathcal{L}$. Thus, with $a=\frac{\kappa \sqrt{2}}{\sqrt{\rho}},\left|r\left(H_{k}\right)\right| \leq a \sqrt{v\left(G_{k}\right)}$. Therefore, $r$ and $v$ meet the conditions of Lemma $\underline{3}$, so for all $M$,

$$
\begin{equation*}
\mathbb{P}\left(\sum_{i=1}^{n} r\left(H_{i}\right)-v\left(G_{i}\right) \geq M\right) \leq \exp \left(-\rho \kappa^{-2} M\right) \tag{7}
\end{equation*}
$$

which goes to 0 as $M$ goes to infinity. We need a bound that forces it to 0 as $n \rightarrow \infty$. In what follows, we write $b=\rho \kappa^{-2}$ for conciseness.

Observe that relscore ${ }_{n}(z, j, m) \leq \sum_{i=1}^{t_{n}}\left(r\left(H_{i}\right)-v\left(G_{i}\right)-\rho \varepsilon / 2 m^{2}\right)$, where $t_{n}$ is the number of times testseq $(z, \bar{j}, m)$ outputs. Thus, the probability that relscore ${ }_{n}(z, j, m) \geq \Lambda$ for any $\Lambda$ is upper-bounded by the probability that, for some $n$,

$$
\begin{equation*}
\left(\sum_{i=1}^{t_{n}} r\left(H_{i}\right)-v\left(G_{i}\right)\right)-t_{n} \frac{\rho \varepsilon}{2 m^{2}} \geq \Lambda \tag{8}
\end{equation*}
$$[^0]

For any given $n$ and $t$, applying inequality (7) with $\Lambda+t \frac{\rho \varepsilon}{2 m^{2}}$ for $M$,

$$
\begin{equation*}
\mathbb{P}\left(\sum_{i=1}^{t_{n}} r\left(H_{i}\right)-v\left(G_{i}\right) \geq \Lambda+t \frac{\rho \varepsilon}{2 m^{2}}\right) \leq \exp \left(-b\left(\Lambda+\frac{t \rho \varepsilon}{2 m^{2}}\right)\right) \tag{9}
\end{equation*}
$$

We now see the function of the $\rho \varepsilon / 2 m^{2}$ term in relscore: it adds a tiny bias in favor of the forecaster being judged, such that the longer a contender waits to prove itself, the more it has to prove. Equation (9) says that, because $f_{j}$ never proves itself too much in expectation, the probability that $f_{z}$ 's score relative to $f_{j}$ goes strongly in $f_{j}$ 's favor gets lower as $t_{n}$ gets larger.

Note that relscore ${ }_{n}(z, j, m)$ only depends on $n$ through $t_{n}$ : If $t_{n_{1}}=$ $t_{n_{2}}$ for some $n_{1}$ and $n_{2}$ then relscore $n_{1}(z, j, m)=$ relscore $_{n_{2}}(z, j, m)$. Thus, $\mathbb{P}\left(\exists n\right.$ : relscore $\left.{ }_{n}(z, j, m)>\Lambda\right)$ can be bounded by summing only over the possible values $t$ of $t_{n}$.

$$
\begin{equation*}
\sum_{t=0}^{\infty} \exp \left(-b \Lambda+t\left(-\frac{b \rho \varepsilon}{2 m^{2}}\right)\right)=\frac{\exp (-b \Lambda)}{1-\exp \left(-\frac{b \rho \varepsilon}{2 m^{2}}\right)} \tag{10}
\end{equation*}
$$

and $m \geq 1$, so

$$
\begin{equation*}
\mathbb{P}(\exists n: \operatorname{relscore}(z, j, m) \geq \Lambda) \leq \frac{\exp (-b \Lambda)}{1-\exp (-b \rho \varepsilon / 2)} \tag{11}
\end{equation*}
$$

Applying inequality (11) with $\lambda+m+j$ for $\Lambda$, we see that the probability relscore ${ }_{n}(z, j, m) \geq \lambda+m+j$ is at most

$$
\begin{equation*}
\sum_{m=1}^{\infty} \sum_{j=1}^{\infty} \frac{\exp (-b(\lambda+m+j))}{1-\exp (-b \rho \varepsilon / 2)}=\frac{\exp (-b(\lambda+2))}{(1-\exp (-b \rho \varepsilon / 2))(1-\exp (-b))^{2}} \tag{12}
\end{equation*}
$$

This goes to 0 as $\lambda$ goes to $\infty$. Therefore, with probability 1 , there exists some bound $B$ such that relscore ${ }_{n}(z, j, m)-m-j<B$ for all $j$ and $m \geq 1$. Thus, $\operatorname{maxscore}_{n}(z)$ is almost surely bounded.

Lemma 2. If $f_{z}$ is Bayes-optimal and makes infinitely many predictions all of which are almost surely eventually revealed, then for any $f_{j}$, with probability 1 , if $y_{i}^{z}:=$ $f_{z}\left(o_{\prec i}\right)$ and $y_{i}^{j}:=f_{j}\left(o_{\prec i}\right)$ are both defined on the same $t$ infinitely often, and if $\left\|y_{i}^{z}-y_{i}^{j}\right\| \geq \delta$ infinitely often for some $\delta>0$,

$$
\begin{equation*}
\lim _{n \rightarrow \infty} \operatorname{maxscore}{ }_{n}(j)=\infty \tag{13}
\end{equation*}
$$

Roughly speaking, the proof runs as follows. Choose $m$ such that $1 / m<\delta$. It suffices to show that relscore ${ }_{n}(j, z, m) \rightarrow \infty$ as $n \rightarrow \infty$. The $\sum\left(\mathcal{L}\left(x_{k}, y_{k}^{j}\right)-\mathcal{L}\left(x_{k}, y_{k}^{z}\right)\right)$ portion goes to infinity in expectation, and also goes to infinity with probability 1 by Lemma 3. It remains to show that the $\sum \rho \varepsilon / 2 m^{2}$ terms working in $f_{j}$ 's favor are not sufficient to prevent the total from going to infinity, which can be done by showing that the differences between $\mathcal{L}\left(x_{k}, y_{k}^{j}\right)$ and $\mathcal{L}\left(x_{k}, y_{k}^{j}\right)$ are at least $\rho / 2 m^{2}>\rho \varepsilon / 2 m^{2}$ in expectation, and appealing again to Lemma 3. The proof proceeds similarly to the proof of Lemma 1, so we leave the details to Appendix B.

With these lemmas in place, we now prove that EvOp is eventually optimal. Recall Theorem 1:

Theorem 1. For any Bayes-optimal $f^{s} \in \mathcal{F}$ defined on $s$,

$$
\begin{equation*}
\lim _{n \rightarrow \infty}\left|\mathcal{L}\left(x_{s_{n}}, \operatorname{EvOp}\left(o_{\prec s_{n}}\right)\right)-\mathcal{L}\left(x_{s_{n}}, f^{s}\left(o_{\prec s_{n}}\right)\right)\right|=0 \tag{4}
\end{equation*}
$$

Proof. Let $f_{z}$ be Bayes-optimal and defined infinitely often, such that everything it predicts is almost surely eventually revealed. It suffices to show that, with probability 1 , if $f_{z}\left(o_{\prec n}\right)$ is defined then

$$
\begin{equation*}
\lim _{n \rightarrow \infty}\left\|\operatorname{EvOp}\left(o_{\prec n}\right)-f_{z}\left(o_{\prec n}\right)\right\|=0 \tag{14}
\end{equation*}
$$

By Lemma 1, maxscore $(z)$ is bounded with probability 1. Let $B$ be this bound. Note that there are only finitely many $i$ such that $\operatorname{maxscore}_{n}(i) \leq B$, for the same reason that the min step always terminates. For each of those $i$, either $f_{i}$ and $f_{z}$ converge to the same prediction, or they only make finitely many predictions in common, or (by Lemma 2) maxscore $(i) \rightarrow \infty$. The latter contradicts the assumption that maxscore $(i) \leq B$. If $f_{i}$ and $f_{z}$ only make finitely many predictions in common, then for sufficiently large $n, f_{i}$ is not defined and so will not be selected. Thus, we need only consider the case where $f_{i}$ and $f_{z}$ converge to the same predictions whenever they both make predictions. In this case, $\operatorname{EvOp}\left(o_{\prec n}\right)$ is choosing among finitely many forecasters all of which converge to $f_{z}\left(o_{\prec n}\right)$, so $\operatorname{EvOp}\left(o_{\prec n}\right)$ must converge to $f_{z}\left(o_{\prec n}\right)$.

### 4.2 Bounds

The speed with which EvOp converges to optimal behavior on a subsequence depends on both (1) the sparseness of independent subsequences in the outcomes; and (2) the frequency with which forecasters make claims that differ.

Specifically, assume that all forecasters are defined everywhere and disagree infinitely often, and that $\mathcal{F}$ is finite. (The first two constraints imply the third.) We can show that, given a (potentially fast-growing) function $h$ bounding how long it takes before predictors disagree with each other, and given another (potentially fastgrowing) function $g$ bounding the delay in feedback, and given a probability $p$, the time it takes before EvOp has converged on $f_{z}$ with probability $p$ is proportional to $h \circ g$ iterated a number of times proportional to $\log p$. (Note that $h$ and $g$ are not uniform bounds; $g(n)$ is the maximum delay between the $n$th prediction and feedback on the $n$th prediction, and delays may grow ever larger as $n$ increases.)

Theorem 2. Given $h, g$, a Bayes-optimal $f_{z}$, and a probability $p$, there is an $N \propto$ $(h \circ g)^{\log p}(1)$ such that, with probability at least $1-p$, for all $n \geq N$,

$$
\begin{equation*}
\operatorname{EvOp}\left(o_{\prec n}\right)=f_{z}\left(o_{\prec n}\right) \tag{15}
\end{equation*}
$$

We prove Theorem 2 in Appendix C.

To call these bounds "weak" is an understatement. In the case where the outcomes are generated by running a universal Turing machine $U$ on different inputs, $g$ is infinite, because $U$ will sometimes fail to output. It is possible to achieve much better bounds given certain simplifying assumptions, such as delays that are finite in expectation [2]. However, it is not yet clear which simplifying assumptions to use, or what bounds to ask for, in the setting with ever-growing delays.

## 5 The Deterministic Setting

Our motivation for studying online learning with unbounded delays in a stochastic setting is that this gives us a simplified model of the problem of predicting large computations from observations of smaller ones. We have already seen one instance of an issue in the stochastic setting which looks likely to have an analog in the deterministic setting. In Section 3 we gave the example of a deterministic "coin" that appears more and more often in larger and larger computations, which might (for instance) be a common subsystem in the environment of a physical simulation. Intuitively, if there are many correlated subsystems that appear "sufficiently random" to all forecasters, then forecasters might follow the strategies of $f^{1}$ and $f^{0}$ in Section 3 and achieve regular large swings in their total loss. Intuitively, the techniques used in Algorithm 1 to handle the problem in the stochastic case should well carry over to
the deterministic case, but any attempt to formalize this intuition depends on what it means for a deterministic sequence to be "sufficiently random."

For that we turn to algorithmic information theory, a field founded by MartinLöf [24] which studies the degree and extent to which fixed bitstrings can be called "random." In their canonical text, Downey and Hirschfeldt [3] give three different definitions of algorithmic randomness and show them all to be equivalent. The oldest of the three, given by Martin-Löf [24], is rooted in the idea that an algorithmically random sequence should satisfy all computably verifiable properties that hold with probability 1 on randomly generated sequences.

It is with this definition in mind that we note that Lemma 1 and Lemma 2 are both stated as properties that are true of randomly generated sequences with probability 1 . Lemma 1 says that if the outputs of the environment are generated randomly, then with probability 1 , the score of a Bayes-optimal predictor does not go to infinity. Lemma 2 says that if the outputs of the environment are generated randomly, then with probability 1 , a predictor that disagrees by $\delta>0$ with a Bayesoptimal predictor infinitely many times has its score going to infinity. Both these computable properties hold for random sequences with probability 1 , so they hold for Martin-Löf-random sequences.

This means that if $\mathcal{F}$ is the class of all Turing machines, and EvOp is predicting an algorithmically random sequence (such as Chaitin's $\Omega$, the fraction of Turing machines which halt), then Theorem 1 holds and EvOp will converge on optimal predictions on subsequences of that sequence. However, this does us no good: There are no computable patterns in Chaitin's $\Omega$; computable forecasters won't be able to do any better than predicting a $50 \%$ chance of a 1 . Besides, the goal is not to predict uncomputable sequences by running all Turing machines. The goal is to predict large computations using efficient (e.g., polynomial-time) experts.

What we need is a notion of algorithmic randomness with respect to a restricted class of experts. For example, if $\mathcal{F}$ is the class of polynomial-time forecasters, we would like a notion of sequences which are algorithmically random with respect to polynomial-time forecasters.

The authors do not yet know of a satisfactory definition of algorithmic randomness with respect to resource constraints. However, the obvious analog of MartinLöf's original definition [24] is that a sequence should be defined as algorithmically random with respect to a class of bounded experts if, and only if, it satisfies all properties that hold of randomly generated sequences with probability 1 and that can be checked by one of those experts. On sequences that are algorithmically random with respect to $\mathcal{F}$ in this sense, Lemma 1 and Lemma 2 must apply: Assume $f_{z}$ is a Bayes-optimal predictor on a subsequence that is algorithmically random with respect to $\mathcal{F}$; any forecaster $f_{j} \in \mathcal{F}$ that outperforms $f_{z}$ infinitely often would be identifying a way in which the sequence fails to satisfy a property that randomly generated sequences satisfy with probability 1 , which contradicts the assumption. This gives strong reason to expect that EvOp would be eventually optimal when predicting sequences that are algorithmically random with respect to $\mathcal{F}$, even though formalizing such a notion remains an open problem.

Even so, this does not mean that EvOp would perform well at the actual task of predicting large computations from the observation of small ones. Eventual optimality provides no guarantees about the ability of the algorithm to converge on good but non-optimal predictors, and the bounds that we have on how long it takes EvOp to converge on good behavior are weak (to say the least).

Furthermore, there are other notions of what it means to "predict computations well" that are not captured by eventual optimality. For example, Demski [22] discusses the problem of computably assigning probabilities to the outputs of computations and refining them in such a way that they are "coherent," drawing on inspiration from the field of mathematical logic that dates at least back to Gaifman [23]. The intuition is that given two statements "this computation will halt and output 1" and "this computation will fail to halt or output something besides 1," a good reasoner should assign those claims probabilities that sum to roughly 1 . We have no reason to expect that EvOp has any such property.

## 6 Conclusions

We have studied online learning in a setting where delays between prediction and observation may be unbounded, in attempts to explore the general problem of predicting the behavior of large computations from observations of many small ones. We found that, in the stochastic setting, the unbounded delays give rise to difficulties: Total regret and average regret are not good measures of forecaster success, and consistency is not possible to achieve in general. However, it is possible to converge on good predictions by comparing forecasters according to their performance only on sparse and independent subsequences of the observations, and we have reason to expect that some of the techniques used to achieve good performance in the stochastic setting will carry over into the deterministic setting. We have proposed an algorithm EvOp that converges to optimal behavior. It is not a practical algorithm, but it does give a preliminary model of online learning in the setting where the delay between prediction and feedback is ever-growing.

Our results suggest a few different paths for future research. EvOp handles the problem of learning in the face of potentially unbounded delays by comparing forecasters only on subsequences that are potentially very sparse, and this means that it converges to optimal behavior quite slowly. Speeding up convergence without falling prey to the problems described in Section 3 might prove difficult. Furthermore, EvOp only guarantees convergence on forecasters that are Bayes-optimal; it is not yet clear how to converge on the best available forecaster (even if it is non-optimal) in the face of unbounded delays. As mentioned in Section 5, a formal notion of algorithmic randomness with respect to a bounded class of experts would make it easier to study the problem of using online learning to predict the behavior of large computations in a deterministic setting. EvOp is only a first step towards a predictor that can learn to predict the behavior of large computations from the observation of small ones, and the problem seems ripe for further study.

## A Proof of Lemma 3

Lemma 3. Let $\mathcal{G}$ and $\mathcal{H}$ be sets, and let $G_{1}, H_{1}, G_{2}, H_{2}, \ldots, G_{n}, H_{n}$ be random variables forming a Markov chain (with each $G_{i} \in \mathcal{G}$ and $H_{i} \in \mathcal{H}$ ). Let there be functions $v: \mathcal{G} \rightarrow \mathbb{R}_{\geq 0}$ and $r: \mathcal{H} \rightarrow \mathbb{R}$, with $\left|r\left(H_{i}\right)\right| \leq a \sqrt{v\left(G_{i}\right)}$ and $\mathbb{E}\left[r\left(H_{i}\right) \mid G_{i}\right] \leq 0$. Let $\lambda>0$. Then

$$
\begin{equation*}
P\left(\sum_{i=1}^{n}\left(r\left(F_{i}\right)-v\left(G_{i}\right)\right) \geq \lambda\right) \leq \exp \left(-2 / a^{2} \lambda\right) \tag{16}
\end{equation*}
$$

Proof. This proof closely follows the standard proof of Azuma's inequality, given by, e.g., DasGupta [25]. Let $b=2 / a^{2}$. Using Markov's inequality:

$$
\begin{align*}
& P\left(\sum_{i=1}^{n}\left(r\left(H_{i}\right)-v\left(G_{i}\right)\right) \geq \lambda\right) \\
& \quad=P\left(\exp \left(b \sum_{i=1}^{n}\left(r\left(H_{i}\right)-v\left(G_{i}\right)\right)\right) \geq \exp (b \lambda)\right)  \tag{17}\\
& \quad \leq \exp (-b \lambda) \mathbb{E}\left[\exp \left(b \sum_{i=1}^{n}\left(r\left(H_{i}\right)-v\left(G_{i}\right)\right)\right]\right.
\end{align*}
$$

To bound the expectation, we will inductively show that for all $m \leq n$,

$$
\begin{equation*}
\mathbb{E}\left[\exp \left(b \sum_{i=1}^{m}\left(r\left(H_{i}\right)-v\left(G_{i}\right)\right)\right)\right] \leq 1 \tag{18}
\end{equation*}
$$

When $m=0$, this is trivial. Otherwise:

$$
\begin{align*}
& \mathbb{E}\left[\exp \left(b \sum_{i=1}^{m}\left(r\left(H_{i}\right)-v\left(G_{i}\right)\right)\right)\right] \\
& =\mathbb{E}\left[\exp \left(b \sum_{i=1}^{m-1}\left(r\left(H_{i}\right)-v\left(G_{i}\right)\right)\right) \exp \left(-b v\left(G_{m}\right)\right) \mathbb{E}\left[e^{b r\left(H_{m}\right)} \mid G_{m}\right]\right] \\
& \leq \mathbb{E}\left[\exp \left(b \sum_{i=1}^{m-1}\left(r\left(H_{i}\right)-v\left(G_{i}\right)\right)\right) \exp \left(-b v\left(G_{m}\right)\right) \exp \left(b^{2} a^{2} v\left(G_{m}\right) / 2\right)\right]  \tag{19}\\
& =\mathbb{E}\left[\exp \left(b \sum_{i=1}^{m-1}\left(r\left(H_{i}\right)-v\left(G_{i}\right)\right)\right) \exp \left(-b v\left(G_{m}\right)+b v\left(G_{m}\right)\right)\right] \\
& =\mathbb{E}\left[\exp \left(b \sum_{i=1}^{m-1}\left(r\left(H_{i}\right)-v\left(G_{i}\right)\right)\right)\right]
\end{align*}
$$

By the inductive assumption, this quantity is no more than 1 , so the inductive argument goes through. Using this bound on the expectation, the given upper bound or the original probability of interest follows.

## B Proof of Lemma 2

Lemma 2. If $f_{z}$ is Bayes-optimal and makes infinitely many predictions all of which are almost surely eventually revealed, then for any $f_{j}$, with probability 1 , if $y_{i}^{z}:=$ $f_{z}\left(o_{\prec i}\right)$ and $y_{i}^{j}:=f_{j}\left(o_{\prec i}\right)$ are both defined on the same $t$ infinitely often, and if $\left\|y_{i}^{z}-y_{i}^{j}\right\| \geq \delta$ infinitely often for some $\delta>0$,

$$
\begin{equation*}
\lim _{n \rightarrow \infty} \operatorname{maxscore}{ }_{n}(j)=\infty \tag{13}
\end{equation*}
$$

Proof. Let $1 / m<\delta$. It suffices to show that with probability 1 ,

$$
\begin{equation*}
\lim _{n \rightarrow \infty} \operatorname{relscore}_{n}(j, z, m)=\infty \tag{20}
\end{equation*}
$$

Write $t_{n}$ for the number of times that $\operatorname{testseq}_{n}(j, z, m)$ outputs, and note that $t_{n} \rightarrow \infty$ as $n \rightarrow \infty$ because $f_{j}$ and $f_{z}$ disagree by more than $\delta$ infinitely often. We will show that relscore $\operatorname{sen}_{n}(j, z, m)$ is bounded below by a bound proportional to $t_{n}$, which means that relscore ${ }_{n}(j, z, m)$ must diverge to infinity.

Let $s=$ testseq ${ }_{\infty}(j, z, m)$. Define $G_{1} H_{1} G_{2} H_{2} \ldots, r\left(H_{i}\right)$, and $v\left(G_{i}\right)$ as in the proof of Lemma 1. Recall that $r\left(H_{i}\right)-v\left(G_{i}\right)$ is an upper bound for $\mathcal{L}\left(x_{i}, y_{i}^{z}\right)-$ $\mathcal{L}\left(x_{i}, y_{i}^{j}\right)$, which means that $v\left(G_{i}\right)-r\left(H_{i}\right)$ is a lower bound for $\mathcal{L}\left(x_{i}, y_{i}^{j}\right)-\mathcal{L}\left(x_{i}, y_{i}^{z}\right)$. Therefore, it suffices to show that, for some $\alpha>0$,

$$
\begin{equation*}
\lim _{N \rightarrow \infty} \mathbb{P}\left(\forall n>N: \sum_{i=1}^{t_{n}}\left(v\left(G_{i}\right)-r\left(H_{i}\right)-\frac{\rho \varepsilon}{2 m^{2}}\right) \geq \alpha t_{n}\right)=1 \tag{21}
\end{equation*}
$$

Observe that $v\left(G_{i}\right) \geq \rho / 2 m^{2}$ for all $i$, so the positive $v\left(G_{i}\right)$ terms going against $f_{j}$ more than compensate for the negative $\rho \varepsilon / 2 m^{2}$ terms going in its favor. Because $\varepsilon<1$, only a $\frac{1+\varepsilon}{2}$ portion of each $v\left(G_{i}\right)$ is needed to cancel out the $\rho \varepsilon / 2 m^{2}$ terms,

$$
\begin{align*}
& \mathbb{P}\left(\sum _ { i = 1 } ^ { t _ { n } } \left(v\left(G_{i}\right)-\right.\right.\left.\left.r\left(H_{i}\right)-\frac{\rho \varepsilon}{2 m^{2}}\right) \geq \alpha t_{n}\right) \\
& \geq \mathbb{P}\left(\sum_{i=1}^{t_{n}}\left(\frac{1-\varepsilon}{2} v\left(G_{i}\right)-r\left(H_{i}\right)\right) \geq t_{n}\left(\alpha+\frac{\rho(\varepsilon-1)}{4 m^{2}}\right)\right) \tag{22}
\end{align*}
$$

Now we apply Lemma 3. $\mathbb{E}\left[r\left(H_{k}\right) \mid G_{k}\right]$ is still 0 . With $a=\frac{\kappa \sqrt{2}}{\sqrt{\rho}} \cdot \sqrt{\frac{2}{1-\varepsilon}}$,

$$
\begin{equation*}
\left|r\left(H_{k}\right)\right| \leq a \sqrt{\frac{1-\varepsilon}{2} v\left(G_{k}\right)} \tag{23}
\end{equation*}
$$

Therefore, by Lemma 3 we have that

$$
\begin{equation*}
\mathbb{P}\left(\sum_{i=1}^{t_{n}}\left(r\left(H_{i}\right)-\frac{1-\varepsilon}{2} v\left(G_{i}\right)\right) \geq M\right) \leq \exp \left(-\frac{\rho(1-\varepsilon) M}{2 \kappa^{2}}\right) \tag{24}
\end{equation*}
$$

Choose $\alpha=\rho(1-\varepsilon) / 8 m^{2}$ and set $M=-t\left(\alpha+\frac{\rho(\varepsilon-1)}{4 m^{2}}\right)=t \frac{\rho(1-\varepsilon)}{8 m^{2}}$ to get:

$$
\begin{equation*}
\mathbb{P}\left(\sum_{i=1}^{t_{n}}\left(\frac{1-\varepsilon}{2} v\left(G_{i}\right)-r\left(H_{i}\right)\right) \leq t \frac{\rho(\varepsilon-1)}{8 m^{2}}\right) \leq \exp \left(-\frac{t \rho^{2}(1-\varepsilon)^{2}}{16 m^{2} \kappa^{2}}\right) \tag{25}
\end{equation*}
$$

We write $c=\rho^{2}(1-\varepsilon)^{2} / 16 m^{2} \kappa^{2}$ for conciseness. Observe that

$$
\begin{align*}
\mathbb{P}\left(\exists n \geq N: \sum_{i=1}^{t_{n}}\left(v\left(G_{i}\right)-r\left(H_{i}\right)-\frac{\rho \varepsilon}{2 m^{2}}\right)\right. & \left.\leq \alpha t_{n}\right) \\
& \leq \sum_{t=t_{N}}^{\infty} \exp (-t c)=\frac{\exp \left(-t_{N} c\right)}{1-\exp (-c)} \tag{26}
\end{align*}
$$

If $|s|=\infty$ then the right-hand side almost surely goes to zero as $n \rightarrow \infty$, in which case, with probability 1 , there exists an $N$ such that

$$
\begin{equation*}
\forall n>N: \sum_{i=1}^{t_{n}}\left(v\left(G_{i}\right)-r\left(H_{i}\right)-\frac{\rho \varepsilon}{2 m^{2}}\right) \geq \alpha t_{n} \tag{27}
\end{equation*}
$$

Thus if $f_{z}$ and $f_{j}$ disagree by more than $\delta$ infinitely often, then with probability 1 , eventually relscore ${ }_{n}(j, z, m)$ grows proportionally to $t_{n}$. Therefore, with probability 1 ,

$$
\begin{equation*}
\lim _{n \rightarrow \infty} \operatorname{relscore}(j, z, m)=\infty \tag{28}
\end{equation*}
$$

so maxscore ${ }_{n}(j)$ almost surely diverges to $\infty$ as $n \rightarrow \infty$.

## C Proof of Theorem 2

Let $f_{z}$ be a Bayes-optimal predictor and assume $\mathcal{F}$ is finite. Assume we have an increasing function $h$ such that for some $m$ and every $f_{j}$, for all times $t$, there exists a $t<t^{\prime}<h_{j}^{m}(t)$ such that $y_{t^{\prime}}^{z}:=f_{z}\left(o_{\prec t^{\prime}}\right)$ and $y_{t^{\prime}}^{j}:=f_{j}\left(o_{\prec t^{\prime}}\right)$ are both defined and $\left\|y_{t^{\prime}}^{z}-y_{t^{\prime}}^{j}\right\|>1 / m$. Assume we have an increasing function $g$ such that $o_{\prec g(t)}(t)$ is always defined. o denotes function composition; i.e., $(h \circ g)^{n}(1)$ denotes $h(g(\ldots h(g(1))))$ with $n$ calls to $h$ and $g$.

Theorem 2. Given $h, g$, a Bayes-optimal $f_{z}$, and a probability $p$, there is an $N \propto$ $(h \circ g)^{\log p}(1)$ such that, with probability at least $1-p$, for all $n \geq N$,

$$
\begin{equation*}
\operatorname{EvOp}\left(o_{\prec n}\right)=f_{z}\left(o_{\prec n}\right) \tag{15}
\end{equation*}
$$

Proof. Observe that testseq ${ }_{n}(j, z, m)$ outputs at least $t$ terms for some $t$ such that $(h \circ g)^{t}(1) \leq n$. In the proof of Lemma 1 , we prove that the probability that $\operatorname{maxscore}_{n}(\mathrm{z}) \geq \lambda$ for any $n$ is at most

$$
\begin{equation*}
\frac{\exp (-b(\lambda+2-z))}{(1-\exp (-b \rho \varepsilon / 2))(1-\exp (-b))^{2}} \tag{29}
\end{equation*}
$$

In the proof of Lemma 2, we prove that the probability that

$$
\begin{equation*}
\operatorname{maxscore}_{n}(j) \leq \alpha t-m-z+j \tag{30}
\end{equation*}
$$

for any $n$ such that testseq ${ }_{n}(j, z, m)$ outputs at least $t$ terms is at most

$$
\begin{equation*}
\frac{\exp (-t c)}{1-\exp (-c)} \tag{31}
\end{equation*}
$$

Combining these, we get that for any $T$, if we let $t$ be the maximal $t$ such that $(h \circ g)^{t}(1) \leq T$, then for $\lambda=\alpha t-m-z+|\mathcal{F}|$, with probability at least

$$
\begin{equation*}
1-\left(\frac{\exp (-b(\lambda+2-z))}{(1-\exp (-b \rho \varepsilon / 2))(1-\exp (-b))^{2}}+|\mathcal{F}| \frac{\exp (-t c)}{1-\exp (-c)}\right) \tag{32}
\end{equation*}
$$

$\operatorname{EvOp}\left(o_{\prec n}\right)=f_{z}\left(o_{\prec n}\right)$ for all times after $T$. This also gives us a weak bound on total loss: Because $\mathcal{L}$ is both Lipschitz and strongly convex, it is bounded. Let $L$ be the bound. Then with probability as per equation (32), the total loss never goes above $L T$.

Reversing this process, we also get that for any $p$, if we let $t$ be such that

$$
\begin{equation*}
\left(\frac{\exp (-b(\alpha t-m-z+|\mathcal{F}|+2-z))}{(1-\exp (-b \rho \varepsilon / 2))(1-\exp (-b))^{2}}+|\mathcal{F}| \frac{\exp (-c t)}{1-\exp (-c)}\right)<p \tag{33}
\end{equation*}
$$

then with probability at least $1-p$, for all $n \geq(h \circ g)^{t}(1), \operatorname{EvOp}\left(o_{\prec n}\right)=f_{z}\left(o_{\prec n}\right)$.

## Acknowledgements

Thanks to Jessica Taylor for the proof of Lemma 3, and to Benya Fallenstein for helpful discussions.

This research was supported as part of the Future of Life Institute (futureoflife.org) FLI-RFP-AI1 program, grant \#2015-144576.

## References

[1] Miroslav Dudik et al. "Efficient Optimal Learning for Contextual Bandits". In: 27th Annual Conference on Uncertainty in Artificial Intelligence (UAI-11). Corvallis, Oregon: AUAI Press, 2011, pp. 169-178.

[2] Pooria Joulani, András György, and Csaba Szepesvári. "Online Learning Under Delayed Feedback". In: 30th International Conference on Machine Learning. Ed. by Sanjoy Dasgupta and David McAllester. Vol. 28. JMLR Workshop and Conference Proceedings. 2013, pp. 1453-1461.

[3] Rodney G. Downey and Denis R. Hirschfeldt. Algorithmic Randomness and Complexity. Theory and Applications of Computability. New York, NY: Springer, 2010.

[4] Nick Littlestone and Manfred K. Warmuth. "The Weighted Majority Algorithm". In: Information and computation 108.2 (1994), pp. 212-261.

[5] Volodimir G. Vovk. "Aggregating Strategies". In: 3rd Annual Workshop on Computational Learning Theory (COLT90). Ed. by Mark Fulk and John Case. Morgan Kaufmann, 1990, pp. 371-383.

[6] Nicolò Cesa-Bianchi, David P. Helmbold, and Sandra Panizza. "On Bayes Methods for On-Line Boolean Prediction". In: Algorithmica 22 (1998), pp. 112-137.

[7] David Haussler, Jyrki Kivinen, and Manfred K. Warmuth. "Tight Worst-Case Loss Bounds for Predicting with Expert Advice". In: Computational Learning Theory: Second European Conference (EuroCOLT '95). Ed. by Paul Vitányi. Springer, 1995, pp. 69-83.

[8] Alexander Rakhlin and Karthik Sridharan. "Online Learning with Predictable Sequences". In: 26th Conference on Learning Theory (COLT 2013). Ed. by Shai ShalevShwartz and Ingo Steinwart. Vol. 30. JMLR Workshop and Conference Proceedings. 2012, pp. 1-27.

[9] Eyal Gofer et al. "Regret minimization for branching experts". In: 26th Conference on Learning Theory (COLT 2013). Ed. by Shai Shalev-Shwartz and Ingo Steinwart. Vol. 30. JMLR Workshop and Conference Proceedings. 2013, pp. 618-638.

[10] Antonio Piccolboni and Christian Schindelhauer. "Discrete Prediction Games with Arbitrary Feedback and Loss". In: Computational Learning Theory: 14th Annual Conference on Computational Learning Theory (COLT 2001), and 5th European Conference on Computational Learning Theory (EuroCOLT 2001). Vol. 2111. Lecture Notes in Computer Science. Springer Berlin Heidelberg, 2001, pp. 208-223.

[11] Marcelo J. Weinberger and Erik Ordentlich. "On Delayed Prediction of Individual Sequences". In: Information Theory, IEEE Transactions on 48.7 (2002). Ed. by Fabio Cozman and Avi Pfeffer, pp. 1959-1976.

[12] Peter Auer, Nicolò Cesa-Bianchi, and Paul Fischer. "Finite-Time Analysis of the Multiarmed Bandit Problem". In: Machine Learning 47.2-3 (2002), pp. 235-256.

[13] Gergely Neu et al. "Online Markov Decision Processes Under Bandit Feedback". In: Advances in Neural Information Processing Systems 23 (NIPS 2010). Curran Associates, Inc., 2010, pp. 1804-1812.

[14] Jon Christian Mesterharm. "Online Learning with Delayed Label Feedback". In: Algorithmic Learning Theory: 16th International Conference (ALT 2005). Ed. by Sanjay Jain, Hans Ulrich Simon, and Etsuji Tomita. Vol. 3734. Lecture Notes in Computer Science. Springer Berlin Heidelberg, 2005, pp. 399-413.

[15] Jon Christian Mesterharm. "Improving Online Learning". PhD thesis. Rutgers, The State University of New Jersey, 2007.

[16] Thomas Desautels, Andreas Krause, and Joel W. Burdick. "Parallelizing ExplorationExploitation Tradeoffs in Gaussian Process Bandit Optimization". In: Journal of Machine Learning Research 15.1 (2014), pp. 3873-3923.

[17] Kent Quanrud and Daniel Khashabi. "Online Learning with Adversarial Delays". In: Advances in Neural Information Processing Systems 28 (NIPS 2015). Ed. by C. Cortes et al. Curran Associates, Inc., 2015, pp. 1270-1278.

[18] Venkata N. Padmanabhan and Jeffrey C. Mogul. "Using Predictive Prefetching to Improve World Wide Web Latency". In: ACM SIGCOMM Computer Communication Review 26.3 (1996), pp. 22-36.

[19] Martin Zinkevich, John Langford, and Alex J. Smola. "Slow Learners are Fast". In: Advances in Neural Information Processing Systems 22 (NIPS 2009). Curran Associates, Inc., 2009, pp. 2331-2339.

[20] Alekh Agarwal and John C. Duchi. "Distributed Delayed Stochastic Optimization". In: Advances in Neural Information Processing Systems 24 (NIPS 2011). Curran Associates, Inc., 2011, pp. 873-881.

[21] Marcus Hutter et al. "Probabilities on Sentences in an Expressive Logic". In: Journal of Applied Logic 11.4 (2013), pp. 386-420.

[22] Abram Demski. "Logical Prior Probability". In: Artificial General Intelligence. 5th International Conference, AGI 20127716 (2012). Ed. by Joscha Bach, Ben Goertzel, and Matthew Iklé, pp. 50-59.

[23] Haim Gaifman. "Concerning Measures in First Order Calculi". In: Israel Journal of Mathematics 2.1 (1964), pp. 1-18.

[24] Per Martin-Löf. "The Definition of Random Sequences". In: Information and Control 9.6 (1966), pp. 602-619.

[25] Anirban DasGupta. "Probability for Statistics and Machine Learning: Fundamentals and Advanced Topics". In: Springer Texts in Statistics. New York, NY: SpringerVerlag New York, 2011. Chap. Discrete Time Martingales and Concentration Inequalities, pp. 463-504.


[^0]:    ${ }^{1}$ This is somewhat ill-defined, since $s_{i}$ is itself a random variable. We can make this more precise by defining $G_{i}=\left(s_{i}, o_{\prec s_{i}}\right)$ and noting that $s_{i}$ can be determined from knowing only $o_{\prec s_{i}}$

