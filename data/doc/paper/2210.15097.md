# Contrastive Decoding: Open-ended Text Generation as Optimization 

Xiang Lisa Li ${ }^{1}$, Ari Holtzman ${ }^{2}$, Daniel Fried ${ }^{3}$, Percy Liang ${ }^{1}$, Jason Eisner ${ }^{4}$,<br>Tatsunori Hashimoto ${ }^{1}$, Luke Zettlemoyer ${ }^{2,5}$, Mike Lewis ${ }^{5}$<br>Stanford University ${ }^{1}$, University of Washington ${ }^{2}$, Carnegie Mellon University ${ }^{3}$,<br>Johns Hopkins University ${ }^{4}$, FAIR $^{5}$<br>xlisali@stanford.edu, ahai@cs.washington.edu, dfried@cs.cmu.edu,<br>pliang@stanford.edu, jason@cs. jhu.edu, thashim@stanford.edu,<br>lsz@cs.washington.edu, mikelewis@meta.com


#### Abstract

Given a language model (LM), maximum probability is a poor decoding objective for open-ended generation, because it produces short and repetitive text. On the other hand, sampling can often produce incoherent text that drifts from the original topics. We propose contrastive decoding (CD), a reliable decoding approach that optimizes a contrastive objective subject to a plausibility constraint. The contrastive objective returns the difference between the likelihood under a large LM (called the expert, e.g. OPT-13B) and a small LM (called the amateur, e.g. OPT-125M), and the constraint ensures that the outputs are plausible. CD is inspired by the fact that the failures of larger LMs (e.g., repetition, incoherence) are even more prevalent in smaller LMs, and that this difference signals which texts should be preferred. CD requires zero additional training, and produces higher quality text than decoding from the larger LM alone. It also works across model scales (OPT-13B and GPT2-1.5B) and significantly outperforms four strong decoding algorithms (e.g., nucleus, top-k) in automatic and human evaluations across wikipedia, news and story domains. ${ }^{1}$


## 1 Introduction

Open-ended text generation aims to craft fluent and coherent textual continuations of given prompts, laying foundations for various downstream applications such as writing assistance and story generation (Brown et al., 2020). The canonical approaches often sample from large pre-trained language models (Holtzman et al., 2020; Fan et al., 2018; Radford et al., 2019), but the generated text is prone to incoherence and topic drift as unlucky sampling choices compound over long sequences (Eikema and Aziz, 2020; Maynez et al., 2020). On the other hand, searching for the most likely se-[^0]

![](https://cdn.mathpix.com/cropped/2024_06_04_1428cbe356819d533a4fg-01.jpg?height=640&width=766&top_left_y=725&top_left_x=1062)

Figure 1: Contrastive decoding exploits the contrasts between expert and amateur LM of different sizes by choosing tokens that maximize their log-likelihood difference. CD produces high-quality text that amplifies the good expert behavior and diminishes the undesired amateur behavior.

quences often results in short, repetitive and tedious text (Holtzman et al., 2020), indicating that maximizing probability is a wrong decoding objective.

We propose a new search-based approach, contrastive decoding (CD), that can generate fluent and lexically diverse text without compromising coherence. As shown in Figure 1, contrastive decoding takes an off-the-shelf large language model such as OPT-13B (that we call the expert) and an off-the-shelf smaller language model such as OPT-125M (that we call the amateur). CD searches for text that maximizes the difference between expert log-probabilities and amateur log-probabilities, subject to plausibility constraints which restrict the search space to tokens with sufficiently high probability under the expert LM.

Contrastive Decoding works because many failure modes of language models (short, repetitive, irrelevant or uninteresting strings) are more common
under smaller LMs than under larger LMs. Such outputs are further deemphasized by taking the difference between model log-probabilities. Conversely, stronger models tend to put more probability mass on desirable outputs, such as those with factual knowledge that has not been learnt by the weaker model, and these strings are emphasized by contrastive decoding.

Taking Figure 1 as an example, the expert model places significant probability mass on previous tokens such as "Hawaii" and "Honolulu", leading to a highly repetitive continuation from greedy search; and nonsensical tokens such as "Washington" may be sampled, leading to an incoherent continuation. A correct continuation "1961" is strongly preferred by contrastive decoding, despite only having a probability of 0.1 , and the continuation includes more correct facts. This example suggests that contrastive decoding generates outputs that emphasize the best of the expert LM and remove its amateur tendencies. Moreover, we provide a pragmatic interpretation of contrastive decoding in §4.

Compared to recent training-based methods that improve generation quality such as unlikelihood training (Welleck et al., 2020) and contrastive learning (Su et al., 2022; An et al., 2022), contrastive decoding requires zero additional training. We find that by simply contrasting two frozen language models of different sizes, we are able to decode higher quality text than from the larger LM alone. Furthermore, we find that better performance is achieved when the scale difference between expert and amateur is larger (§7.1). As a result, the optimal amateur model is also cheap to run and incurs very little inference time overhead.

We evaluate our contrastive decoding approach for open-ended text generation in three domains: Wikipedia, stories, and news, and we evaluate using different teacher-student combinations, including (GPT2-XL v.s. GPT2-small, OPT-13B v.s. OPT-125M). Compared to four decoding baselines (nucleus sampling, top-k, typical decoding and SimCTG) our contrastive decoding method significantly improves the coherence of generated text, and improves or maintains the same fluency levels, according to both human evaluation and automatic metrics.

## 2 Problem Statement

We consider decoding approaches for open-ended language generation, where the language models receive an input prompt and aim to generate a fluent and coherent continuation. Specifically, we consider a relatively short prompt of length $n$, denoted as $\mathrm{x}_{\text {pre }}=x_{1} \cdots x_{n}$, where $x_{i}$ is a token in the vocabulary $\mathcal{V}$. The decoder must generate continuations of length $m$, denoted as $\mathrm{x}_{\text {cont }}=x_{n+1}, \cdots, x_{n+m}$.

We generate text from a pre-trained autoregressive language model $p_{\mathrm{LM}}$. At decoding time, we iteratively decode one token at a time by conditioning on the preceding context:

$$
p_{\mathrm{LM}}\left(\mathrm{x}_{\text {cont }} \mid \mathrm{x}_{\text {pre }}\right)=\prod_{i=n+1}^{n+m} p_{\mathrm{LM}}\left(x_{i} \mid x_{<i}\right)
$$

where $p_{\mathrm{LM}}\left(x_{i} \mid x_{<i}\right)$ is the next token distribution. We use different subscripts to denote different LMs: $p_{\text {AMA }}$ is the amateur LM (e.g., GPT-2 small), and $p_{\text {EXP }}$ is the expert LM (e.g., GPT-2 XL).

One canonical decoding approach is to sample from a truncated next token distribution at each time step. For example, nucleus sampling (Holtzman et al., 2020) draws from the top $p$ percentile of the next token distribution; top-k sampling (Fan et al., 2018) draws from the top $k$ candidates in the next token distribution. Another common approach is to search for the most likely text sequence via greedy decoding or beam search (Wu et al., 2016); but this leads to repetition and tedious outputs.

## 3 Contrastive Decoding

We propose contrastive decoding as a search-based decoding method that optimizes a novel contrastive objective subject to our plausibility constraint. We first provide intuition and define the constrastive objective (§3.1). Second, we discuss the potential weakness of this objective alone, and introduce the plausibility constraint to correct for the weakness (§3.2). Then we define the full contrastive decoding method as our contrastive objective subject to the plausibility constraint (\$3.3). Finally, we elaborate on the design spaces by discussing the choices of amateurs (\$3.4).

### 3.1 Contrastive Objective

Smaller LMs demonstrate stronger tendencies to produce undesirable patterns (e.g., repetition, topic drift, and self contradiction) than larger LMs. For
example, when both expert (larger LM) and amateur (smaller LM) assign highest probability to a repetitive token, the expert LM is often less confident about this decision and assigns non-trivial probability mass to other good, non-repetitive continuations. Contrastive decoding is inspired by these observations. The goal is to factor out undesired behaviors highlighted by the smaller amateur LMs, and generate text from the remaining good behaviors of larger expert LMs.

To operationalize this intuition, we propose the contrastive objective $\mathcal{L}_{\mathrm{CD}}\left(\mathrm{x}_{\text {cont }}, \mathrm{x}_{\text {pre }}\right)$ :

$$
\log p_{\text {EXP }}\left(\mathrm{x}_{\text {cont }} \mid \mathrm{X}_{\text {pre }}\right)-\log p_{\text {AMA }}\left(\mathbf{x}_{\text {cont }} \mid \mathrm{x}_{\text {pre }}\right)
$$

The CD objective rewards text patterns favored by the large expert LMs and penalizes patterns favored by the small amateur LMs. However, amateur LMs are not always mistaken: small language models still capture many simple aspects of English grammar and common sense (e.g., subject verb agreement). Thus, penalizing all behaviors from amateur LMs indiscriminately would penalize these simple aspects that are correct (False negative), and conversely reward implausible tokens (False positive). To tackle this issue, we introduce the plausibility constraint, which complements our CD objective and avoids these failure modes.

## $3.2 \mathcal{V}_{\text {head }}$ : Adaptive Plausibility Constraint

To tackle the aforementioned issue, we propose an adaptive plausibility constraint $\left(\mathcal{V}_{\text {head }}\right)$ that exploits the confidence level of the expert $\mathrm{LM}$ to restrict the effect of the contrastive objective when the expert LM is highly confident:

$$
\begin{aligned}
& \mathcal{V}_{\text {head }}\left(x_{<i}\right)= \\
& \left\{x_{i} \in \mathcal{V}: p_{\mathrm{EXP}}\left(x_{i} \mid x_{<i}\right) \geq \alpha \max _{w} p_{\mathrm{EXP}}\left(w \mid x_{<i}\right)\right\}
\end{aligned}
$$

Here, $\alpha$ is a hyperparameter in $[0,1]$ that truncates the next token distribution of $p_{\text {EXP }}$. Larger $\alpha$ entails more aggressive truncation, keeping only high probability tokens, whereas smaller $\alpha$ allows tokens of lower probabilities to be generated. We set $\alpha=0.1$ throughout the paper.

This adaptive plausibility constraint corrects for both false positive and false negative failures of the contrastive objective:

False positives. An implausible token may be rewarded with a high score under our unconstrained contrastive objective. For example, the token "NetMessage" is highly implausible under the context of Figure 1, with $3 \times 10^{-9}$ of $p_{\text {EXP }}$ and $8 \times 10^{-14}$ of $p_{\text {AMA }}$; however, it attains the highest contrast of $\log p_{\text {EXP }}-\log p_{\text {AMA }}=10.6$, which is much higher than plausible tokens "1961" and "Hawaii". To handle the false positive problem, $\mathcal{V}_{\text {head }}$ filters out low probability tokens and only keeps high probability tokens in the candidate pool.

False negatives. When confronting an easy decision, the correct token that achieves high probability under both amateur LM and expert LM may receive a low score under the contrastive objective. For example, due to tokenization, the word "unicorn" consists of two subwords: "unic" and "\#orn", and the probability of "\#orn" given the prefix "unic" is close to 0.99 under both LMs, but the contrast $\log p_{\mathrm{EXP}}-\log p_{\mathrm{AMA}}$ is only $6 \times 10^{-4}$, which is much lower than bad continuations.

Here, $\mathcal{V}_{\text {head }}$ uses the expert LM's confidence (as defined by the $\alpha$ ratio with the max probability token in the given timestep) to avoid these false negative cases. The expert LM assigns high confidence to easy decisions, but not to tokens that reflect the undesired behaviors of the amateur, since probability mass is taken up by other candidate tokens the expert is able to consider. Our constraint keeps as few as one token in the candidate pool when the expert is highly confident about this token, which removes the impact of the contrastive objective, because the single token would always be highest ranked regardless of the $\mathrm{CD}$ objective.

### 3.3 Full Method

Combining the contrastive objective and the adaptive plausibility constraint, we obtain the full contrastive decoding formulation:

$$
\begin{align*}
& \max _{\mathrm{x}_{\text {cont }}} \mathcal{L}_{\mathrm{CD}}\left(\mathrm{x}_{\text {cont }}, \mathrm{X}_{\text {pre }}\right)  \tag{2}\\
& \text { subject to } \quad x_{i} \in \mathcal{V}_{\text {head }}\left(x_{<i}\right), \forall x_{i} \in \mathrm{x}_{\text {cont }}
\end{align*}
$$

The above objective is defined at the sequence level, which is intractable to optimize. Thus, we factor the objective to token level scores:

$$
\begin{align*}
& \operatorname{CD}-\operatorname{score}\left(x_{i} ; x_{<i}\right)  \tag{3}\\
& = \begin{cases}\log \frac{p_{\mathrm{EXP}}\left(x_{i} \mid x_{<i}\right)}{p_{\mathrm{AMA}}\left(x_{i} \mid x_{<i}\right)}, & \text { if } x_{i} \in \mathcal{V}_{\text {head }}\left(x_{<i}\right) \\
-\inf , & \text { otherwise }\end{cases}
\end{align*}
$$

We apply beam search to optimize CD-score, by first filtering tokens based on plausibility constraints $\mathcal{V}_{\text {head }}\left(x_{<i}\right)$, eliminating tokens that fail to
achieve sufficiently high probabilities under the expert LM. Then we score the remaining tokens based on the amount of contrast they demonstrate, according to $\log p_{\text {EXP }}\left(x_{i} \mid x_{<i}\right)-\log p_{\text {AMA }}\left(x_{i} \mid x_{<i}\right)$. As a result, we end up selecting plausible tokens under the expert LM that least resemble the amateur LM.

### 3.4 Choice of Amateur

The choice of amateur LM is an important decision for contrastive decoding. As discussed in §3.1, we should choose amateur LMs that exhibit the behaviors we would like to downweight from the expert LM. Here, we consider three aspects:

Scale. Smaller LMs have lower modeling capacity and are more prone to errors. Therefore, we choose the amateur LM to be the smallest model in the same family of the expert LM. For example, for OPT-13B expert, we choose OPT-125M as the amateur; for GPT-2 XL expert, we choose GPT-2 small as the amateur. We verify this design choice in $\S 7.1$. On the extreme end, employing n-gram models yields an amateur LM of extremely low capacity. But this choice hurts generation quality, because n-gram LMs incur too many errors to identify similar failure modes of the expert LM.

Temperature. We can manipulate the amateur LM behavior by tuning its temperature $\tau$. For example, applying a high temperature $(\tau>1)$ to the amateur LM results in flatter distributions; applying a low temperature ( $\tau$ close to 0 ) highlights the mode of the amateur distribution, which is more prone to errors (e.g. repetition). Therefore, we manipulate the temperature of the amateur LM to adjust the amateur behavior that will be penalized in contrastive decoding. In $\S 7.2$, we study the impact of $\tau$ to generation quality and set $\tau$ to 0.5 or 1.0 for our main experiments.

Context window. We can also weaken capacity by restricting the context window of the amateur LM (Li et al., 2016). For instance, we can only allow the amateur $\mathrm{LM}$ to condition on the last token of $x_{\text {pre }}$, but we allow the expert $\mathrm{LM}$ to condition on the entire $x_{\text {pre }}$. In other words, we decode from $\log \frac{p_{\mathrm{ExP}}\left(\mathrm{x}_{\text {cont }} \mid x_{1: n}\right)}{p_{\mathrm{AMA}}\left(\mathrm{x}_{\text {cont }} \mid x_{n}\right)}$. By conditioning the amateur LM only on partial prompts, the coherence of the amateur LM is weakened, and contrastive decoding produces more coherent text by highlighting the coherence nature of the expert LM. In $\S 7.5$, we study the impact of this design choice.

## 4 CD as Pragmatic Communication

Having formally described contrastive decoding, we now provide a pragmatic interpretation, justifying its validity through pragmatic communication goals .

A line of work in pragmatics (Grice, 1975) characterizes communication as a cooperative process between speakers and listeners. Several of these formalisms (Horn, 1984; Levinson, 2000) describe a tradeoff between speakers and listeners, where a speaker should generally produce language that is high quality (e.g. truthful, fluent, and relevant) while also being informative to a listener.

Our contrastive objective can be motivated by this tradeoff, with our expert and amateur LMs modeling a knowledgable speaker and a lessinformed listener: (1) Upweighting tokens by $p_{\mathrm{EXP}}$ and using our expert-based plausibility constraints generates tokens that have high probability under the expert LM, encouraging generated text to be fluent and relevant (e.g. upweighting '1961' in Figure 1). (2) Downweighting tokens by $p_{\mathrm{AMA}}$ suppresses language that is predictable by (i.e. less informative to) the amateur LM (e.g. downweighting 'Honolulu' and 'Washington'), and by proxy encourages the language to be informative to a listener in context. By combining these two criteria, our contrastive decoding method produces high quality text that satisfies the communicative goal of transferring relevant but not predictable information.

### 4.1 Special Cases of Contrastive Decoding

Maximum probability. Setting the amateur LM to a uniform distribution reduces $\mathrm{CD}$ to maximize log-probabilities under the expert LM.

N-gram blocking. If we set the amateur LM as an n-gram model whose n-gram counts are updated to fit the generated prefix, this yields a decoding algorithm with soft n-gram blocking. If we also set the amateur temperature to be very small, then it approaches the canonical heuristic of forbidding repeated n-grams (Paulus et al., 2018).

Diverse decoding. If we use the same LM as both amateur and expert and restrict the context window of the amateur LM (§3.4), our method is equivalant to the MMI decoding objective ( $\mathrm{Li}$ et al., 2016) sometimes used in dialog systems, which explicitly maximizes the pointwise mutual information between the $\mathrm{x}_{\text {pre }}$ and $\mathrm{x}_{\text {cont }}$.

## 5 Experimental Setup

### 5.1 Datasets and Metrics

We evaluate on three domains for open-ended text generation: news, Wikipedia, and story domains. For the news domain, we use news articles from Wikinews; ${ }^{2}$ for the Wikipedia domain, we use the WikiText-103 dataset (Merity et al., 2017); and for story domains, we use the BookCorpus (Zhu et al., 2015) (Project Gutenberg split).

We use the first 32 words in the passage as the prompt, and decode for 256 tokens for the continuations. We evaluate generated text with both automatic and human evaluation.

Diversity. This metrics aggregate n-gram repetition rates: DIV $=\prod_{n=2}^{4} \frac{\mid \text { unique } n \text {-grams }\left(\mathrm{x}_{\text {cont }}\right) \mid}{\text { total n-grams }\left(\mathrm{x}_{\text {cont }}\right) \mid}$. A low diversity score suggests the model suffers from repetition, and a high diversity score means the model generated text is lexically diverse.

MAUVE. MAUVE (Pillutla et al., 2021) score (the higher the better) measures the distribution similarity between the set of generated text and the set of gold reference.

Coherence. We follow $\mathrm{Su}$ et al. (2022) and approximate coherence by cosine similarity between the sentence embeddings of prompt $\mathrm{x}_{\text {pre }}$ and generated continuation $\mathrm{x}_{\text {cont }}$ : $\operatorname{COH}\left(\mathrm{x}_{\text {cont }}, \mathrm{x}_{\text {pre }}\right)=\frac{\operatorname{Emb}\left(\mathrm{x}_{\text {pre }}\right) \cdot \operatorname{Emb}\left(\mathrm{x}_{\text {cont }}\right)}{\left\|\operatorname{Emb}\left(\mathrm{x}_{\text {pre }}\right)\right\| \cdot\left\|\operatorname{EmB}\left(\mathrm{x}_{\text {cont }}\right)\right\|}$, where $\operatorname{Emb}(x)$ is the pre-trained SimCSE sentence embedding (Gao et al., 2021).

Human Eval. In order to evaluate the quality of the generated text, we consider two critical aspects: fluency and coherence. A fluent piece of text is written in grammatical English and has a natural flow (e.g. excluding unnatural repetition or web formatting). A coherent piece of text should stay on topic with the prompt and avoid unnatural topic drift. We ask Amazon Mechanical Turkers to read two continuations (A and B) of the same prompt, and choose the more fluent/coherent continuation or decide they are similar.

### 5.2 Baselines

We compare contrastive decoding with three sampling methods, each with the recommended hyperparameters: nucleus sampling ( $p=0.95)$, top-k sampling $(k=50)$, typical decoding (Meister et al., 2022) $(\tau=0.95)$; and two search-based methods:[^1]

greedy (max prob) decoding that uses $\log p_{\text {EXP }}$ as the objective, and contrastive search (CS) (Su et al., 2022; Su and Collier, 2022). Among them, nucleus sampling is the standard approach for open-ended text generation whose performance has been verified in various domains (Holtzman et al., 2020; DeLucia et al., 2020), and typical decoding is a recently proposed approach that excels in lexical diversity (Meister et al., 2022). We therefore conduct human evaluation by comparing CD against these two methods.

### 5.3 Models and Hyperparameters

In order to demonstrate that our approach generalizes across various LM families and sizes, we consider GPT-2 XL (1.5B), OPT (6.7B) and OPT (13B) as expert LMs and employ the smallest LM in their respective family as the amateurs: GPT-2 small (100M) and OPT (125M).

Recall that contrastive decoding introduces two hyperparameters: $\alpha$ is the parameter to adjust the plausibility threshold, and $\tau$ is the temperature of the amateur LM. We always set $\alpha=0.1$ for the main results in the paper - we find that this setting is quite robust and generalizes across various domains. For OPT experiments, we set the amateur temperature to 1.0 and for GPT-2 experiments, we set the amateur temperature to 0.5 . We use a beam size of 5 . We also study the impact of these hyperparameters in the ablation study $\S 7.2$, and we find that our method is robust to various hyperparameter values.

## 6 Main Results

### 6.1 Automatic Evaluation

As shown in Table 1, contrastive decoding outperforms all other decoding baselines in MAUVE score and coherence score $(\mathrm{COH})$ across three different domains (news, Wikipedia, stories) and two model sizes (1.5B, 13B). Contrastive decoding achieves comparable or slightly worse diversity compared to nucleus and typical sampling, but it achieves substantially better diversity than other search based methods.

Typical decoding and nucleus sampling produce lexically diverse text by choosing low probability tokens, at the expense of topic drift. For instance, in the story domain we observe the largest diversity gap between contrastive decoding and nucleus sampling ( 0.83 v.s. 0.94 ) in the 1.5B model, but we find that the gap shrinks ( 0.89 v.s. 0.93 ) as
the model size increases to 13 billion, suggesting that our decoding method would continue to improve as expert models continue to scale.

CD outperforms all the baselines in coherence scores by a large margin, followed by greedy decoding. Greedy decoding achieves good coherence despite being highly repetitive, because always repeating the same sentence is a degenerate way to circumvent topic drift. We believe our gain in coherence comes from three aspects: (1) CD searches to optimize our objective, avoiding the topic drift that can happen by chance in sampling-based generation techniques. (2) Our contrastive objective implicitly rewards coherence, because large LMs are typically more coherent than smaller LMs. (3) Finally, we restrict the context length of the amateur $\mathrm{LM}$ (§3.4), further encouraging CD to reward text that is connected with the prompt (Li et al., 2016).

### 6.2 Human Evaluation

We conduct human evaluation to compare our contrastive decoding approach against nucleus sampling (the canonical method that scores high under MAUVE) and typical decoding (the winning method for diversity metrics). ${ }^{3}$

As shown in Table 2, contrastive decoding generates significantly more coherent text compared to nucleus and typical decoding across three domains and two models: on average across settings, evaluators preferred CD 2.6x more than nucleus sampling and $6.4 \mathrm{x}$ more than typical decoding when evaluating coherence. As for fluency, CD is preferred $1.4 \mathrm{x}$ more than nucleus sampling and $3.5 x$ more than typical decoding.

### 6.3 Qualitative Examples

We include a truncated qualitative example in Table 3. The nucleus sampling output shows a topic drift from a video game to music, and part of the generated text includes the format of an email; moreover, there is a style shift from third person narrative style to first person conversational style. These features match the noisy pre-training distribution of internet data, but are not desirable in the context of this prompt. Contrastive decoding output stays on topic with the prompt and elaborates on various aspects of the game, making it more coherent in both content and style. We include more qualitative examples in the appendix.[^2]![](https://cdn.mathpix.com/cropped/2024_06_04_1428cbe356819d533a4fg-06.jpg?height=378&width=782&top_left_y=250&top_left_x=1022)

Figure 2: Generation quality when applying contrastive decoding to expert and amateur LMs of different scales (\$7.1). We explore the expert-amateur combination within GPT-2 family (OPT family results in the appendix). We find the larger scale gap between the expert and the amateur LMs, the more text quality improves.

## 7 Ablation Studies

### 7.1 Size of Amateur and Expert LMs

Recall in $\S 3.4$, we provide intuition that choosing smaller LMs as the amateur should improve contrastive decoding results. We empirically verify this in Figure 2.

The diagonal entries use the same model as expert and amateur, yielding highly repetitive text (low diversity score), because we cannot exploit any contrast between two identical LMs. The upper triangular entries use an expert LM that is smaller than the amateur LM, and this counter-intuitive setup leads to inferior text quality. The lower triangular entries use an expert LM that is larger than the amateur $\mathrm{LM}$, resulting in higher quality text, as measured by both diversity and MAUVE. In particular, the optimal design is to select the largest LM as the expert and the smallest one as the amateur (lower left corner).

Does this trend generalize to extremely low capacity LMs like n-gram models? We find that employing a trigram LM as the amateur produces low quality text with a MAUVE score of only 0.73 . Our findings indicate that contrastive decoding benefits most with an amateur LM that can emphasize the failure modes of the expert $\mathrm{LM}$, and the mistakes of a low-capacity n-gram model do not highlight failure modes of an expert LM.

### 7.2 The Impact of Amateur Temperature

Recall in $\S 3.3$, we introduced the amateur LM temperature $\tau$ as a hyperparameter. We study how sensitive our method is to $\tau$ as shown in Figure 3.

Large $\tau$ brings the amateur distribution closer to the uniform distribution, which makes contrastive

![](https://cdn.mathpix.com/cropped/2024_06_04_1428cbe356819d533a4fg-07.jpg?height=536&width=1265&top_left_y=246&top_left_x=401)

Table 1: Automatic evaluation results for wikipedia, wikinews, story datasets. The best scores for each (model, domain) setting are boldfaced. Contrastive decoding outperforms all other decoding baselines in MAUVE score and coherence score $(\mathrm{COH})$ for different model scales (1.5B, 6.7B, 13B). CD achieves comparable or slightly worse diversity compared to nucleus and typical sampling.

|  |  |  |  | coher |  |  | fluen |  |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|  | CD | Baseline | CD is better | same | Baseline is better | CD is better | same | Baseline is better |
|  | CD (GPT-2 XL) | nucleus (GPT-2 XL) | $0.714^{*}$ | 0.083 | 0.202 | 0.548 | 0.083 | 0.369 |
| 犬्: | CD (GPT-2 XL) | typical (GPT-2 XL) | $0.887^{*}$ | 0.046 | 0.067 | $\mathbf{0 . 7 0 3}^{*}$ | 0.082 | 0.215 |
| $\frac{\frac{2}{3}}{3} \quad$ | CD (OPT-13B) | nucleus (OPT-13B) | 0.556 | 0.202 | 0.242 | 0.419 | 0.197 | 0.384 |
|  | CD (OPT-13B) | typical (OPT-13B) | $0.773^{*}$ | 0.106 | 0.121 | $0.687^{*}$ | 0.152 | 0.162 |
|  | CD (GPT-2 XL) | nucleus (GPT-2 XL) | $\mathbf{0 . 7 0 8}^{*}$ | 0.042 | 0.25 | $\mathbf{0 . 5 8 3}^{*}$ | 0.12 | 0.297 |
| ![](https://cdn.mathpix.com/cropped/2024_06_04_1428cbe356819d533a4fg-07.jpg?height=42&width=48&top_left_y=1289&top_left_x=255) | CD (GPT-2 XL) | typical (GPT-2 XL) | $0.771^{*}$ | 0.151 | 0.078 | $0.755^{*}$ | 0.151 | 0.094 |
| 글 | CD (OPT-13B) | nucleus (OPT-13B) | $0.585^{*}$ | 0.221 | 0.195 | 0.518 | 0.123 | 0.359 |
|  | CD (OPT-13B) | typical (OPT-13B) | $0.693^{*}$ | 0.099 | 0.208 | 0.49 | 0.297 | 0.214 |
|  | CD (GPT-2 XL) | nucleus (GPT-2 XL) | $0.636^{*}$ | 0.045 | 0.318 | 0.404 | 0.106 | 0.49 |
| $D$ | CD (GPT-2 XL) | typical (GPT-2 XL) | 0.506 | 0.256 | 0.238 | 0.387 | 0.363 | 0.25 |
| 导 | CD (OPT-13B) | nucleus (OPT-13B) | $0.616^{*}$ | 0.101 | 0.283 | 0.449 | 0.293 | 0.258 |
|  | CD (OPT-13B) | typical (OPT-13B) | $0.626^{*}$ | 0.202 | 0.172 | 0.52 | 0.212 | 0.268 |

Table 2: Human evaluation results for wikipedia, wikinews, story datasets. We boldfaced the max column and * the numbers that are significantly better than the two other columns combined. Contrastive decoding generates significantly more coherent text compared to nucleus and typical decoding across three domains and two models. CD also generates better or comparably fluent text compared to two baselines.

Prompt A version of Sonic the Hedgehog was developed by Ancient and released in 1991 for Sega's 8 - bit consoles, the Master System and Game

CD A version of Sonic the Hedgehog was developed by Ancient and released in 1991 for Sega's 8 - bit consoles, the (1.5B) Master System and Game Gear. It featured a new level editor called the Sonic Editor and was released as an expansion pack to Sonic CD in 1992, which was itself a port from the Genesis version. The editor allowed the creation and playtesting of custom levels for Sonic CD, and the expansion was also bundled with Sonic CD. It is also available for the PC as Sonic Editor. The game is considered a spiritual successor to the Genesis game Sonic 3 \& Knuckles and the Genesis port Sonic 3D Blast, as it features the same gameplay elements, including the Spin Dash, and also shares many levels and music with those games...

Nucleus A version of Sonic the Hedgehog was developed by Ancient and released in 1991 for Sega's 8 - bit consoles, the

(1.5B) Master System and Game Gear. It was set in the garden city of Sky Sanctuary and centered around Sonic's new helper, the pre-historic pillar-crusher-man Waddle Dee. Sonic the Hedgehog all the way was released for Game Gear in 1992. The author of the story speaks only for himself, but here it is.

TO: Sonic the Hedgehog

FROM: Anti-Socials

SUBJECT: Argyle DeBrosse

Contents show]

What's that? You want me to tell you what I did, huh? Well, some things never change.

Yeah. Basically, you. Now listen: I saw you on the NWA charts for ages. I heard about how great you were, and that you were a great singer. And then... later, after hearing it five times in a row, that's when I realized that I couldn't win this particular battle. You and your music have the edge...

Table 3: Qualitative example of contrastive decoding versus nucleus sampling. CD produces more coherent text both in content and style, whereas nucleus sampling produces text that suffers from topic and style drifts.

![](https://cdn.mathpix.com/cropped/2024_06_04_1428cbe356819d533a4fg-08.jpg?height=334&width=537&top_left_y=261&top_left_x=340)

Figure 3: Ablation studies for amateur temperature $\tau$ (§7.2). The figure shows how MAUVE and diversity score change as we vary the $\tau$ values, labeled next to each dot. We find that $\tau \in[0.5,1.0]$ robustly result in high generation quality. For main results we use $\tau=0.5$ for GPT-2 and $\tau=1.0$ for OPT.

|  | name | DIV | MAUVE | COH | PPL |
| :--- | :--- | :---: | :---: | :---: | :---: |
|  | CD (search) | $\mathbf{0 . 8 9}$ | $\mathbf{0 . 9 2}$ | $\mathbf{0 . 6 9}$ | $\mathbf{1 7 . 7 7}$ |
| $\stackrel{\sim}{\sim}$ | CD (sample) | 0.81 | 0.85 | 0.68 | 18.48 |
|  | CD (full) | 0.89 | $\mathbf{0 . 9 2}$ | $\mathbf{0 . 6 9}$ | $\mathbf{1 7 . 7 7}$ |
| $\stackrel{\sim}{\sim}$ | CD $\left(-\mathcal{V}_{\text {head }}\right)$ | $\mathbf{1 . 0}$ | 0.01 | 0.23 | $2 \mathrm{e} 5$ |

Table 4: Automatic evaluation for the ablation studies of search v.s. sampling the contrastive objective (\$7.3) and the importance of the plausibility constraint $\mathcal{V}_{\text {head }}$ (\$7.4).

decoding generate repetitive text, as repetition is no longer penalized. Small $\tau$ makes the amateur LM more spiky and emphasizes undesired amateur behaviors, leading to better outputs from contrastive decoding. As shown in Figure 3, we find that setting $\tau$ in $[0.5,1.5]$ attains good and robust performance in coherence and fluency.

### 7.3 Sampling v.s. Search

Recall that contrastive decoding is a search-based approach that maximizes the contrastive objective subject to plausibility constraints. We explore a sampling alternative based on the same objective. Specifically, we normalize the CD-score $\left(x_{i} ; x_{<i}\right)$ (defined in §3.3) via softmax into a probability distribution from which we sample the next token.

|  |  |  | coherence |  |  | fluency |  |  |  |
| :--- | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|  | A | B | A | same | B | A | same | B |  |
| 1.5b | CD (search) | CD (sample) | $\mathbf{0 . 5 3 5}$ | 0.04 | 0.424 | $\mathbf{0 . 4 3 4}$ | 0.333 | 0.232 |  |
| 13b | CD (search) | CD (sample) | $\mathbf{0 . 4 6 5}$ | 0.162 | 0.374 | $\mathbf{0 . 4 7 5}$ | 0.131 | 0.394 |  |
| 1.5b | CD (full) | CD (-context) | $\mathbf{0 . 4 2 4}$ | 0.172 | 0.404 | $\mathbf{0 . 3 6 4}$ | 0.283 | 0.354 |  |

Table 5: Human evaluation for the ablation studies of search v.s. sampling the contrastive objective (\$7.3) and ignoring prefix v.s. including prompt to the amateur $\mathrm{LM}$ (§7.5). CD (-context) denotes the ablation experiments where we condition on the entire context for both amatuer and expert, and $\mathrm{CD}$ (full) conditions the amateur only on the last context token.
As shown in Table 4 and Table 5, we find that sampling from this objective produces lower quality text than searching under the objective. According to automatic and human evaluations, CD (sample)'s fluency and coherence rating consistently falls behind $\mathrm{CD}$ (search), but sampling still yields reasonably good outputs.

### 7.4 Plausibility Constraints

In $\S 3.2$, we describe why including the feasibility constraints is critical. Here, we conduct an ablation study verifying this claim by removing the plausibility constraints $\mathcal{V}_{\text {head. }}$. We find that the generation outputs suffers from severe fluency issues, as easily shown by its MAUVE score of 0.01 in the $C D\left(-\mathcal{V}_{\text {head }}\right)$ row of Table 4.

### 7.5 Prompt Inclusion

We further experiment with ablating the prompt context on the amateur $\mathrm{LM}$ (§3.4), by letting the expert LM and amateur LM both condition on the entire $x_{\text {pre. }}$. Table 5 shows that the ablation slightly hurts coherence and fluency.

## 8 Related Work

Decoding Methods. Decoding algorithms can be broadly classified as either search or sampling algorithms. Current search methods (e.g. greedy and beam search) attain accurate generation in goaldriven tasks (e.g. summarization), but suffers from tedious and repetitive outputs in open-ended settings (e.g. story generation). Current sampling methods (e.g. nucleus (Holtzman et al., 2020), top$\mathrm{k}$ (Fan et al., 2018), and typical decoding (Meister et al., 2022)) produces more diverse and interesting text in open-ended settings, but suffers from unnatural topic drift. Contrastive decoding avoids topic drift by using search, and outperforms nucleus and top-k sampling in coherence while maintaining or improving fluency and lexical diversity.

Contrast in Text Generation. The idea of contrast for text generation has been explored in diverse settings (He et al., 2019; Li et al., 2016; Su et al., 2022). The closest work to ours is DExpert (Liu et al., 2021), which studies controllable text generation by contrasting an trained expert model (on non-toxic data) and a trained anti-expert model (on toxic data) to produce text that is non-toxic. In this work, we focus on open-ended text generation and show that it is possible to get domainand task-agnostic anti-experts simply by using a
smaller LM. Contrastive decoding contrasts offthe-shelf LMs of different scales to produce high quality text, without any training.

## 9 Conclusion and Future Work

We propose contrastive decoding, a search-based decoding approach that contrasts LMs of different scales. We evaluate our approach on open-ended text generation, and find that it improves over the prevalent methods like nucleus sampling in both fluency and coherence.

As future work, the idea of contrasting an expert (larger LM) and an amateur (smaller LM) can be expanded to myriad setups, for instance, contrasting an early checkpoint of an LM and a later checkpoint of the LM. We hope that this paper can encourage more exploration of how to use contrasting language models.

## Limitations

In this paper, we focus on open-ended text generation and demonstrate the effectiveness of contrastive decoding. We would like contrastive decoding to also work well for task-oriented generation settings such as summarization and machine translation. However, the idea of contrasting models across different scales (larger expert LM and smaller amateur $\mathrm{LM}$ ) is not directly applicable, because the modes of both amateur LM and expert LM are of high quality. Empirically, having a smaller summaization model (BART-small finetuned on summarization data) as the amateur LM yields lower ROUGE score than employing a uniform distribution as the amateur LM, which is equivalent to beam search based on log-probabilities. As future work, we aim to study the necessary properties of amateur LM to empower task-oriented generation (e.g. summarization, table-to-text).

## References

Chen An, Jiangtao Feng, Kai Lv, Lingpeng Kong, Xipeng Qiu, and Xuanjing Huang. 2022. Cont: Contrastive neural text generation. ArXiv, $\mathrm{abs} / 2205.14690$.

Tom Brown, Benjamin Mann, Nick Ryder, Melanie Subbiah, Jared D Kaplan, Prafulla Dhariwal, Arvind Neelakantan, Pranav Shyam, Girish Sastry, Amanda Askell, Sandhini Agarwal, Ariel Herbert-Voss, Gretchen Krueger, Tom Henighan, Rewon Child, Aditya Ramesh, Daniel Ziegler, Jeffrey Wu, Clemens Winter, Chris Hesse, Mark Chen, Eric Sigler,
Mateusz Litwin, Scott Gray, Benjamin Chess, Jack Clark, Christopher Berner, Sam McCandlish, Alec Radford, Ilya Sutskever, and Dario Amodei. 2020. Language models are few-shot learners. In Advances in Neural Information Processing Systems, volume 33, pages 1877-1901. Curran Associates, Inc.

Alexandra DeLucia, Aaron Mueller, Xiang Lisa Li, and João Sedoc. 2020. Decoding methods for neural narrative generation. CoRR, abs/2010.07375.

Bryan Eikema and Wilker Aziz. 2020. Is map decoding all you need? the inadequacy of the mode in neural machine translation. In COLING, pages 4506-4520.

Angela Fan, Mike Lewis, and Yann Dauphin. 2018. Hierarchical neural story generation. In Proceedings of the 56th Annual Meeting of the Association for Computational Linguistics (Volume 1: Long Papers), pages 889-898, Melbourne, Australia. Association for Computational Linguistics.

Tianyu Gao, Xingcheng Yao, and Danqi Chen. 2021. SimCSE: Simple contrastive learning of sentence embeddings. In Empirical Methods in Natural Language Processing (EMNLP).

H. Paul Grice. 1975. Logic and conversation. In Peter Cole and Jerry L. Morgan, editors, Speech Acts, volume 3 of Syntax and Semantics.

He He, Nanyun Peng, and Percy Liang. 2019. Pun generation with surprise. In Proceedings of the 2019 Conference of the North American Chapter of the Association for Computational Linguistics: Human Language Technologies, Volume 1 (Long and Short Papers), pages 1734-1744, Minneapolis, Minnesota. Association for Computational Linguistics.

Ari Holtzman, Jan Buys, Li Du, Maxwell Forbes, and Yejin Choi. 2020. The curious case of neural text degeneration. In International Conference on Learning Representations.

Laurence Horn. 1984. Toward a new taxonomy for pragmatic inference: Q-based and r-based implicature. Meaning, form, and use in context: Linguistic applications, 11:42.

Alex M Lamb, Anirudh Goyal ALIAS PARTH GOYAL, Ying Zhang, Saizheng Zhang, Aaron C Courville, and Yoshua Bengio. 2016. Professor forcing: A new algorithm for training recurrent networks. In $A d$ vances in Neural Information Processing Systems, volume 29. Curran Associates, Inc.

Stephen C Levinson. 2000. Presumptive Meanings: The Theory of Generalized Conversational Implicature. MIT Press.

Jiwei Li, Michel Galley, Chris Brockett, Jianfeng Gao, and Bill Dolan. 2016. A diversity-promoting objective function for neural conversation models. In Proceedings of the 2016 Conference of the North

American Chapter of the Association for Computational Linguistics: Human Language Technologies, pages 110-119, San Diego, California. Association for Computational Linguistics.

Xiang Lisa Li and Percy Liang. 2021. Prefix-tuning: Optimizing continuous prompts for generation. In Proceedings of the 59th Annual Meeting of the Association for Computational Linguistics and the 11th International Joint Conference on Natural Language Processing (Volume 1: Long Papers), pages 45824597, Online. Association for Computational Linguistics.

Alisa Liu, Maarten Sap, Ximing Lu, Swabha Swayamdipta, Chandra Bhagavatula, Noah A. Smith, and Yejin Choi. 2021. DExperts: Decoding-time controlled text generation with experts and anti-experts. In Proceedings of the 59th Annual Meeting of the Association for Computational Linguistics and the 11th International Joint Conference on Natural Language Processing (Volume 1: Long Papers), pages 6691-6706, Online. Association for Computational Linguistics.

Joshua Maynez, Shashi Narayan, Bernd Bohnet, and Ryan McDonald. 2020. On faithfulness and factuality in abstractive summarization. In Proceedings of the 58th Annual Meeting of the Association for Computational Linguistics, pages 1906-1919, Online. Association for Computational Linguistics.

Clara Meister, Tiago Pimentel, Gian Wiher, and Ryan Cotterell. 2022. Typical decoding for natural language generation. CoRR, abs/2202.00666.

Stephen Merity, Caiming Xiong, James Bradbury, and Richard Socher. 2017. Pointer sentinel mixture models. In International Conference on Learning Representations.

Romain Paulus, Caiming Xiong, and Richard Socher. 2018. A deep reinforced model for abstractive summarization. In International Conference on Learning Representations.

Krishna Pillutla, Swabha Swayamdipta, Rowan Zellers, John Thickstun, Sean Welleck, Yejin Choi, and Zaid Harchaoui. 2021. MAUVE: Measuring the gap between neural text and human text using divergence frontiers. In Advances in Neural Information Processing Systems.

Alec Radford, Jeff Wu, Rewon Child, David Luan, Dario Amodei, and Ilya Sutskever. 2019. Language models are unsupervised multitask learners. https://openai.com/blog/better-language-models/.

Marc'Aurelio Ranzato, Sumit Chopra, Michael Auli, and Wojciech Zaremba. 2016. Sequence level training with recurrent neural networks. In 4th International Conference on Learning Representations, ICLR 2016, San Juan, Puerto Rico, May 2-4, 2016, Conference Track Proceedings.
Yixuan Su and Nigel Collier. 2022. Contrastive search is what you need for neural text generation. arXiv preprint arXiv:2210.14140.

Yixuan Su, Tian Lan, Yan Wang, Dani Yogatama, Lingpeng Kong, and Nigel Collier. 2022. A contrastive framework for neural text generation. Neurips, $\mathrm{abs} / 2202.06417$.

Arun Venkatraman, Martial Hebert, and J.. Bagnell. 2015. Improving multi-step prediction of learned time series models. Proceedings of the AAAI Conference on Artificial Intelligence, 29(1).

Sean Welleck, Ilia Kulikov, Stephen Roller, Emily Dinan, Kyunghyun Cho, and Jason Weston. 2020. Neural text generation with unlikelihood training. In International Conference on Learning Representations.

Sam Wiseman and Alexander M. Rush. 2016. Sequenceto-sequence learning as beam-search optimization. In Proceedings of the 2016 Conference on Empirical Methods in Natural Language Processing, pages 1296-1306, Austin, Texas. Association for Computational Linguistics.

Yonghui Wu, Mike Schuster, Zhifeng Chen, Quoc V Le, Mohammad Norouzi, Wolfgang Macherey, Maxim Krikun, Yuan Cao, Qin Gao, Klaus Macherey, et al. 2016. Google's neural machine translation system: Bridging the gap between human and machine translation. arXiv preprint arXiv:1609.08144.

Yukun Zhu, Ryan Kiros, Richard Zemel, Ruslan Salakhutdinov, Raquel Urtasun, Antonio Torralba, and Sanja Fidler. 2015. Aligning books and movies: Towards story-like visual explanations by watching movies and reading books. In arXiv preprint arXiv:1506.06724.
